<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√©conciliation des Actes M√©dicaux ‚Äî Reconciliateur</title>

  <!-- Firebase modular SDK (browser) -->
  <script type="module">
    // Firebase imports (modulaire)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    // ----- CONFIG FIREBASE (remplace si besoin) -----
    // >>>> Si tu veux remplacer la cl√© pour raison de s√©curit√©, fais-le ici
    const firebaseConfig = {
      apiKey: "AIzaSyDcP7Cuvbkvmcr_mq7E_nHuxjSmDWK08-4",
      authDomain: "reconciliateur-50684.firebaseapp.com",
      projectId: "reconciliateur-50684",
      storageBucket: "reconciliateur-50684.firebasestorage.app",
      messagingSenderId: "1029928449677",
      appId: "1:1029928449677:web:7445402f84a963d3ab54c4",
      measurementId: "G-STE125RQPZ"
    };

    // Initialise Firebase
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){ /* analytics may fail on GH Pages */ }

    // Services
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // expose global firebase context for inline script usage
    window.firebaseCtx = { app, auth, db, storage };

    // Auth functions accessible from HTML UI
    window.signInWithGoogle = async function(){
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
        // onAuthStateChanged se chargera de l'UI
      } catch(err){
        console.error('Erreur connexion:', err);
        alert("Erreur connexion : " + err.message);
      }
    };

    window.signOutUser = async function(){
      try {
        await signOut(auth);
      } catch(err){ console.error(err); alert("Erreur d√©connexion"); }
    };

    // Listen user state changes to update UI
    onAuthStateChanged(auth, user => {
      const btnSign = document.getElementById('btn-signin');
      const userBox = document.getElementById('user-box');
      const uploadArea = document.getElementById('upload-area');
      if(user){
        userBox.innerHTML = `<strong>${user.displayName||user.email}</strong> ‚Äî <a href="#" onclick="signOutUser();return false;">D√©connexion</a>`;
        if(btnSign) btnSign.style.display='none';
        if(uploadArea) uploadArea.style.display='block';
        // start listening to saved reconciliations
        startReconciliationsListener();
        startManualEntriesListener();
      } else {
        userBox.innerHTML = 'Non connect√©';
        if(btnSign) btnSign.style.display='inline-block';
        if(uploadArea) uploadArea.style.display='none';
        stopReconciliationsListener();
        stopManualEntriesListener();
      }
    });

    // Expose helpers for other inline scripts
    window._firebase = { auth, db, storage };
  </script>

  <!-- Third-party libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* (style simplifi√©, reprend ton look) */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:24px;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.2)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:28px;text-align:center}
    .content{padding:22px}
    .row{display:flex;gap:12px;align-items:center}
    .btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#5b4bd8;color:#fff}
    .btn-ghost{background:transparent;border:2px dashed #667eea;color:#667eea;padding:12px}
    .files-list{margin-top:12px}
    .file-item{padding:8px;border:1px solid #eee;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .note{font-size:.95em;color:#444;margin-top:8px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .status-badge{padding:4px 8px;border-radius:12px;font-weight:600}
    #upload-area{display:none}
    .small{font-size:.9em;color:#666}
    .card{background:#fff;border-radius:8px;padding:12px;margin:12px 0;border:1px solid #f0f0f0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <div id="user-box" class="small">Non connect√©</div>
    </div>

    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <button id="btn-signin" class="btn btn-primary" onclick="signInWithGoogle()">Se connecter avec Google</button>
            <span class="small" style="margin-left:12px">‚Äî ou connecte-toi pour sauvegarder / charger</span>
          </div>
          <div class="small">H√©berg√© : GitHub Pages / Firebase Storage</div>
        </div>
      </div>

      <!-- UPLOAD + ANALYSE -->
      <div id="upload-area">
        <div class="card">
          <h3>üìÅ Chargement des fichiers</h3>
          <div style="margin-top:8px">
            <label class="btn-ghost" onclick="document.getElementById('actesFile').click()">üìä Ajouter fichier Excel (actes)</label>
            <input id="actesFile" type="file" accept=".xlsx,.xls" multiple style="display:none" />
          </div>
          <div style="margin-top:8px">
            <label class="btn-ghost" onclick="document.getElementById('honorairesFiles').click()">üí∞ Ajouter CSV (honoraires)</label>
            <input id="honorairesFiles" type="file" accept=".csv" multiple style="display:none" />
          </div>
          <div class="files-list" id="actesFilesList"></div>
          <div class="files-list" id="honorairesFilesList"></div>

          <div style="margin-top:12px" class="row">
            <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeFiles()" disabled>üîç Analyser et r√©concilier</button>
            <button class="btn" onclick="resetAll()">üîÑ R√©initialiser</button>
            <button class="btn" onclick="uploadFilesToStorage()">‚¨ÜÔ∏è Uploader les fichiers (Storage)</button>
          </div>
          <div class="note">Les fichiers seront √©galement sauvegard√©s dans <strong>users/{uid}/uploads</strong> si connect√©.</div>
        </div>

        <!-- Manual entry -->
        <div class="card">
          <h3>‚úçÔ∏è Saisie manuelle quotidienne</h3>
          <div class="row">
            <input id="manualDate" type="date" />
            <input id="manualCount" type="number" min="0" placeholder="Nombre d'actes" />
            <button class="btn btn-primary" id="btnAddManual">‚ûï Ajouter</button>
            <button class="btn" id="btnExportManual">üì• Exporter saisie</button>
          </div>
          <div id="manualTableWrap"></div>
        </div>
      </div>

      <!-- Results -->
      <div id="resultsArea" class="card">
        <h3>R√©sultats</h3>
        <div id="stats"></div>
        <div id="tables"></div>
      </div>

      <!-- Historique sauvegard√© -->
      <div class="card">
        <h3>üìú Historique des analyses sauvegard√©es</h3>
        <div id="historique-list" class="grid"></div>
      </div>
    </div>
  </div>

  <!-- MAIN LOGIC -->
  <script type="module">
    // imports already done in top module; use window.firebaseCtx
    const { auth, db, storage } = window.firebaseCtx;
    // local state
    let actesFiles = [], honorairesFiles = [], actesData = [], honorairesData = [], reconciledData = [];
    let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]');

    // UI refs
    const actesInput = document.getElementById('actesFile');
    const honorairesInput = document.getElementById('honorairesFiles');
    const actesList = document.getElementById('actesFilesList');
    const honorairesList = document.getElementById('honorairesFilesList');
    const analyzeBtn = document.getElementById('analyzeBtn');

    // file inputs
    actesInput.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files);
      for(const f of files) if(!actesFiles.find(x=>x.name===f.name && x.size===f.size)) actesFiles.push(f);
      updateFilesList();
      checkFilesReady();
      e.target.value='';
    });
    honorairesInput.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files);
      for(const f of files) if(!honorairesFiles.find(x=>x.name===f.name && x.size===f.size)) honorairesFiles.push(f);
      updateFilesList();
      checkFilesReady();
      e.target.value='';
    });

    function updateFilesList(){
      actesList.innerHTML = actesFiles.map((f,i)=>`<div class="file-item"><div>${f.name} <span class="small">(${Math.round(f.size/1024)} KB)</span></div><button onclick="removeLocalFile('actes',${i})">Suppr</button></div>`).join('') || '<div class="small">Aucun fichier actes</div>';
      honorairesList.innerHTML = honorairesFiles.map((f,i)=>`<div class="file-item"><div>${f.name} <span class="small">(${Math.round(f.size/1024)} KB)</span></div><button onclick="removeLocalFile('honoraires',${i})">Suppr</button></div>`).join('') || '<div class="small">Aucun fichier honoraires</div>';
    }
    window.removeLocalFile = function(type,i){
      if(type==='actes') actesFiles.splice(i,1); else honorairesFiles.splice(i,1);
      updateFilesList(); checkFilesReady();
    };
    function checkFilesReady(){ analyzeBtn.disabled = !(actesFiles.length>0 && honorairesFiles.length>0); }

    // --- parsing helpers (identiques √† ton pr√©c√©dent code) ---
    const normalizeString = (s="") => s.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^A-Za-z0-9\s'-]/g," ").replace(/\s+/g," ").trim().toUpperCase();
    const normalizeDossier = (d="") => d.toString().replace(/\D/g,"").replace(/^0+/,"");
    const parseFrenchNumber = (val)=>{ if(val===null||val===undefined) return 0; if(typeof val==='number') return val; const s=String(val).replace(/\s/g,""); const normalized = s.replace(/\./g,"").replace(/,/g,"."); const n=parseFloat(normalized); return isNaN(n)?0:n; };
    const toMoney = n => (Number(n)||0).toFixed(2)+"‚Ç¨";
    function excelDateToJSDate(serial){ if(!serial && serial!==0) return null; if(serial instanceof Date) return new Date(serial.getFullYear(),serial.getMonth(),serial.getDate()); if(typeof serial==='string'){ const s=serial.trim(); const m1=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m1) return new Date(Number(m1[1]),Number(m1[2])-1,Number(m1[3])); const m2=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m2) return new Date(Number(m2[3]),Number(m2[2])-1,Number(m2[1])); const d=new Date(s); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate()); } const utcDays=Math.floor(serial-25569); const utcValue=utcDays*86400; const dateInfo=new Date(utcValue*1000); return new Date(dateInfo.getFullYear(),dateInfo.getMonth(),dateInfo.getDate()); }
    function formatDate(date){ if(!date) return ""; const d=new Date(date); if(isNaN(d)) return ""; const day=String(d.getDate()).padStart(2,'0'); const month=String(d.getMonth()+1).padStart(2,'0'); const year=d.getFullYear(); return `${day}/${month}/${year}`; }

    // read files
    function readExcelFile(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const w = XLSX.read(data,{type:'array'});
            const sheet = w.Sheets[w.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet,{header:1});
            // find header row
            let headerRow = -1;
            for(let i=0;i<json.length;i++){
              if(json[i].some(cell => String(cell||"").toLowerCase().includes("num√©ro de dossier") || String(cell||"").toLowerCase().includes("numero de dossier"))) { headerRow = i; break; }
            }
            if(headerRow===-1){
              // fallback: try first row as header
              headerRow = 0;
            }
            const headers = json[headerRow];
            const rows = json.slice(headerRow+1);
            const arr = rows.map(row=>{
              const obj={};
              headers.forEach((h,idx)=>obj[h]=row[idx]);
              return obj;
            }).filter(r=>r && (r["Nom"] || r["Nom du patient"]));
            resolve(arr);
          }catch(err){ reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function readCSVFile(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{encoding:'ISO-8859-1',delimiter:';',skipEmptyLines:true,complete:(results)=>{
          try{
            if(results.data.length < 6) return reject(new Error("CSV trop court"));
            const dataRows = results.data.slice(6);
            const headers = ["Praticien","Dossier","Patient","Libell√©","Transfert","Date Acte","Serv.","Coeff.","Pertes","Mt Hors D√©pass.","D√©pass.","Total","Vide"];
            const cleaned = dataRows.map(row=>{
              if(!row || row.length < 6) return null;
              const obj={};
              headers.forEach((h,i)=>obj[h] = (row[i] ? String(row[i]).replace(/"/g,"").trim() : ""));
              obj["Date Acte"] = normalizeDateString(obj["Date Acte"]);
              obj["Total"] = parseFrenchNumber(obj["Total"]);
              obj["Dossier"] = normalizeDossier(obj["Dossier"]);
              obj["Patient_norm"] = normalizeString(obj["Patient"]);
              return obj;
            }).filter(r=>r && r["Dossier"] && r["Date Acte"]);
            resolve(cleaned);
          }catch(err){ reject(err); }
        }, error:reject});
      });
    }
    function normalizeDateString(s){
      if(!s) return "";
      const str = String(s).trim();
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return str;
      const m1 = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m1) return `${m1[3]}/${m1[2]}/${m1[1]}`;
      const d = new Date(str);
      return isNaN(d) ? str : formatDate(d);
    }

    // reconcile as before
    function reconcileData(){
      const honIndex = new Map();
      for(const hon of honorairesData){
        const key = `${hon["Dossier"]}|${hon["Patient_norm"]}|${hon["Date Acte"]}`;
        if(!honIndex.has(key)) honIndex.set(key, hon);
      }
      reconciledData = actesData.map(acte=>{
        const dossier = normalizeDossier(acte["Num√©ro de dossier"] || acte["Num√©ro de Dossier"] || acte["dossier"] || "");
        const nom = normalizeString(acte["Nom"] || acte["Nom du patient"] || acte["Nom Patient"] || "");
        const prenom = normalizeString(acte["Pr√©nom"] || acte["Prenom"] || "");
        const nomComplet = (nom + " " + prenom).trim();
        const patientNorm = normalizeString(nomComplet);
        const dActe = excelDateToJSDate(acte["Date de d√©but"] || acte["Date"] || acte["Date_debut"]);
        const dateFormatted = formatDate(dActe);
        const prestation = acte["Prestation"] || acte["Acte"] || acte["Libell√©"] || "";
        const montant = parseFrenchNumber(acte["Prix_Unitaire_Coefficient_Quantit√©"] || acte["Montant"] || acte["Tarif"] || 0);
        const key = `${dossier}|${patientNorm}|${dateFormatted}`;
        const match = honIndex.get(key);
        return {
          ...acte,
          _DOSSIER_NORM: dossier,
          Nom_Complet: nomComplet,
          Patient_norm: patientNorm,
          Date_Formatee: dateFormatted,
          Prestation: prestation,
          Montant_num: Number(montant)||0,
          Factur√©: match ? "Oui" : "Non",
          D√©tails_Facture: match ? (match["Libell√©"] || "N/A") : ""
        };
      });
    }

    // display results
    function displayResults(){
      const totalActes = reconciledData.length;
      const actesFactures = reconciledData.filter(a=>a.Factur√©==='Oui').length;
      const actesNonFactures = totalActes - actesFactures;
      const montantNonFacture = reconciledData.filter(a=>a.Factur√©==='Non').reduce((s,a)=>s+(a.Montant_num||0),0);
      document.getElementById('stats').innerHTML = `<div class="small">Total actes: <strong>${totalActes}</strong> ‚Äî Factur√©s: <strong>${actesFactures}</strong> ‚Äî Non factur√©s: <strong>${actesNonFactures}</strong> ‚Äî Montant non factur√©: <strong>${toMoney(montantNonFacture)}</strong></div>`;
      // table simple
      const rows = reconciledData.slice(0,200).map(r=>`<tr><td>${r.Date_Formatee||''}</td><td>${r.Nom_Complet||''}</td><td>${r._DOSSIER_NORM||''}</td><td>${r.Prestation||''}</td><td>${(r.Montant_num||0).toFixed(2)}</td><td>${r.Factur√©}</td></tr>`).join('');
      document.getElementById('tables').innerHTML = `<table><thead><tr><th>Date</th><th>Patient</th><th>Dossier</th><th>Prestation</th><th>‚Ç¨</th><th>Statut</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    // ----------------- MAIN analyzeFiles -----------------
    async function analyzeFiles(){
      try{
        document.getElementById('analyzeBtn').disabled = true;
        actesData = []; honorairesData = [];
        for(const f of actesFiles){
          const arr = await readExcelFile(f);
          actesData = actesData.concat(arr);
        }
        for(const f of honorairesFiles){
          const arr = await readCSVFile(f);
          honorairesData = honorairesData.concat(arr);
        }
        reconcileData();
        displayResults();
        // save monthly summary to Firestore (si connect√©)
        if(auth.currentUser){
          await saveReconciliationToFirestore();
        } else {
          console.log('Utilisateur non connect√©, sauvegarde Firestore ignor√©e');
        }
      }catch(err){
        console.error(err);
        alert('Erreur: ' + err.message);
      } finally {
        checkFilesReady();
      }
    }
    window.analyzeFiles = analyzeFiles;

    // ----------------- SAVE reconciliation to Firestore -----------------
    async function saveReconciliationToFirestore(){
      // aggregate monthly
      const monthly = {};
      for(const a of reconciledData){
        const date = a.Date_Formatee; if(!date) continue;
        const [jj,mm,yyyy] = date.split('/');
        if(!jj) continue;
        const key = `${yyyy}-${mm}`;
        if(!monthly[key]) monthly[key] = { month:key, total:0, factures:0, nonFactures:0, montantTotal:0, montantFacture:0, montantNonFacture:0 };
        const m = a.Montant_num || 0;
        monthly[key].total++;
        monthly[key].montantTotal += m;
        if(a.Factur√© === 'Oui'){ monthly[key].factures++; monthly[key].montantFacture += m; } else { monthly[key].nonFactures++; monthly[key].montantNonFacture += m; }
      }
      const user = auth.currentUser;
      if(!user) throw new Error('Non connect√©');
      for(const [k,data] of Object.entries(monthly)){
        const d = { ...data, updatedAt: Date.now() };
        await setDoc(doc(db, "users", user.uid, "reconciliations", k), d);
      }
      console.log('Sauvegarde Firestore OK');
    }

    // ----------------- Upload files to Firebase Storage + record metadata in Firestore -----------------
    async function uploadFilesToStorage(){
      const user = auth.currentUser;
      if(!user) return alert('Connecte-toi pour uploader');
      const uploads = [];
      for(const f of [...actesFiles, ...honorairesFiles]){
        const type = actesFiles.includes(f) ? 'actes' : 'honoraires';
        const path = `users/${user.uid}/uploads/${Date.now()}_${f.name.replace(/\s/g,'_')}`;
        const ref = storageRef(storage, path);
        const task = uploadBytesResumable(ref, f);
        uploads.push(new Promise((resolve, reject)=>{
          task.on('state_changed', null, err=>reject(err), async ()=>{
            const url = await getDownloadURL(ref);
            // create document metadata
            await setDoc(doc(db, "users", user.uid, "uploads", encodeURIComponent(path)), {
              filename: f.name,
              type,
              path,
              url,
              uploadedAt: Date.now(),
              processed: false
            });
            resolve({ path, url });
          });
        }));
      }
      try {
        const res = await Promise.all(uploads);
        alert('Uploads termin√©s: ' + res.length);
      } catch(err){
        console.error(err); alert('Erreur upload: ' + err.message);
      }
    }

    // ----------------- Manual entries handling (localStorage + Firestore mirror) -----------------
    const manualDateInput = document.getElementById('manualDate');
    const manualCountInput = document.getElementById('manualCount');
    document.getElementById('btnAddManual').addEventListener('click', async ()=>{
      const d = manualDateInput.value;
      const c = Number(manualCountInput.value||0);
      if(!d) return alert('Choisis une date');
      if(c < 0) return alert('>= 0');
      const idx = manualEntries.findIndex(x=>x.date===d);
      if(idx>-1) manualEntries[idx].count = c; else manualEntries.push({ date:d, count:c, updatedAt:Date.now() });
      localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
      renderManualTable();
      // mirror to Firestore
      if(auth.currentUser){
        await setDoc(doc(db, "users", auth.currentUser.uid, "manual_entries", d), { date:d, count:c, updatedAt:Date.now() });
      }
    });

    document.getElementById('btnExportManual').addEventListener('click', ()=>{
      if(!manualEntries.length) return alert('Aucune saisie');
      const rows = [["date","count"], ...manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(x=>[x.date,x.count])];
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Saisie');
      XLSX.writeFile(wb, 'saisie_manuelle.xlsx');
    });

    function renderManualTable(){
      const wrap = document.getElementById('manualTableWrap');
      if(!manualEntries.length){ wrap.innerHTML = '<div class="small">Aucune saisie</div>'; return; }
      const rows = manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(e=>`<div class="file-item"><div>${e.date} ‚Äî ${e.count}</div><div><button onclick="deleteManual('${e.date}')">Suppr</button></div></div>`).join('');
      wrap.innerHTML = rows;
    }
    window.deleteManual = async function(date){ manualEntries = manualEntries.filter(x=>x.date!==date); localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries)); renderManualTable(); if(auth.currentUser) await setDoc(doc(db, "users", auth.currentUser.uid, "manual_entries", date), { date, count:0, updatedAt:Date.now() }); };

    renderManualTable();

    // ----------------- Firestore listeners for historique & manual entries -----------------
    let reconcUnsub = null, manualUnsub = null;
    function startReconciliationsListener(){
      const user = auth.currentUser;
      if(!user) return;
      const q = query(collection(db, "users", user.uid, "reconciliations"), orderBy("month","desc"));
      reconcUnsub = onSnapshot(q, snap => {
        const list = snap.docs.map(d=>d.data());
        displayHistorique(list);
      });
    }
    function stopReconciliationsListener(){ if(reconcUnsub){ reconcUnsub(); reconcUnsub=null; } }
    function startManualEntriesListener(){
      const user = auth.currentUser;
      if(!user) return;
      const q = query(collection(db, "users", user.uid, "manual_entries"), orderBy("date","desc"));
      manualUnsub = onSnapshot(q, snap => {
        const arr = snap.docs.map(d=>d.data());
        // merge remote manual entries into localStorage (non destructive)
        arr.forEach(r=>{
          const i = manualEntries.findIndex(x=>x.date===r.date);
          if(i>-1) manualEntries[i] = {...manualEntries[i], ...r};
          else manualEntries.push(r);
        });
        localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
        renderManualTable();
      });
    }
    function stopManualEntriesListener(){ if(manualUnsub){ manualUnsub(); manualUnsub=null; } }

    function displayHistorique(reconciliations){
      const container = document.getElementById('historique-list');
      if(!reconciliations.length){ container.innerHTML = '<div class="small">Aucune analyse sauvegard√©e</div>'; return; }
      container.innerHTML = reconciliations.map(rec=>{
        const taux = rec.total ? (rec.factures / rec.total * 100).toFixed(1) : 0;
        const date = rec.updatedAt ? new Date(rec.updatedAt).toLocaleString() : '';
        return `<div class="card"><strong>${rec.month}</strong><div class="small">T:${rec.total} ‚Äî Fact:${rec.factures} ‚Äî Taux:${taux}%</div><div class="small">Mise √† jour: ${date}</div></div>`;
      }).join('');
    }

    // ----------------- reset helper -----------------
    function resetAll(){ actesFiles=[]; honorairesFiles=[]; actesData=[]; honorairesData=[]; reconciledData=[]; updateFilesList(); displayResults(); }

    // ----------------- storage helper for external file upload (already above) -----------------

    // expose needed functions globally
    window.uploadFilesToStorage = uploadFilesToStorage;
    window.resetAll = resetAll;
    window.saveReconciliationToFirestore = saveReconciliationToFirestore;
    window.startReconciliationsListener = startReconciliationsListener;
    window.stopReconciliationsListener = stopReconciliationsListener;
    window.startManualEntriesListener = startManualEntriesListener;
    window.stopManualEntriesListener = stopManualEntriesListener;
  </script>
</body>
</html>
