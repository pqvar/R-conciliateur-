<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√©conciliation des Actes M√©dicaux - Dr Pablo NEEL</title>
  <!-- Libs parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;min-height:100vh}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2em;margin-bottom:10px}
    .header p{opacity:.9}
    .content{padding:30px}
    .upload-section{background:#f8f9fa;border-radius:10px;padding:25px;margin-bottom:30px}
    .upload-section h2{color:#667eea;margin-bottom:20px;font-size:1.5em}
    .file-input-group{margin-bottom:20px}
    .file-input-button{display:block;padding:12px 20px;background:#fff;border:2px dashed #667eea;border-radius:8px;color:#667eea;font-weight:600;cursor:pointer;transition:.3s;text-align:center}
    .file-input-button:hover{background:#667eea;color:#fff}
    .files-list{margin-top:15px}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:#e8eaf6;border-radius:5px;margin-bottom:8px}
    .file-name{font-weight:600;color:#5e35b1}
    .file-size{font-size:.85em;color:#666}
    .remove-file-btn{padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:.9em}
    .action-buttons{display:flex;gap:15px;margin-top:25px}
    .btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#6c757d;color:#fff}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:10px;text-align:center}
    .stat-card.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
    .stat-card.warning{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .stat-value{font-size:2.2em;font-weight:700}
    .results-section{margin-top:30px;display:none}
    .results-section.show{display:block}
    .tab-buttons{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e0e0e0;flex-wrap:wrap}
    .tab-btn{padding:12px 18px;background:transparent;border:none;border-bottom:3px solid transparent;font-weight:600;color:#666;cursor:pointer}
    .tab-btn.active{color:#667eea;border-bottom-color:#667eea}
    .table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:12px;text-align:left;font-weight:600;position:sticky;top:0}
    td{padding:10px 12px;border-bottom:1px solid #e0e0e0}
    .status-badge{padding:5px 12px;border-radius:20px;font-size:.85em;font-weight:600}
    .status-factured{background:#d4edda;color:#155724}
    .status-not-factured{background:#f8d7da;color:#721c24}
    .export-btn{margin-top:20px;padding:12px 20px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer}
    .monthly-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
    .month-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);border-left:5px solid #667eea}
    .month-card h3{color:#667eea;margin-bottom:10px}
    .loading{display:none;text-align:center;padding:20px}
    .loading.show{display:block}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .note{font-size:.9em;color:#555;margin-top:8px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:18px;margin:20px 0}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .input{width:100%;padding:10px 12px;border:1px solid #cfd2d9;border-radius:8px}
    .label{font-weight:600;color:#333;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <p>Suivi des actes factur√©s et non factur√©s ‚Äî import fichiers + saisie manuelle</p>
      <p id="login-badge" style="margin-top:8px;font-size:.95em;opacity:.9">Non connect√©</p>
      <div style="margin-top:10px;display:flex;gap:10px;justify-content:center">
        <button id="btnLogin" class="btn btn-primary">üîê Se connecter (Google)</button>
        <button id="btnLogout" class="btn btn-secondary" style="display:none">üö™ Se d√©connecter</button>
      </div>
    </div>

    <div class="content">
      <div class="upload-section">
        <h2>üìÅ Chargement des fichiers</h2>
        <p class="note">Ajoutez plusieurs fichiers, puis lancez l‚Äôanalyse.</p>

        <div class="file-input-group">
          <button class="file-input-button" onclick="document.getElementById('actesFile').click()">üìä Ajouter fichier Excel des actes</button>
          <input type="file" id="actesFile" accept=".xlsx,.xls" multiple style="display:none"/>
          <div id="actesFilesList" class="files-list"></div>
        </div>

        <div class="file-input-group">
          <button class="file-input-button" onclick="document.getElementById('honorairesFiles').click()">üí∞ Ajouter fichier CSV des honoraires</button>
          <input type="file" id="honorairesFiles" accept=".csv" multiple style="display:none"/>
          <div id="honorairesFilesList" class="files-list"></div>
          <p class="note">CSV attendu : s√©parateur ¬´ ; ¬ª, encodage ISO-8859-1, la 6·µâ ligne contient les en-t√™tes.</p>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="analyzeBtn" disabled>üîç Analyser et r√©concilier</button>
          <button class="btn btn-secondary" id="resetBtn">üîÑ R√©initialiser</button>
        </div>
      </div>

      <div class="card">
        <h2>‚úçÔ∏è Saisie manuelle quotidienne (comparatif)</h2>
        <p class="note">Renseigne le nombre d'actes par jour pour comparer avec les imports.</p>
        <div class="grid" style="margin-top:10px">
          <div><div class="label">Date</div><input type="date" id="manualDate" class="input"/></div>
          <div><div class="label">Nombre d'actes</div><input type="number" id="manualCount" class="input" min="0" step="1" placeholder="0"/></div>
          <div style="align-self:end"><button class="btn btn-primary" id="btnAddManual">‚ûï Ajouter</button></div>
        </div>
        <div class="table-wrapper" style="margin-top:15px"><table id="manual-table"></table></div>
        <div class="action-buttons"><button class="btn btn-secondary" id="btnExportManual">üì• Exporter la saisie (CSV)</button></div>
      </div>

      <div class="loading" id="loading"><div class="spinner"></div><p>Analyse en cours‚Ä¶</p></div>

      <div class="results-section" id="results">
        <div class="stats" id="stats"></div>

        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="recap">üìä R√©capitulatif Mensuel</button>
          <button class="tab-btn" data-tab="comparaison">üìà Comparaison quotidienne</button>
          <button class="tab-btn" data-tab="non-factures">‚ùå Actes non factur√©s</button>
          <button class="tab-btn" data-tab="factures">‚úÖ Actes factur√©s</button>
          <button class="tab-btn" data-tab="tous">üìã Tous les actes</button>
        </div>

        <div class="tab-content active" id="tab-recap">
          <div id="monthly-summary"></div>
          <div class="table-wrapper" style="margin-top:30px"><table id="table-monthly"></table></div>
          <button class="export-btn" onclick="exportMonthlyReport()">üì• Exporter le r√©capitulatif mensuel (Excel)</button>
        </div>

        <div class="tab-content" id="tab-comparaison">
          <div class="table-wrapper"><table id="table-comparaison"></table></div>
          <button class="export-btn" onclick="exportComparaison()">üì• Exporter la comparaison quotidienne (Excel)</button>
        </div>

        <div class="tab-content" id="tab-non-factures">
          <div class="table-wrapper"><table id="table-non-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('non-factures')">üì• Exporter les actes non factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-factures">
          <div class="table-wrapper"><table id="table-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('factures')">üì• Exporter les actes factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-tous">
          <div class="table-wrapper"><table id="table-tous"></table></div>
          <button class="export-btn" onclick="exportToExcel('tous')">üì• Exporter tous les actes (Excel)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (app + auth + db + storage) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      getRedirectResult, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcP7Cuvbkvmcr_mq7E_nHuxjSmDWK08-4",
      authDomain: "reconciliateur-50684.firebaseapp.com",
      projectId: "reconciliateur-50684",
      storageBucket: "reconciliateur-50684.firebasestorage.app",
      messagingSenderId: "1029928449677",
      appId: "1:1029928449677:web:7445402f84a963d3ab54c4",
      measurementId: "G-STE125RQPZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    try{ await setPersistence(auth, browserLocalPersistence); }catch{}

    const provider = new GoogleAuthProvider();
    const badge = document.getElementById('login-badge');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    async function doLogin(){
      try{ await signInWithPopup(auth, provider); }
      catch(e){
        try{ await signInWithRedirect(auth, provider); }
        catch(e2){ alert("Connexion impossible : " + (e2?.message || e?.message)); }
      }
    }
    btnLogin.onclick  = ()=>doLogin();
    btnLogout.onclick = ()=>signOut(auth);

    getRedirectResult(auth).catch(()=>{});

    let stopManual = null;
    onAuthStateChanged(auth, (user)=>{
      if(user){
        badge.textContent = `Connect√© : ${user.displayName || user.email}`;
        btnLogin.style.display='none'; btnLogout.style.display='inline-flex';
        if (stopManual) stopManual();
        // synchro Firestore -> localStorage pour la saisie manuelle
        stopManual = listenManualEntries((rows)=>{
          window.manualEntries = rows || [];
          localStorage.setItem('manualEntries_v1', JSON.stringify(rows||[]));
          if (typeof renderManualTable==='function') renderManualTable();
          if (typeof displayMonthlySummary==='function') displayMonthlySummary();
          if (typeof displayComparaison==='function') displayComparaison();
        });
      }else{
        badge.textContent='Non connect√©';
        btnLogin.style.display='inline-flex'; btnLogout.style.display='none';
        if (stopManual){ stopManual(); stopManual=null; }
        window.manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]');
        if (typeof renderManualTable==='function') renderManualTable();
        if (typeof displayMonthlySummary==='function') displayMonthlySummary();
        if (typeof displayComparaison==='function') displayComparaison();
      }
    });

    function listenManualEntries(cb){
      const u = auth.currentUser; if(!u) return ()=>{};
      const qy = query(collection(db, "users", u.uid, "manual_entries"), orderBy("date"));
      return onSnapshot(qy, s => cb(s.docs.map(d=>d.data())));
    }

    // Helpers expos√©s (utilis√©s par la logique d'app plus bas si connect√©)
    window.cloud = {
      upsertManual: async (date, count)=>{
        const u = auth.currentUser; if(!u) throw new Error("Non connect√©");
        await setDoc(doc(db,"users",u.uid,"manual_entries",date), {date, count:Number(count)||0, updatedAt:Date.now()});
      },
      deleteManual: async (date)=>{
        const u = auth.currentUser; if(!u) throw new Error("Non connect√©");
        await deleteDoc(doc(db,"users",u.uid,"manual_entries",date));
      },
      upload: async (kind, file)=>{
        const u = auth.currentUser; if(!u) throw new Error("Non connect√©");
        const stamp = new Date().toISOString().replace(/[:.]/g,'-');
        const path = `users/${u.uid}/${kind}/${stamp}_${file.name}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        await setDoc(doc(db,"users",u.uid,"uploads",path), {kind, filename:file.name, path, url, uploadedAt:Date.now()});
        return {path,url};
      }
    };
  </script>

  <!-- Logique applicative: import fichiers, analyse, affichage, saisie manuelle -->
  <script>
    let actesFiles = [];
    let honorairesFiles = [];
    let actesData = [];
    let honorairesData = [];
    let reconciledData = [];
    let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]');

    const normalizeString = (s="") => s.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^A-Za-z0-9\s'-]/g," ").replace(/\s+/g," ").trim().toUpperCase();
    const normalizeDossier = (d="") => d.toString().replace(/\D/g,"").replace(/^0+/,"");
    const parseFrenchNumber = (val)=>{ if(val==null) return 0; if(typeof val==="number") return val; const s=String(val).replace(/\s/g,""); const n=parseFloat(s.replace(/\./g,"").replace(/,/g,".")); return isNaN(n)?0:n; };
    const toMoney = (n)=>(Number(n)||0).toFixed(2)+"‚Ç¨";

    function excelDateToJSDate(serial){
      if (!serial && serial!==0) return null;
      if (serial instanceof Date) return new Date(serial.getFullYear(),serial.getMonth(),serial.getDate());
      if (typeof serial==="string"){
        const s=serial.trim();
        const m1=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m1) return new Date(+m1[1],+m1[2]-1,+m1[3]);
        const m2=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m2) return new Date(+m2[3],+m2[2]-1,+m2[1]);
        const d=new Date(s); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
      }
      const utcDays = Math.floor(serial - 25569);
      const utcValue = utcDays * 86400;
      const dateInfo = new Date(utcValue * 1000);
      return new Date(dateInfo.getFullYear(), dateInfo.getMonth(), dateInfo.getDate());
    }
    function formatDate(date){
      if(!date) return "";
      const d=new Date(date); if(isNaN(d)) return "";
      const day=String(d.getDate()).padStart(2,"0");
      const month=String(d.getMonth()+1).padStart(2,"0");
      const year=d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // UI: fichiers
    document.getElementById("actesFile").addEventListener("change",(e)=>{
      const newFiles = Array.from(e.target.files);
      newFiles.forEach(file=>{ if(!actesFiles.find(f=>f.name===file.name && f.size===file.size)) actesFiles.push(file); });
      updateFilesList("actes"); checkFilesReady(); e.target.value="";
    });
    document.getElementById("honorairesFiles").addEventListener("change",(e)=>{
      const newFiles = Array.from(e.target.files);
      newFiles.forEach(file=>{ if(!honorairesFiles.find(f=>f.name===file.name && f.size===file.size)) honorairesFiles.push(file); });
      updateFilesList("honoraires"); checkFilesReady(); e.target.value="";
    });

    function updateFilesList(type){
      const files = (type==="actes")?actesFiles:honorairesFiles;
      const list = document.getElementById(type==="actes"?"actesFilesList":"honorairesFilesList");
      list.innerHTML = files.map((file,idx)=>`
        <div class="file-item">
          <div class="file-info">
            <div>${type==="actes"?"üìä":"üí∞"}</div>
            <div>
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
          <button class="remove-file-btn" onclick="removeFile('${type}',${idx})">‚úï Supprimer</button>
        </div>`).join("");
    }
    function removeFile(type, index){
      if(type==="actes") actesFiles.splice(index,1);
      else honorairesFiles.splice(index,1);
      updateFilesList(type); checkFilesReady();
    }
    function formatFileSize(bytes){
      if(bytes===0) return "0 Bytes";
      const k=1024, sizes=["Bytes","KB","MB","GB"], i=Math.floor(Math.log(bytes)/Math.log(k));
      return Math.round((bytes/Math.pow(k,i))*100)/100+" "+sizes[i];
    }
    function checkFilesReady(){
      document.getElementById("analyzeBtn").disabled = !(actesFiles.length>0 && honorairesFiles.length>0);
    }

    // Onglets
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click",function(){
        const tab=this.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
        this.classList.add("active");
        document.getElementById(`tab-${tab}`).classList.add("active");
      });
    });

    // Actions
    document.getElementById("analyzeBtn").addEventListener("click", analyzeFiles);
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      actesFiles=[]; honorairesFiles=[]; actesData=[]; honorairesData=[]; reconciledData=[];
      updateFilesList("actes"); updateFilesList("honoraires"); checkFilesReady();
      document.getElementById("results").classList.remove("show");
    });

    async function analyzeFiles(){
      document.getElementById("loading").classList.add("show");
      document.getElementById("results").classList.remove("show");
      try{
        actesData=[];
        for(const f of actesFiles){ actesData = actesData.concat(await readExcelFile(f)); }
        honorairesData=[];
        for(const f of honorairesFiles){ honorairesData = honorairesData.concat(await readCSVFile(f)); }
        reconcileData();
        displayResults();
        document.getElementById("loading").classList.remove("show");
        document.getElementById("results").classList.add("show");
      }catch(e){
        console.error(e);
        alert("Erreur lors de l'analyse : "+e.message);
        document.getElementById("loading").classList.remove("show");
      }
    }

    function readExcelFile(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=(e)=>{
          try{
            const data=new Uint8Array(e.target.result);
            const wb=XLSX.read(data,{type:"array"});
            const sh=wb.Sheets[wb.SheetNames[0]];
            const rows=XLSX.utils.sheet_to_json(sh,{header:1});
            let headerRow=-1;
            for(let i=0;i<rows.length;i++){
              if(rows[i].some((cell)=>String(cell||"").toLowerCase().includes("num√©ro de dossier"))){ headerRow=i; break; }
            }
            if(headerRow===-1) return reject(new Error("En-t√™te non trouv√© dans l'Excel"));
            const headers=rows[headerRow];
            const dataRows=rows.slice(headerRow+1);
            const arr=dataRows.map(r=>{
              const o={}; headers.forEach((h,idx)=>{ o[h]=r[idx]; });
              return o;
            }).filter(r=>r["Nom"] && r["Num√©ro de dossier"]);
            resolve(arr);
          }catch(err){ reject(err); }
        };
        reader.onerror=reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function readCSVFile(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{
          encoding:"ISO-8859-1",
          delimiter:";",
          skipEmptyLines:true,
          complete:(res)=>{
            try{
              if(res.data.length<7) return reject(new Error("CSV trop court"));
              const headers=["Praticien","Dossier","Patient","Libell√©","Transfert","Date Acte","Serv.","Coeff.","Pertes","Mt Hors D√©pass.","D√©pass.","Total","Vide"];
              const rows=res.data.slice(6);
              const clean=rows.map(row=>{
                if(!row||row.length<6) return null;
                const o={}; headers.forEach((h,i)=>{ o[h]=(row[i]?row[i].replace(/"/g,"").trim():""); });
                o["Date Acte"]=normalizeDateString(o["Date Acte"]);
                o["Total"]=parseFrenchNumber(o["Total"]);
                o["Dossier"]=normalizeDossier(o["Dossier"]);
                o["Patient_norm"]=normalizeString(o["Patient"]);
                return o;
              }).filter(r=>r && r["Dossier"] && r["Date Acte"]);
              resolve(clean);
            }catch(err){ reject(err); }
          },
          error:reject
        });
      });
    }
    function normalizeDateString(s){
      if(!s) return "";
      const str=String(s).trim();
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return str;
      const m1=str.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m1) return `${m1[3]}/${m1[2]}/${m1[1]}`;
      const d=new Date(str); return isNaN(d)?str:formatDate(d);
    }

    function reconcileData(){
      const honIndex=new Map();
      for(const hon of honorairesData){
        const key=`${hon["Dossier"]}|${hon["Patient_norm"]}|${hon["Date Acte"]}`;
        if(!honIndex.has(key)) honIndex.set(key, hon);
      }
      reconciledData = actesData.map(acte=>{
        const dossier = normalizeDossier(acte["Num√©ro de dossier"] || acte["Num√©ro de Dossier"] || "");
        const nom = normalizeString(acte["Nom"] || "");
        const prenom = normalizeString(acte["Pr√©nom"] || acte["Prenom"] || "");
        const nomComplet=(nom+" "+prenom).trim();
        const patientNorm=normalizeString(nomComplet);
        const dActe = excelDateToJSDate(acte["Date de d√©but"] || acte["Date"]);
        const dateFormatted = formatDate(dActe);
        const prestation = acte["Prestation"] || acte["Acte"] || "";
        const montant = parseFrenchNumber(acte["Prix_Unitaire_Coefficient_Quantit√©"] || acte["Montant"] || acte["Tarif"]);

        const key=`${dossier}|${patientNorm}|${dateFormatted}`;
        const match=honIndex.get(key);

        return {
          ...acte,
          _DOSSIER_NORM: dossier,
          Nom_Complet: nomComplet,
          Patient_norm: patientNorm,
          Date_Formatee: dateFormatted,
          Prestation: prestation,
          Montant_num: Number(montant)||0,
          Factur√©: match ? "Oui" : "Non",
          D√©tails_Facture: match ? (match["Libell√©"] || "N/A") : ""
        };
      });
    }

    function displayResults(){
      const total = reconciledData.length;
      const factures = reconciledData.filter(a=>a["Factur√©"]==="Oui").length;
      const nonFactures = total - factures;
      const montantNonFacture = reconciledData.filter(a=>a["Factur√©"]==="Non").reduce((s,a)=>s+(a.Montant_num||0),0);

      document.getElementById("stats").innerHTML = `
        <div class="stat-card"><div class="stat-value">${total}</div><div>Total actes</div></div>
        <div class="stat-card success"><div class="stat-value">${factures}</div><div>Actes factur√©s</div></div>
        <div class="stat-card warning"><div class="stat-value">${nonFactures}</div><div>Actes non factur√©s</div></div>
        <div class="stat-card warning"><div class="stat-value">${toMoney(montantNonFacture)}</div><div>Montant non factur√©</div></div>
      `;

      displayTable("non-factures", reconciledData.filter(a=>a["Factur√©"]==="Non"));
      displayTable("factures", reconciledData.filter(a=>a["Factur√©"]==="Oui"));
      displayTable("tous", reconciledData);
      displayMonthlySummary();
      displayComparaison();
    }

    function displayTable(type, data){
      const table = document.getElementById(`table-${type}`);
      if(!data.length){
        table.innerHTML='<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e √† afficher</p>'; return;
      }
      let html = '<thead><tr><th>Date</th><th>Nom Patient</th><th>N¬∞ Dossier</th><th>Prestation</th><th>Montant</th><th>Statut</th><th>D√©tails</th></tr></thead><tbody>';
      for(const r of data){
        const cls = r["Factur√©"]==="Oui"?"status-factured":"status-not-factured";
        const txt = r["Factur√©"]==="Oui"?"‚úì Factur√©":"‚úó Non factur√©";
        html += `<tr>
          <td>${r["Date_Formatee"]||""}</td>
          <td>${r["Nom_Complet"]||""}</td>
          <td>${r["_DOSSIER_NORM"]||""}</td>
          <td>${r["Prestation"]||""}</td>
          <td>${toMoney(r["Montant_num"])}</td>
          <td><span class="status-badge ${cls}">${txt}</span></td>
          <td>${r["D√©tails_Facture"]||""}</td>
        </tr>`;
      }
      html+='</tbody>'; table.innerHTML=html;
    }

    function getMonthName(m,y){
      const months=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
      return `${months[m-1]} ${y}`;
    }

    function displayMonthlySummary(){
      const monthly={};
      for(const a of reconciledData){
        const d=a["Date_Formatee"]; if(!d) continue;
        const [jj,mm,yyyy]=d.split('/');
        const key=`${mm}/${yyyy}`, name=getMonthName(+mm,+yyyy);
        if(!monthly[key]) monthly[key]={name,total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0};
        const m=a.Montant_num||0;
        monthly[key].total++; monthly[key].montantTotal+=m;
        if(a["Factur√©"]==="Oui"){ monthly[key].factures++; monthly[key].montantFacture+=m; }
        else { monthly[key].nonFactures++; monthly[key].montantNonFacture+=m; }
      }
      const manualAgg={};
      for(const e of manualEntries){
        const d=new Date(e.date); if(isNaN(d)) continue;
        const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear();
        const key=`${mm}/${yy}`; manualAgg[key]=(manualAgg[key]||0)+Number(e.count||0);
      }
      const sorted=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number); const [mb,yb]=b.split('/').map(Number); return ya!==yb?ya-yb:ma-mb;});
      let summary='<div class="monthly-summary-grid">';
      for(const k of sorted){
        const d=monthly[k];
        const taux=d.total? (d.factures/d.total*100).toFixed(1):0;
        const manu=manualAgg[k]||0; const ecart=manu-d.total;
        summary += `<div class="month-card"><h3>üìÖ ${d.name}</h3>
          <div><strong>Total (fichiers) :</strong> ${d.total}</div>
          <div><strong>Factur√©s :</strong> ${d.factures} (${taux}%)</div>
          <div><strong>Non factur√©s :</strong> ${d.nonFactures}</div>
          <div><strong>Saisie manuelle :</strong> ${manu}</div>
          <div><strong>√âcart (manuel ‚àí fichiers) :</strong> <span style="color:${ecart===0?'#333':(ecart>0?'#28a745':'#e74c3c')}">${ecart}</span></div>
          <div style="margin-top:6px"><strong>Montant total :</strong> ${toMoney(d.montantTotal)}</div>
          <div><strong>Montant factur√© :</strong> ${toMoney(d.montantFacture)}</div>
          <div><strong>Montant non factur√© :</strong> ${toMoney(d.montantNonFacture)}</div>
        </div>`;
      }
      summary+='</div>';
      document.getElementById("monthly-summary").innerHTML=summary;
      displayMonthlyTable(monthly, sorted);
    }

    function displayMonthlyTable(monthly, sorted){
      const table=document.getElementById("table-monthly");
      if(!sorted.length){ table.innerHTML='<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e mensuelle</p>'; return; }
      let html='<thead><tr><th>Mois</th><th>Total</th><th>Factur√©s</th><th>Non factur√©s</th><th>Taux</th><th>Montant total</th><th>Montant factur√©</th><th>Montant non factur√©</th></tr></thead><tbody>';
      const tot={total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0};
      for(const k of sorted){
        const d=monthly[k]; const taux=d.total?(d.factures/d.total*100).toFixed(1):0;
        html+=`<tr>
          <td><strong>${d.name}</strong></td>
          <td>${d.total}</td>
          <td style="color:#28a745">${d.factures}</td>
          <td style="color:#e74c3c">${d.nonFactures}</td>
          <td><strong>${taux}%</strong></td>
          <td>${toMoney(d.montantTotal)}</td>
          <td style="color:#28a745">${toMoney(d.montantFacture)}</td>
          <td style="color:#e74c3c">${toMoney(d.montantNonFacture)}</td>
        </tr>`;
        tot.total+=d.total; tot.factures+=d.factures; tot.nonFactures+=d.nonFactures;
        tot.montantTotal+=d.montantTotal; tot.montantFacture+=d.montantFacture; tot.montantNonFacture+=d.montantNonFacture;
      }
      if(sorted.length>1){
        const tauxG=tot.total?(tot.factures/tot.total*100).toFixed(1):0;
        html+=`<tr style="background:#f8f9fa;font-weight:bold;border-top:2px solid #667eea">
          <td><strong>TOTAL G√âN√âRAL</strong></td>
          <td>${tot.total}</td>
          <td style="color:#28a745">${tot.factures}</td>
          <td style="color:#e74c3c">${tot.nonFactures}</td>
          <td><strong>${tauxG}%</strong></td>
          <td>${toMoney(tot.montantTotal)}</td>
          <td style="color:#28a745">${toMoney(tot.montantFacture)}</td>
          <td style="color:#e74c3c">${toMoney(tot.montantNonFacture)}</td>
        </tr>`;
      }
      html+='</tbody>'; table.innerHTML=html;
    }

    function displayComparaison(){
      const table=document.getElementById("table-comparaison");
      const actesParDate={};
      for(const a of reconciledData){
        const d=a["Date_Formatee"]; if(!d) continue;
        actesParDate[d]=(actesParDate[d]||0)+1;
      }
      const manuelParDate={};
      for(const e of manualEntries){
        const d=new Date(e.date); if(isNaN(d)) continue;
        const f=formatDate(d); manuelParDate[f]=Number(e.count||0);
      }
      const allDates=new Set([...Object.keys(actesParDate),...Object.keys(manuelParDate)]);
      const sorted=[...allDates].sort((A,B)=>{
        const [ja,ma,ya]=A.split('/').map(Number); const [jb,mb,yb]=B.split('/').map(Number);
        if(ya!==yb) return ya-yb; if(ma!==mb) return ma-mb; return ja-jb;
      });
      if(sorted.length===0){ table.innerHTML='<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e de comparaison</p>'; return; }
      let html='<thead><tr><th>Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî (Manuel - Import√©)</th></tr></thead><tbody>';
      for(const d of sorted){
        const m=manuelParDate[d]||0; const imp=actesParDate[d]||0; const ec=m-imp;
        html+=`<tr>
          <td><strong>${d}</strong></td>
          <td>${m}</td>
          <td>${imp}</td>
          <td style="color:${ec>0?'#28a745':(ec<0?'#e74c3c':'#333')};font-weight:${ec!==0?'bold':'normal'}">${ec>0?'+':''}${ec}</td>
        </tr>`;
      }
      html+='</tbody>'; table.innerHTML=html;
    }

    // Export
    function exportComparaison(){
      const actesParDate={};
      for(const a of reconciledData){ const d=a["Date_Formatee"]; if(!d) continue; actesParDate[d]=(actesParDate[d]||0)+1; }
      const manuelParDate={};
      for(const e of manualEntries){ const d=new Date(e.date); if(isNaN(d)) continue; const f=formatDate(d); manuelParDate[f]=Number(e.count||0); }
      const allDates=new Set([...Object.keys(actesParDate),...Object.keys(manuelParDate)]);
      const sorted=[...allDates].sort((A,B)=>{
        const [ja,ma,ya]=A.split('/').map(Number); const [jb,mb,yb]=B.split('/').map(Number);
        if(ya!==yb) return ya-yb; if(ma!==mb) return ma-mb; return ja-jb;
      });
      const rows=sorted.map(d=>({ "Date":d, "Manuel":manuelParDate[d]||0, "Import√© (actes)":actesParDate[d]||0, "Œî (Manuel - Import√©)":(manuelParDate[d]||0)-(actesParDate[d]||0) }));
      const ws=XLSX.utils.json_to_sheet(rows), wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Comparaison');
      const t=new Date(); const name=`Comparaison_Quotidienne_${t.getFullYear()}_${String(t.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb,name);
    }
    function exportMonthlyReport(){
      const monthly={};
      for(const a of reconciledData){
        const d=a["Date_Formatee"]; if(!d) continue;
        const [jj,mm,yyyy]=d.split('/'); const key=`${mm}/${yyyy}`, name=getMonthName(+mm,+yyyy);
        if(!monthly[key]) monthly[key]={name,total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0};
        const m=a.Montant_num||0; monthly[key].total++; monthly[key].montantTotal+=m;
        if(a["Factur√©"]==="Oui"){ monthly[key].factures++; monthly[key].montantFacture+=m; } else { monthly[key].nonFactures++; monthly[key].montantNonFacture+=m; }
      }
      const sorted=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number); const [mb,yb]=b.split('/').map(Number); return ya!==yb?ya-yb:ma-mb;});
      const rows=sorted.map(k=>{ const d=monthly[k]; const tx=d.total?((d.factures/d.total*100).toFixed(1)+'%'):'0%'; return {
        'Mois':d.name,'Total Actes':d.total,'Actes Factur√©s':d.factures,'Actes Non Factur√©s':d.nonFactures,'Taux de Facturation':tx,'Montant Total (‚Ç¨)':(d.montantTotal||0).toFixed(2),'Montant Factur√© (‚Ç¨)':(d.montantFacture||0).toFixed(2),'Montant Non Factur√© (‚Ç¨)':(d.montantNonFacture||0).toFixed(2)
      };});
      const ws=XLSX.utils.json_to_sheet(rows), wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'R√©capitulatif Mensuel');
      const t=new Date(); const name=`Recapitulatif_Mensuel_${t.getFullYear()}_${String(t.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb,name);
    }
    function exportToExcel(type){
      let data, filename;
      if(type==='non-factures'){ data=reconciledData.filter(a=>a['Factur√©']==='Non'); filename='actes_non_factures.xlsx'; }
      else if(type==='factures'){ data=reconciledData.filter(a=>a['Factur√©']==='Oui'); filename='actes_factures.xlsx'; }
      else { data=reconciledData; filename='tous_les_actes.xlsx'; }
      const rows=data.map(r=>({'Date':r['Date_Formatee'],'Nom Patient':r['Nom_Complet'],'Num√©ro de Dossier':r['_DOSSIER_NORM'],'Prestation':r['Prestation'],'Montant (‚Ç¨)':(r['Montant_num']||0).toFixed(2),'Statut':r['Factur√©'],'D√©tails Facture':r['D√©tails_Facture']}));
      const ws=XLSX.utils.json_to_sheet(rows), wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Actes'); XLSX.writeFile(wb,filename);
    }

    // Saisie manuelle locale + synchro cloud si connect√©
    (function(){
      const addBtn=document.getElementById('btnAddManual');
      const expBtn=document.getElementById('btnExportManual');
      if(addBtn){ addBtn.addEventListener('click', async ()=>{
        const d=document.getElementById('manualDate').value;
        const c=Number(document.getElementById('manualCount').value||0);
        if(!d) return alert('Choisis une date'); if(c<0) return alert('Le nombre doit √™tre ‚â• 0');
        const i=manualEntries.findIndex(x=>x.date===d);
        if(i>-1) manualEntries[i].count=c; else manualEntries.push({date:d,count:c});
        localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
        // si connect√©, pousser en cloud aussi (silent)
        if(window.cloud){ try{ await window.cloud.upsertManual(d,c); }catch{} }
        renderManualTable();
        if(reconciledData.length>0){ displayMonthlySummary(); displayComparaison(); }
      });}
      if(expBtn){ expBtn.addEventListener('click', ()=>{
        if(!manualEntries.length) return alert('Aucune saisie');
        const rows=[["Date","Nombre d'actes"]].concat(manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(x=>[x.date,x.count]));
        const ws=XLSX.utils.aoa_to_sheet(rows), wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'Saisie'); XLSX.writeFile(wb,'saisie_manuelle.csv');
      });}
      renderManualTable();
    })();

    function renderManualTable(){
      const t=document.getElementById('manual-table'); if(!t) return;
      if(!manualEntries.length){ t.innerHTML='<thead><tr><th>Date</th><th>Nombre d\'actes</th><th></th></tr></thead><tbody><tr><td colspan="3" style="padding:12px;color:#666">Aucune saisie</td></tr></tbody>'; return; }
      let h='<thead><tr><th>Date</th><th>Nombre d\'actes</th><th>Action</th></tr></thead><tbody>';
      for(const e of manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date))){
        h+=`<tr><td>${e.date}</td><td>${e.count}</td><td><button class="remove-file-btn" onclick="deleteManual('${e.date}')">Supprimer</button></td></tr>`;
      }
      t.innerHTML=h+'</tbody>';
    }
    window.deleteManual = async function(date){
      manualEntries = manualEntries.filter(x=>x.date!==date);
      localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
      if(window.cloud){ try{ await window.cloud.deleteManual(date); }catch{} }
      renderManualTable();
      if(reconciledData.length>0){ displayMonthlySummary(); displayComparaison(); }
    };
  </script>
</body>
</html>
