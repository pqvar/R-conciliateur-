<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RÃ©conciliation des Actes MÃ©dicaux</title>

  <!-- Librairies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

  <style>
    :root{--violet:#6b5cff;--violet2:#5b4bd8;}
    body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      font-family:system-ui,sans-serif;color:#222;min-height:100vh;}
    .shell{max-width:1180px;margin:24px auto;background:#fff;border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;
      padding:22px 28px;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:22px}
    .btn{appearance:none;border:0;border-radius:10px;padding:9px 14px;
      font-weight:700;cursor:pointer}
    .btn.primary{background:var(--violet);color:#fff}
    .btn.secondary{background:#6c757d;color:#fff}
    .btn.ghost{background:#f3f4ff;color:#3c31b7}
    .hidden{display:none}
    .card{background:#fff;border:1px solid #e7e7ef;border-radius:12px;
      padding:16px;margin:14px 0}
    .note{font-size:13px;color:#555}
    .file-btn{border:2px dashed var(--violet);border-radius:10px;padding:8px 14px;
      background:#fff;color:var(--violet);cursor:pointer;font-weight:700}
    .file-list{margin-top:10px}
    .file-pill{display:flex;justify-content:space-between;align-items:center;
      background:#f6f7ff;border:1px solid #e1e3ff;border-radius:10px;padding:8px 10px;margin-top:6px}
    .file-pill button{background:#ff6b6b;border:0;color:#fff;border-radius:8px;padding:4px 6px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    th{background:#f3f4ff;color:#3c31b7}
    .stat{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;
      border-radius:10px;padding:12px;text-align:center}
    .stat .v{font-weight:800;font-size:22px}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .tag{background:#eef1ff;color:#3b36a8;border-radius:8px;padding:4px 8px;font-size:12px;font-weight:700}
    a.file-link{color:#3b36a8;text-decoration:none}
    a.file-link:hover{text-decoration:underline}
  </style>

  <!-- Firebase Modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import { getStorage, ref as stRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcP7Cuvbkvmcr_mq7E_nHuxjSmDWK08-4",
      authDomain: "reconciliateur-50684.firebaseapp.com",
      projectId: "reconciliateur-50684",
      storageBucket: "reconciliateur-50684.firebasestorage.app",
      messagingSenderId: "1029928449677",
      appId: "1:1029928449677:web:7445402f84a963d3ab54c4",
      measurementId: "G-STE125RQPZ"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);
    const provider = new GoogleAuthProvider();

    window.__fb = { app, auth, db, st, provider, doc, setDoc, collection, query, orderBy, onSnapshot, getDocs, stRef, uploadBytes, getDownloadURL };
    window.__fbSignIn  = () => signInWithPopup(auth, provider);
    window.__fbSignOut = () => signOut(auth);
    window.__fbOnAuth  = (cb) => onAuthStateChanged(auth, cb);
  </script>
</head>

<body>
  <div class="shell">
    <div class="header">
      <h1>ğŸ¥ RÃ©conciliation des Actes MÃ©dicaux</h1>
      <div class="row">
        <span class="tag" id="hostTag">Initialisationâ€¦</span>
        <button class="btn ghost small" id="btnLogin">Se connecter Google</button>
        <button class="btn secondary small hidden" id="btnLogout">DÃ©connexion</button>
      </div>
    </div>

    <div class="content">
      <div class="card">
        <div class="note"><b>ğŸ“ Chargement des fichiers</b></div>
        <input type="file" id="actesInput" accept=".xlsx,.xls" multiple hidden>
        <input type="file" id="honosInput" accept=".csv" multiple hidden>
        <button class="file-btn" id="btnActes">ğŸ“Š Ajouter fichier Excel (actes)</button>
        <button class="file-btn" id="btnHonos">ğŸ’° Ajouter fichier CSV (honoraires)</button>
        <button class="btn primary" id="btnAnalyze" disabled>ğŸ” Analyser</button>
        <button class="btn secondary" id="btnReset">ğŸ”„ RÃ©initialiser</button>
        <button class="btn secondary" id="btnUploadCloud" disabled>â˜ï¸ Uploader vers Storage</button>
        <div class="file-list" id="listActes"></div>
        <div class="file-list" id="listHonos"></div>
      </div>

      <div class="card">
        <div class="note"><b>âœï¸ Saisie manuelle quotidienne</b></div>
        <input type="date" id="mDate"> <input type="number" id="mCount" min="0" placeholder="0">
        <button class="btn primary" id="mAdd">â• Ajouter</button>
        <button class="btn secondary" id="mExport">ğŸ“¥ Exporter (CSV)</button>
        <table id="mTable"></table>
      </div>

      <div class="card">
        <div class="note"><b>ğŸ“ˆ RÃ©sultats</b></div>
        <div class="grid" id="statsBox"></div>
        <div id="tab-recap"></div>
        <div id="tab-non" class="hidden"></div>
        <div id="tab-oui" class="hidden"></div>
      </div>

      <div class="card" id="histCard" style="display:none">
        <div class="note"><b>ğŸ“œ Historique Firestore</b></div>
        <div id="histList" class="grid"></div>
      </div>
    </div>
  </div>

<script>
/* ====================== VARIABLES ====================== */
let actesFiles=[], honosFiles=[], actesData=[], honosData=[], reconciledData=[];
let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]');
const $ = s=>document.querySelector(s);
function fmtMoney(n){return (Number(n)||0).toFixed(2)+"â‚¬";}
function normalizeString(s=""){return s.normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^A-Za-z0-9\s'-]/g," ").replace(/\s+/g," ").trim().toUpperCase();}
function normalizeDossier(d=""){return d.toString().replace(/\D/g,"").replace(/^0+/,'');}
function fmtDate(d){if(!d)return"";const t=new Date(d);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;}

/* ====================== FICHIERS ====================== */
$('#btnActes').onclick=()=>$('#actesInput').click();
$('#btnHonos').onclick=()=>$('#honosInput').click();
$('#actesInput').onchange=e=>{for(const f of e.target.files){actesFiles.push(f);}renderFileList('actes');$('#btnAnalyze').disabled=false;};
$('#honosInput').onchange=e=>{for(const f of e.target.files){honosFiles.push(f);}renderFileList('honos');$('#btnAnalyze').disabled=false;};
function renderFileList(kind){
 const list=kind==='actes'?$('#listActes'):$('#listHonos');
 const arr=kind==='actes'?actesFiles:honosFiles;
 list.innerHTML=arr.map((f,i)=>`<div class="file-pill">${f.name}<button onclick="removeFile('${kind}',${i})">Suppr</button></div>`).join('');
}
window.removeFile=(kind,i)=>{if(kind==='actes')actesFiles.splice(i,1);else honosFiles.splice(i,1);renderFileList(kind);};

/* ====================== SAISIE MANUELLE ====================== */
$('#mAdd').onclick=()=>{const d=$('#mDate').value,c=Number($('#mCount').value||0);if(!d)return;manualEntries.push({date:d,count:c});
localStorage.setItem('manualEntries_v1',JSON.stringify(manualEntries));renderManual();}
function renderManual(){const t=$('#mTable');t.innerHTML=manualEntries.map(m=>`<tr><td>${m.date}</td><td>${m.count}</td></tr>`).join('');}
$('#mExport').onclick=()=>{const ws=XLSX.utils.json_to_sheet(manualEntries),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'saisie');XLSX.writeFile(wb,'saisie.csv');}
renderManual();

/* ====================== ANALYSE ====================== */
$('#btnAnalyze').onclick=async()=>{
 alert('Analyse fictive (dÃ©mo)');
};

/* ====================== FIREBASE ====================== */
(function initFirebase(){
 $('#hostTag').textContent='Cloud actif (Auth â€¢ Firestore â€¢ Storage)';
 $('#btnLogin').onclick=async()=>{try{await window.__fbSignIn();}catch(e){alert('Connexion impossible : '+e.message);}};
 $('#btnLogout').onclick=async()=>{try{await window.__fbSignOut();}catch(e){alert('DÃ©connexion : '+e.message);}};
 window.__fbOnAuth(async user=>{
   const on=!!user;
   $('#btnLogin').classList.toggle('hidden',on);
   $('#btnLogout').classList.toggle('hidden',!on);
   $('#btnUploadCloud').disabled=!on;
   $('#histCard').style.display=on?'block':'none';
   if(!on)return;
   bindHistorique(user.uid);
   await loadUploadedFiles(user.uid);
 });
 $('#btnUploadCloud').onclick=uploadToCloud;
})();

async function uploadToCloud(){
 const user=window.__fb.auth.currentUser;
 if(!user)return alert('Connecte-toi');
 const uploads=[...actesFiles.map(f=>({f,kind:'actes'})),...honosFiles.map(f=>({f,kind:'honoraires'}))];
 for(const u of uploads){
   const path=`users/${user.uid}/${u.kind}/${Date.now()}_${u.f.name}`;
   const ref=window.__fb.stRef(window.__fb.st,path);
   await window.__fb.uploadBytes(ref,u.f);
   const url=await window.__fb.getDownloadURL(ref);
   await window.__fb.setDoc(window.__fb.doc(window.__fb.db,'users',user.uid,'uploads',path),{kind:u.kind,filename:u.f.name,path,url,uploadedAt:Date.now()});
 }
 alert('Upload terminÃ© âœ…');
 await loadUploadedFiles(user.uid);
}

function bindHistorique(uid){
 const q=window.__fb.query(window.__fb.collection(window.__fb.db,'users',uid,'uploads'),window.__fb.orderBy('uploadedAt','desc'));
 window.__fb.onSnapshot(q,snap=>{
   const arr=snap.docs.map(d=>d.data());
   $('#histList').innerHTML=arr.map(r=>`<div class="card"><b>${r.filename}</b><br><a href="${r.url}" target="_blank">Ouvrir</a></div>`).join('');
 });
}

async function loadUploadedFiles(uid){
 const q=window.__fb.query(window.__fb.collection(window.__fb.db,'users',uid,'uploads'),window.__fb.orderBy('uploadedAt','desc'));
 const snap=await window.__fb.getDocs(q);
 const arr=snap.docs.map(d=>d.data());
 const a=$('#listActes'),h=$('#listHonos');a.innerHTML=h.innerHTML='';
 arr.forEach(u=>{
   const html=`<div class="file-pill">${u.kind==='actes'?'ğŸ“Š':'ğŸ’°'} <a class="file-link" href="${u.url}" target="_blank">${u.filename}</a></div>`;
   if(u.kind==='actes')a.innerHTML+=html;else h.innerHTML+=html;
 });
}
</script>
</body>
</html>
