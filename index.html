<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R√©conciliation des Actes M√©dicaux - Dr Pablo NEEL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;min-height:100vh}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2em;margin-bottom:10px}
    .content{padding:30px}
    .upload-section{background:#f8f9fa;border-radius:10px;padding:25px;margin-bottom:30px}
    .upload-section h2{color:#667eea;margin-bottom:20px;font-size:1.5em}
    .file-input-group{margin-bottom:20px}
    .file-input-group label{display:block;font-weight:600;color:#333;margin-bottom:8px;font-size:1.05em}
    .file-input-wrapper{position:relative;display:inline-block;width:100%}
    .file-input-wrapper input[type=file]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
    .file-input-button{display:block;padding:12px 20px;background:#fff;border:2px dashed #667eea;border-radius:8px;color:#667eea;font-weight:600;cursor:pointer;transition:.3s;text-align:center}
    .file-input-button:hover{background:#667eea;color:#fff}
    .files-list{margin-top:15px}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:#e8eaf6;border-radius:5px;margin-bottom:8px;transition:.3s}
    .file-item:hover{background:#d1d4e8}
    .file-info{display:flex;align-items:center;gap:10px;flex:1}
    .file-name{font-weight:600;color:#5e35b1}
    .file-size{font-size:.85em;color:#666}
    .remove-file-btn{padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:.9em;transition:.3s}
    .remove-file-btn:hover{background:#d32f2f;transform:scale(1.05)}
    .monthly-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
    .month-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);border-left:5px solid #667eea}
    .month-card h3{color:#667eea;margin-bottom:15px;font-size:1.3em;display:flex;align-items:center;gap:10px}
    .month-stats{display:flex;flex-direction:column;gap:10px}
    .month-stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e0e0e0}
    .month-stat-row:last-child{border-bottom:none}
    .month-stat-label{color:#666;font-size:.95em}
    .month-stat-value{font-weight:600;font-size:1.1em;color:#333}
    .month-stat-value.success{color:#28a745}
    .month-stat-value.warning{color:#e74c3c}
    .month-stat-value.amount{color:#667eea}
    .comparison-section{background:#f8f9fa;border-radius:10px;padding:20px;margin:20px 0}
    .action-buttons{display:flex;gap:15px;margin-top:25px}
    .btn{padding:15px 30px;border:none;border-radius:8px;font-size:1.1em;font-weight:600;cursor:pointer;transition:.3s;flex:1}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-secondary:hover{background:#5a6268}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:10px;text-align:center}
    .stat-card.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
    .stat-card.warning{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .stat-value{font-size:2.5em;font-weight:700;margin-bottom:5px}
    .stat-label{font-size:1em;opacity:.9}
    .results-section{margin-top:30px;display:none}
    .results-section.show{display:block}
    .tab-buttons{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e0e0e0;flex-wrap:wrap}
    .tab-btn{padding:15px 25px;background:transparent;border:none;border-bottom:3px solid transparent;font-size:1.05em;font-weight:600;color:#666;cursor:pointer;transition:.3s}
    .tab-btn.active{color:#667eea;border-bottom-color:#667eea}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:left;font-weight:600;position:sticky;top:0}
    td{padding:12px 15px;border-bottom:1px solid #e0e0e0}
    tr:hover{background:#f8f9fa}
    .status-badge{padding:5px 12px;border-radius:20px;font-size:.85em;font-weight:600}
    .status-factured{background:#d4edda;color:#155724}
    .status-not-factured{background:#f8d7da;color:#721c24}
    .export-btn{margin-top:20px;padding:12px 25px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.3s}
    .export-btn:hover{background:#218838;transform:translateY(-2px)}
    .loading{display:none;text-align:center;padding:20px}
    .loading.show{display:block}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .note{font-size:.9em;color:#555;margin-top:8px}
    /* ---- Saisie manuelle ---- */
    .manual-section{background:#f2f7ff;border:1px solid #d9e3ff;border-radius:10px;padding:20px;margin-bottom:25px}
    .manual-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
    .manual-grid input{width:100%;padding:10px;border:1px solid #cdd6f4;border-radius:8px}
    .manual-actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btn-ghost{background:#eef2ff;color:#3f51b5;border:1px solid #c5cae9}
    .btn-ghost:hover{background:#dfe5ff}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3f51b5;font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <p>Suivi des actes factur√©s et non factur√©s ‚Äî Ajoutez vos fichiers mensuels progressivement</p>
    </div>

    <div class="content">
      <div class="upload-section">
        <h2>üìÅ Chargement des fichiers</h2>
        <p class="note">üí° Astuce : Vous pouvez ajouter plusieurs fichiers progressivement. Cliquez sur ¬´ Ajouter ¬ª autant de fois que n√©cessaire, puis lancez l'analyse.</p>

        <div class="file-input-group">
          <label for="actesFile">Fichiers des actes r√©alis√©s (Excel)</label>
          <div class="file-input-wrapper">
            <input type="file" id="actesFile" accept=".xlsx,.xls" multiple style="display:none" />
            <button class="file-input-button" onclick="document.getElementById('actesFile').click()">üìä Ajouter un fichier Excel des actes</button>
          </div>
          <div id="actesFilesList" class="files-list"></div>
        </div>

        <div class="file-input-group">
          <label for="honorairesFiles">Fichiers des honoraires factur√©s (CSV)</label>
          <div class="file-input-wrapper">
            <input type="file" id="honorairesFiles" accept=".csv" multiple style="display:none" />
            <button class="file-input-button" onclick="document.getElementById('honorairesFiles').click()">üí∞ Ajouter des fichiers CSV des honoraires</button>
          </div>
          <div id="honorairesFilesList" class="files-list"></div>
          <p class="note">CSV attendu : s√©parateur ¬´ ; ¬ª, encodage ISO-8859-1, la 6·µâ ligne contient les en-t√™tes.</p>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="analyzeBtn" disabled>üîç Analyser et r√©concilier</button>
          <button class="btn btn-secondary" id="resetBtn">üîÑ R√©initialiser</button>
        </div>
      </div>

      <!-- ‚úçÔ∏è Saisie manuelle quotidienne -->
      <div class="manual-section">
        <h2>‚úçÔ∏è Saisie manuelle quotidienne</h2>
        <p class="note">Ajoutez chaque jour le <strong>nombre d'actes r√©alis√©s</strong> pour comparer avec les actes import√©s.</p>
        <div class="manual-grid">
          <div>
            <label for="manualDate" class="note">Date</label>
            <input type="date" id="manualDate" />
          </div>
          <div>
            <label for="manualCount" class="note">Nombre d'actes</label>
            <input type="number" id="manualCount" min="0" placeholder="0" />
          </div>
        </div>
        <div class="manual-actions">
          <button class="btn btn-ghost" id="manualAddBtn">‚ûï Ajouter</button>
          <span class="pill" id="manualTotal"></span>
          <button class="btn btn-ghost" id="manualExportBtn">‚¨áÔ∏è Export CSV</button>
          <button class="btn btn-ghost" id="manualClearBtn">üóëÔ∏è Vider (local)</button>
        </div>
        <div class="table-wrapper" style="margin-top:12px">
          <table id="manualTable"></table>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyse en cours‚Ä¶</p>
      </div>

      <div class="results-section" id="results">
        <div class="stats" id="stats"></div>

        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="recap">üìä R√©capitulatif Mensuel</button>
          <button class="tab-btn" data-tab="non-factures">‚ùå Actes non factur√©s</button>
          <button class="tab-btn" data-tab="factures">‚úÖ Actes factur√©s</button>
          <button class="tab-btn" data-tab="tous">üìã Tous les actes</button>
          <button class="tab-btn" data-tab="comparaison">üßÆ Comparaison quotidienne</button>
        </div>

        <div class="tab-content active" id="tab-recap">
          <div id="monthly-summary"></div>
          <div class="table-wrapper" style="margin-top:30px">
            <table id="table-monthly"></table>
          </div>
          <button class="export-btn" onclick="exportMonthlyReport()">üì• Exporter le r√©capitulatif mensuel (Excel)</button>
        </div>

        <div class="tab-content" id="tab-non-factures">
          <div class="table-wrapper"><table id="table-non-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('non-factures')">üì• Exporter les actes non factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-factures">
          <div class="table-wrapper"><table id="table-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('factures')">üì• Exporter les actes factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-tous">
          <div class="table-wrapper"><table id="table-tous"></table></div>
          <button class="export-btn" onclick="exportToExcel('tous')">üì• Exporter tous les actes (Excel)</button>
        </div>

        <div class="tab-content" id="tab-comparaison">
          <div class="table-wrapper"><table id="table-comparaison"></table></div>
          <button class="export-btn" id="exportComparaisonBtn">üì• Exporter la comparaison (CSV)</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== √âTAT =====
    let actesFiles = [];
    let honorairesFiles = [];
    let actesData = [];
    let honorairesData = [];
    let reconciledData = [];

    // Saisie manuelle (localStorage)
    let manualEntries = []; // { date: 'JJ/MM/AAAA', count: number }
    const LS_KEY = 'manual_actes_entries_v1';

    // ===== UTILITAIRES =====
    const normalizeString = (s="") =>
      s.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^A-Za-z0-9\s'-]/g," ")
       .replace(/\s+/g," ").trim().toUpperCase();
    const normalizeDossier = (d="") => d.toString().replace(/\D/g,"").replace(/^0+/,"");
    const parseFrenchNumber = (val) => {
      if (val===null||val===undefined) return 0;
      if (typeof val==="number") return val;
      const s=String(val).replace(/\s/g,"");
      const n=parseFloat(s.replace(/\./g,"").replace(/,/g,"."));
      return isNaN(n)?0:n;
    };
    const toMoney = (n) => (Number(n)||0).toFixed(2)+"‚Ç¨";

    function excelDateToJSDate(serial){
      if (!serial && serial!==0) return null;
      if (serial instanceof Date) return new Date(serial.getFullYear(), serial.getMonth(), serial.getDate());
      if (typeof serial === 'string'){
        const s = serial.trim();
        const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if (m1) return new Date(+m1[1], +m1[2]-1, +m1[3]);
        const m2 = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if (m2) return new Date(+m2[3], +m2[2]-1, +m2[1]);
        const d = new Date(s); return isNaN(d)?null:new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }
      const utcDays = Math.floor(serial-25569);
      const utcValue = utcDays*86400;
      const dateInfo = new Date(utcValue*1000);
      return new Date(dateInfo.getFullYear(), dateInfo.getMonth(), dateInfo.getDate());
    }
    function formatDate(date){
      if(!date) return '';
      const d=new Date(date); if(isNaN(d)) return '';
      const day=String(d.getDate()).padStart(2,'0');
      const month=String(d.getMonth()+1).padStart(2,'0');
      const year=d.getFullYear();
      return `${day}/${month}/${year}`;
    }
    const normalizeDateString = (s) => {
      if(!s) return '';
      const str=String(s).trim();
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return str;
      const m1=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m1) return `${m1[3]}/${m1[2]}/${m1[1]}`;
      const d=new Date(str);
      return isNaN(d)?str:formatDate(d);
    };
    const todayInputValue = () => {
      const d=new Date();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };

    // ===== GESTION DES FICHIERS =====
    document.getElementById('actesFile').addEventListener('change', (e)=>{
      const newFiles=[...e.target.files];
      newFiles.forEach(f=>{
        if(!actesFiles.find(x=>x.name===f.name&&x.size===f.size)) actesFiles.push(f);
      });
      updateFilesList('actes'); checkFilesReady(); e.target.value='';
    });
    document.getElementById('honorairesFiles').addEventListener('change', (e)=>{
      const newFiles=[...e.target.files];
      newFiles.forEach(f=>{
        if(!honorairesFiles.find(x=>x.name===f.name&&x.size===f.size)) honorairesFiles.push(f);
      });
      updateFilesList('honoraires'); checkFilesReady(); e.target.value='';
    });

    function updateFilesList(type){
      const files = (type==='actes')? actesFiles : honorairesFiles;
      const el = document.getElementById(type==='actes'?'actesFilesList':'honorairesFilesList');
      el.innerHTML = files.map((file,idx)=>`
        <div class="file-item">
          <div class="file-info">
            <div>${type==='actes'?'üìä':'üí∞'}</div>
            <div>
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
          <button class="remove-file-btn" onclick="removeFile('${type}',${idx})">‚úï Supprimer</button>
        </div>`).join('');
    }
    function removeFile(type,index){
      if(type==='actes') actesFiles.splice(index,1); else honorairesFiles.splice(index,1);
      updateFilesList(type); checkFilesReady();
    }
    function formatFileSize(b){
      if(b===0) return '0 Bytes';
      const k=1024; const s=['Bytes','KB','MB','GB'];
      const i=Math.floor(Math.log(b)/Math.log(k));
      return Math.round((b/Math.pow(k,i))*100)/100 + ' ' + s[i];
    }
    function checkFilesReady(){
      document.getElementById('analyzeBtn').disabled = !(actesFiles.length>0 && honorairesFiles.length>0);
    }

    document.getElementById('analyzeBtn').addEventListener('click', analyzeFiles);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      actesFiles=[]; honorairesFiles=[]; actesData=[]; honorairesData=[]; reconciledData=[];
      updateFilesList('actes'); updateFilesList('honoraires'); checkFilesReady();
      document.getElementById('results').classList.remove('show');
    });

    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        const tab=this.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
      });
    });

    // ===== SAISIE MANUELLE (LocalStorage) =====
    function loadManual(){
      try{ const raw=localStorage.getItem(LS_KEY); manualEntries = raw? JSON.parse(raw): []; }
      catch{ manualEntries=[]; }
    }
    function saveManual(){ localStorage.setItem(LS_KEY, JSON.stringify(manualEntries)); }
    function refreshManualUI(){ displayManualTable(); updateManualTotal(); displayComparison(); }
    function addManualEntry(){
      const dateInput=document.getElementById('manualDate').value;
      const count=Number(document.getElementById('manualCount').value||0);
      if(!dateInput) return alert('Choisis une date.');
      if(count<0) return alert('Le nombre doit √™tre ‚â• 0');
      const [y,m,d]=dateInput.split('-');
      const fr=`${d}/${m}/${y}`;
      const idx=manualEntries.findIndex(e=>e.date===fr);
      if(idx>-1){ manualEntries[idx].count = count; }
      else{ manualEntries.push({date:fr, count}); }
      manualEntries.sort((a,b)=>{
        const [da,ma,ya]=a.date.split('/').map(Number);
        const [db,mb,yb]=b.date.split('/').map(Number);
        return ya!==yb? ya-yb : ma!==mb? ma-mb : da-db;
      });
      saveManual(); refreshManualUI();
    }
    function deleteManual(date){
      manualEntries = manualEntries.filter(e=>e.date!==date);
      saveManual(); refreshManualUI();
    }
    function updateManualTotal(){
      const tot=manualEntries.reduce((s,e)=>s+Number(e.count||0),0);
      document.getElementById('manualTotal').textContent = `Total saisi: ${tot}`;
    }
    function displayManualTable(){
      const t=document.getElementById('manualTable');
      if(!manualEntries.length){
        t.innerHTML='<thead><tr><th>Date</th><th>Nb actes</th><th></th></tr></thead><tbody><tr><td colspan="3" style="text-align:center;color:#666;padding:12px">Aucune saisie</td></tr></tbody>';
        return;
      }
      let html='<thead><tr><th>Date</th><th>Nb actes</th><th>Action</th></tr></thead><tbody>';
      for(const e of manualEntries){
        html+=`<tr><td>${e.date}</td><td>${e.count}</td><td><button class="remove-file-btn" onclick="deleteManual('${e.date}')">Supprimer</button></td></tr>`;
      }
      html+='</tbody>'; t.innerHTML=html;
    }
    function exportManualCSV(){
      if(!manualEntries.length) return alert('Aucune saisie √† exporter.');
      const rows=['date;nb_actes', ...manualEntries.map(e=>`${e.date};${e.count}`)];
      const blob=new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='saisies_manuelles.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function clearManual(){
      if(!confirm('Supprimer toutes les saisies locales ?')) return;
      manualEntries=[]; saveManual(); refreshManualUI();
    }
    // Init champs + boutons
    document.getElementById('manualDate').value = todayInputValue();
    document.getElementById('manualAddBtn').addEventListener('click', addManualEntry);
    document.getElementById('manualExportBtn').addEventListener('click', exportManualCSV);
    document.getElementById('manualClearBtn').addEventListener('click', clearManual);
    loadManual(); refreshManualUI();

    // ===== LECTURE FICHIERS =====
    async function analyzeFiles(){
      document.getElementById('loading').classList.add('show');
      document.getElementById('results').classList.remove('show');
      try{
        actesData=[];
        for(const file of actesFiles){ const data=await readExcelFile(file); actesData=actesData.concat(data); }
        honorairesData=[];
        for(const file of honorairesFiles){ const data=await readCSVFile(file); honorairesData=honorairesData.concat(data); }
        reconcileData();
        displayResults();
        document.getElementById('loading').classList.remove('show');
        document.getElementById('results').classList.add('show');
      }catch(error){
        console.error(error);
        alert('Erreur lors de l\'analyse des fichiers: ' + error.message);
        document.getElementById('loading').classList.remove('show');
      }
    }

    function readExcelFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e){
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

            // rep√®re la ligne des en-t√™tes (contient ‚ÄúNum√©ro de dossier‚Äù)
            let headerRow = -1;
            for (let i = 0; i < jsonData.length; i++){
              if (jsonData[i].some(cell => String(cell||'').toLowerCase().includes('num√©ro de dossier'))){
                headerRow = i; break;
              }
            }
            if (headerRow === -1) return reject(new Error('En-t√™te non trouv√© dans le fichier Excel'));

            const headers = jsonData[headerRow];
            const dataRows = jsonData.slice(headerRow + 1);

            const result = dataRows.map(row => {
              const obj = {};
              headers.forEach((header, index) => { obj[header] = row[index]; });
              return obj;
            }).filter(row => row['Nom'] && row['Num√©ro de dossier']);

            resolve(result);
          }catch(err){ reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function readCSVFile(file){
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          encoding: 'ISO-8859-1',
          delimiter: ';',
          skipEmptyLines: true,
          complete: function(results){
            try{
              if (results.data.length < 7) return reject(new Error('Le fichier CSV ne contient pas assez de lignes'));

              const headers = ['Praticien','Dossier','Patient','Libell√©','Transfert','Date Acte','Serv.','Coeff.','Pertes','Mt Hors D√©pass.','D√©pass.','Total','Vide'];
              const dataRows = results.data.slice(6);

              const result = dataRows.map(row => {
                if (!row || row.length < 6) return null;
                const obj = {};
                headers.forEach((header, index) => { obj[header] = row[index] ? row[index].replace(/"/g, '').trim() : ''; });
                obj['Date Acte'] = normalizeDateString(obj['Date Acte']);
                obj['Total'] = parseFrenchNumber(obj['Total']);
                obj['Dossier'] = normalizeDossier(obj['Dossier']);
                obj['Patient_norm'] = normalizeString(obj['Patient']);
                return obj;
              }).filter(row => row && row['Dossier'] && row['Date Acte']);

              resolve(result);
            }catch(err){ reject(err); }
          },
          error: reject
        });
      });
    }

    // ===== R√âCONCILIATION =====
    function reconcileData(){
      const honIndex = new Map();
      for (const hon of honorairesData){
        const key = `${hon['Dossier']}|${hon['Patient_norm']}|${hon['Date Acte']}`;
        if (!honIndex.has(key)) honIndex.set(key, hon);
      }

      reconciledData = actesData.map(acte => {
        const dossier = normalizeDossier(acte['Num√©ro de dossier']||acte['Num√©ro de Dossier']||'');
        const nom = normalizeString(acte['Nom'] || '');
        const prenom = normalizeString(acte['Pr√©nom'] || acte['Prenom'] || '');
        const nomComplet = `${nom} ${prenom}`.trim();
        const patientNorm = normalizeString(nomComplet);
        const dateActe = excelDateToJSDate(acte['Date de d√©but'] || acte['Date']);
        const dateFormatted = formatDate(dateActe);
        const prestation = acte['Prestation'] || acte['Acte'] || '';
        const montant = parseFrenchNumber(acte['Prix_Unitaire_Coefficient_Quantit√©'] || acte['Montant'] || acte['Tarif']);

        const key = `${dossier}|${patientNorm}|${dateFormatted}`;
        const match = honIndex.get(key);

        return {
          ...acte,
          _DOSSIER_NORM: dossier,
          Nom_Complet: nomComplet,
          Patient_norm: patientNorm,
          Date_Formatee: dateFormatted,
          Prestation: prestation,
          Montant_num: Number(montant)||0,
          Factur√©: match ? 'Oui' : 'Non',
          D√©tails_Facture: match ? (match['Libell√©'] || 'N/A') : ''
        };
      });
    }

    // ===== AFFICHAGE =====
    function displayResults(){
      const totalActes = reconciledData.length;
      const actesFactures = reconciledData.filter(a => a['Factur√©'] === 'Oui').length;
      const actesNonFactures = totalActes - actesFactures;
      const montantNonFacture = reconciledData.filter(a => a['Factur√©'] === 'Non')
        .reduce((sum, a) => sum + (a.Montant_num||0), 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalActes}</div><div class="stat-label">Total actes</div>
        </div>
        <div class="stat-card success">
          <div class="stat-value">${actesFactures}</div><div class="stat-label">Actes factur√©s</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value">${actesNonFactures}</div><div class="stat-label">Actes non factur√©s</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value">${toMoney(montantNonFacture)}</div><div class="stat-label">Montant non factur√©</div>
        </div>`;

      displayTable('non-factures', reconciledData.filter(a => a['Factur√©'] === 'Non'));
      displayTable('factures', reconciledData.filter(a => a['Factur√©'] === 'Oui'));
      displayTable('tous', reconciledData);
      displayMonthlySummary();
      displayComparison();
    }

    function displayTable(type, data){
      const table = document.getElementById(`table-${type}`);
      if (data.length === 0){
        table.innerHTML = '<p style="padding:20px;text-align:center;color:#666;">Aucune donn√©e √† afficher</p>';
        return;
      }
      let html = '<thead><tr><th>Date</th><th>Nom Patient</th><th>N¬∞ Dossier</th><th>Prestation</th><th>Montant</th><th>Statut</th><th>D√©tails</th></tr></thead><tbody>';
      data.forEach(row => {
        const statusClass = row['Factur√©'] === 'Oui' ? 'status-factured' : 'status-not-factured';
        const statusText = row['Factur√©'] === 'Oui' ? '‚úì Factur√©' : '‚úó Non factur√©';
        html += `<tr>
          <td>${row['Date_Formatee']||''}</td>
          <td>${row['Nom_Complet']||''}</td>
          <td>${row['_DOSSIER_NORM']||''}</td>
          <td>${row['Prestation']||''}</td>
          <td>${toMoney(row['Montant_num'])}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${row['D√©tails_Facture']||''}</td>
        </tr>`;
      });
      html += '</tbody>';
      table.innerHTML = html;
    }

    // ===== R√âCAP MENSUEL =====
    function displayMonthlySummary(){
      const monthly = {};
      reconciledData.forEach(a => {
        const d = a['Date_Formatee'];
        if(!d) return;
        const [jj,mm,yy] = d.split('/');
        if(!(jj&&mm&&yy)) return;
        const key = `${mm}/${yy}`;
        const name = getMonthName(+mm, +yy);
        if(!monthly[key]) monthly[key] = {
          name,total:0,factures:0,nonFactures:0,
          montantTotal:0,montantFacture:0,montantNonFacture:0
        };
        const m = a.Montant_num||0;
        monthly[key].total++;
        monthly[key].montantTotal+=m;
        if(a['Factur√©']==='Oui'){ monthly[key].factures++; monthly[key].montantFacture+=m; }
        else{ monthly[key].nonFactures++; monthly[key].montantNonFacture+=m; }
      });

      const sorted = Object.keys(monthly).sort((a,b)=>{
        const [ma,ya]=a.split('/').map(Number);
        const [mb,yb]=b.split('/').map(Number);
        return ya!==yb? ya-yb : ma-mb;
      });

      let summary = '<div class="monthly-summary-grid">';
      sorted.forEach(k=>{
        const d=monthly[k];
        const taux=d.total? (d.factures/d.total*100).toFixed(1):0;
        summary += `
          <div class="month-card">
            <h3>üìÖ ${d.name}</h3>
            <div class="month-stats">
              <div class="month-stat-row"><span class="month-stat-label">Total actes</span><span class="month-stat-value">${d.total}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Actes factur√©s</span><span class="month-stat-value success">${d.factures} (${taux}%)</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Actes non factur√©s</span><span class="month-stat-value warning">${d.nonFactures}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Montant total</span><span class="month-stat-value amount">${toMoney(d.montantTotal)}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Montant factur√©</span><span class="month-stat-value success">${toMoney(d.montantFacture)}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Montant non factur√©</span><span class="month-stat-value warning">${toMoney(d.montantNonFacture)}</span></div>
            </div>
          </div>`;
      });
      summary += '</div>';
      if(sorted.length>1){
        summary += `<div class="comparison-section">
          <h3>üìä Comparaison des mois</h3>
          <p class="note">Vue d'ensemble de l'√©volution mensuelle</p>
        </div>`;
      }
      document.getElementById('monthly-summary').innerHTML = summary;

      displayMonthlyTable(monthly, sorted);
    }

    function getMonthName(month, year){
      const monthNames = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
      return `${monthNames[month - 1]} ${year}`;
    }

    function displayMonthlyTable(monthly, sorted){
      const table = document.getElementById('table-monthly');
      if(!sorted.length){
        table.innerHTML = '<p style="padding:20px;text-align:center;color:#666;">Aucune donn√©e mensuelle disponible</p>';
        return;
      }

      let html = '<thead><tr><th>Mois</th><th>Total Actes</th><th>Factur√©s</th><th>Non Factur√©s</th><th>Taux Facturation</th><th>Montant Total</th><th>Montant Factur√©</th><th>Montant Non Factur√©</th></tr></thead><tbody>';

      const totalGeneral = { total:0, factures:0, nonFactures:0, montantTotal:0, montantFacture:0, montantNonFacture:0 };

      sorted.forEach(k=>{
        const d=monthly[k];
        const taux=d.total? (d.factures/d.total*100).toFixed(1):0;
        html += `<tr>
          <td><strong>${d.name}</strong></td>
          <td>${d.total}</td>
          <td><span style="color:#28a745;font-weight:600;">${d.factures}</span></td>
          <td><span style="color:#e74c3c;font-weight:600;">${d.nonFactures}</span></td>
          <td><strong>${taux}%</strong></td>
          <td>${toMoney(d.montantTotal)}</td>
          <td style="color:#28a745;">${toMoney(d.montantFacture)}</td>
          <td style="color:#e74c3c;">${toMoney(d.montantNonFacture)}</td>
        </tr>`;
        totalGeneral.total += d.total;
        totalGeneral.factures += d.factures;
        totalGeneral.nonFactures += d.nonFactures;
        totalGeneral.montantTotal += d.montantTotal;
        totalGeneral.montantFacture += d.montantFacture;
        totalGeneral.montantNonFacture += d.montantNonFacture;
      });

      if(sorted.length>1){
        const tauxGlobal = totalGeneral.total ? (totalGeneral.factures/totalGeneral.total*100).toFixed(1) : 0;
        html += `<tr style="background:#f8f9fa;font-weight:bold;border-top:2px solid #667eea;">
          <td><strong>TOTAL G√âN√âRAL</strong></td>
          <td>${totalGeneral.total}</td>
          <td style="color:#28a745;">${totalGeneral.factures}</td>
          <td style="color:#e74c3c;">${totalGeneral.nonFactures}</td>
          <td><strong>${tauxGlobal}%</strong></td>
          <td>${toMoney(totalGeneral.montantTotal)}</td>
          <td style="color:#28a745;">${toMoney(totalGeneral.montantFacture)}</td>
          <td style="color:#e74c3c;">${toMoney(totalGeneral.montantNonFacture)}</td>
        </tr>`;
      }

      html += '</tbody>';
      table.innerHTML = html;
    }

    // ===== COMPARAISON QUOTIDIENNE =====
    function getDailyCountsFromReconciled(){
      const map = new Map();
      for(const a of reconciledData){
        const d = a['Date_Formatee']; if(!d) continue;
        map.set(d, (map.get(d)||0)+1);
      }
      return map;
    }
    function displayComparison(){
      const table = document.getElementById('table-comparaison');
      const importMap = getDailyCountsFromReconciled();
      const allDates = new Set([
        ...manualEntries.map(e=>e.date),
        ...Array.from(importMap.keys())
      ]);
      if(!allDates.size){
        table.innerHTML = '<p style="padding:20px;text-align:center;color:#666;">Pas encore de donn√©es √† comparer</p>';
        return;
      }
      const sorted = [...allDates].sort((a,b)=>{
        const [da,ma,ya]=a.split('/').map(Number);
        const [db,mb,yb]=b.split('/').map(Number);
        return ya!==yb? ya-yb : ma!==mb? ma-mb : da-db;
      });

      let html = '<thead><tr><th>Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî (Manuel - Import√©)</th></tr></thead><tbody>';
      let sumM=0, sumI=0;
      for(const d of sorted){
        const m = manualEntries.find(e=>e.date===d)?.count || 0;
        const i = importMap.get(d) || 0;
        const delta = m - i;
        const color = delta===0? '#333' : (delta>0? '#28a745' : '#e74c3c');
        html += `<tr><td>${d}</td><td>${m}</td><td>${i}</td><td style="color:${color};font-weight:600">${delta}</td></tr>`;
        sumM += m; sumI += i;
      }
      const dTot = sumM - sumI;
      const cTot = dTot===0? '#333' : (dTot>0? '#28a745' : '#e74c3c');
      html += `<tr style="background:#f8f9fa;font-weight:bold"><td>Total</td><td>${sumM}</td><td>${sumI}</td><td style="color:${cTot}">${dTot}</td></tr>`;
      html += '</tbody>';
      table.innerHTML = html;
    }
    document.getElementById('exportComparaisonBtn').addEventListener('click', ()=>{
      const importMap=getDailyCountsFromReconciled();
      const allDates=new Set([...manualEntries.map(e=>e.date), ...Array.from(importMap.keys())]);
      const sorted=[...allDates].sort((a,b)=>{
        const [da,ma,ya]=a.split('/').map(Number);
        const [db,mb,yb]=b.split('/').map(Number);
        return ya!==yb? ya-yb : ma!==mb? ma-mb : da-db;
      });
      const rows=['date;manuel;importe;delta'];
      let sumM=0,sumI=0;
      for(const d of sorted){
        const m=manualEntries.find(e=>e.date===d)?.count||0;
        const i=importMap.get(d)||0;
        sumM+=m; sumI+=i;
        rows.push(`${d};${m};${i};${m-i}`);
      }
      rows.push(`TOTAL;${sumM};${sumI};${sumM-sumI}`);
      const blob=new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='comparaison_quotidienne.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ===== EXPORTS =====
    function exportMonthlyReport(){
      const monthly = {};
      reconciledData.forEach(a=>{
        const d=a['Date_Formatee']; if(!d) return;
        const [jj,mm,yy]=d.split('/'); if(!(jj&&mm&&yy)) return;
        const key=`${mm}/${yy}`; const name=getMonthName(+mm,+yy);
        if(!monthly[key]) monthly[key]={name,total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0};
        const m=a.Montant_num||0;
        monthly[key].total++; monthly[key].montantTotal+=m;
        if(a['Factur√©']==='Oui'){ monthly[key].factures++; monthly[key].montantFacture+=m; }
        else { monthly[key].nonFactures++; monthly[key].montantNonFacture+=m; }
      });

      const sorted=Object.keys(monthly).sort((a,b)=>{
        const [ma,ya]=a.split('/').map(Number);
        const [mb,yb]=b.split('/').map(Number);
        return ya!==yb? ya-yb : ma-mb;
      });

      const exportData = sorted.map(k=>{
        const d=monthly[k];
        const taux=d.total? (d.factures/d.total*100).toFixed(1)+'%' : '0%';
        return {
          'Mois': d.name,
          'Total Actes': d.total,
          'Actes Factur√©s': d.factures,
          'Actes Non Factur√©s': d.nonFactures,
          'Taux de Facturation': taux,
          'Montant Total (‚Ç¨)': (d.montantTotal||0).toFixed(2),
          'Montant Factur√© (‚Ç¨)': (d.montantFacture||0).toFixed(2),
          'Montant Non Factur√© (‚Ç¨)': (d.montantNonFacture||0).toFixed(2)
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'R√©capitulatif Mensuel');

      const t=new Date();
      const filename=`Recapitulatif_Mensuel_${t.getFullYear()}_${String(t.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    function exportToExcel(type){
      let data, filename;
      if(type==='non-factures'){ data=reconciledData.filter(a=>a['Factur√©']==='Non'); filename='actes_non_factures.xlsx'; }
      else if(type==='factures'){ data=reconciledData.filter(a=>a['Factur√©']==='Oui'); filename='actes_factures.xlsx'; }
      else { data=reconciledData; filename='tous_les_actes.xlsx'; }

      const rows = data.map(row => ({
        'Date': row['Date_Formatee'],
        'Nom Patient': row['Nom_Complet'],
        'Num√©ro de Dossier': row['_DOSSIER_NORM'],
        'Prestation': row['Prestation'],
        'Montant (‚Ç¨)': (row['Montant_num']||0).toFixed(2),
        'Statut': row['Factur√©'],
        'D√©tails Facture': row['D√©tails_Facture']
      }));

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Actes');
      XLSX.writeFile(wb, filename);
    }
  </script>
</body>
</html>
