<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>R√©conciliation des Actes M√©dicaux</title>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

<style>
:root{--violet:#6b5cff;--violet2:#5b4bd8;}
body{margin:0;background:linear-gradient(135deg,#667eea,#764ba2);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#222;min-height:100vh}
.shell{max-width:1180px;margin:24px auto;background:#fff;border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:22px 28px;display:flex;align-items:center;justify-content:space-between}
h1{margin:0;font-size:22px}
.btn{appearance:none;border:0;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--violet);color:#fff}
.btn.secondary{background:#6c757d;color:#fff}
.btn.ghost{background:#f3f4ff;color:#3c31b7}
.hidden{display:none}
.card{background:#fff;border:1px solid #e7e7ef;border-radius:12px;padding:16px;margin:14px 0}
.note{font-size:13px;color:#555}
.file-btn{border:2px dashed var(--violet);border-radius:10px;padding:8px 14px;background:#fff;color:var(--violet);cursor:pointer;font-weight:700}
.file-list{margin-top:10px}
.file-pill{display:flex;justify-content:space-between;align-items:center;background:#f6f7ff;border:1px solid #e1e3ff;border-radius:10px;padding:8px 10px;margin-top:6px}
.file-pill button{background:#ff6b6b;border:0;color:#fff;border-radius:8px;padding:4px 6px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
th{background:#f3f4ff;color:#3c31b7;position:sticky;top:0}
.stat{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:10px;padding:12px;text-align:center}
.stat .v{font-weight:800;font-size:22px}
.grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
.tag{background:#eef1ff;color:#3b36a8;border-radius:8px;padding:4px 8px;font-size:12px;font-weight:700}
.tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.tabbar .btn{background:#eef0ff;color:#3c31b7}
.tabbar .btn.active{background:var(--violet2);color:#fff}
a.file-link{color:#3b36a8;text-decoration:none}
a.file-link:hover{text-decoration:underline}
.cloud-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.cloud-item{border:1px solid #e7e7ef;border-radius:10px;padding:10px}
.cloud-item label{display:flex;gap:8px;align-items:flex-start;cursor:pointer}
.cloud-kind{font-size:12px;padding:2px 6px;border-radius:6px;background:#eef0ff;color:#3c31b7}
.cloud-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
</style>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  import { getStorage, ref as stRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDcP7Cuvbkvmcr_mq7E_nHuxjSmDWK08-4",
    authDomain: "reconciliateur-50684.firebaseapp.com",
    projectId: "reconciliateur-50684",
    storageBucket: "reconciliateur-50684.firebasestorage.app",
    messagingSenderId: "1029928449677",
    appId: "1:1029928449677:web:7445402f84a963d3ab54c4",
    measurementId: "G-STE125RQPZ"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  const provider = new GoogleAuthProvider();

  window.__fb = { app, auth, db, st, provider, doc, setDoc, getDoc, deleteDoc, collection, query, orderBy, onSnapshot, getDocs, stRef, uploadBytes, getDownloadURL };
  window.__fbSignIn  = () => signInWithPopup(auth, provider);
  window.__fbSignOut = () => signOut(auth);
  window.__fbOnAuth  = (cb) => onAuthStateChanged(auth, cb);
</script>
</head>

<body>
<div class="shell">
  <div class="header">
    <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
    <div>
      <span class="tag" id="hostTag">Cloud actif (Auth ‚Ä¢ Firestore ‚Ä¢ Storage)</span>
      <button class="btn ghost" id="btnLogin">Se connecter Google</button>
      <button class="btn secondary hidden" id="btnLogout">D√©connexion</button>
    </div>
  </div>

  <div class="content">

    <!-- Upload local -->
    <div class="card">
      <div class="note"><b>üìÅ Chargement des fichiers</b></div>
      <input type="file" id="actesInput" accept=".xlsx,.xls" multiple hidden>
      <input type="file" id="honosInput" accept=".csv" multiple hidden>
      <button class="file-btn" id="btnActes">üìä Ajouter fichier Excel (actes)</button>
      <button class="file-btn" id="btnHonos">üí∞ Ajouter fichier CSV (honoraires)</button>
      <button class="btn primary" id="btnAnalyze" disabled>üîç Analyser & r√©concilier</button>
      <button class="btn secondary" id="btnReset">üîÑ R√©initialiser</button>
      <button class="btn secondary" id="btnUploadCloud" disabled>‚òÅÔ∏è Uploader vers Storage</button>
      <div class="file-list" id="listActes"></div>
      <div class="file-list" id="listHonos"></div>
    </div>

    <!-- Saisie manuelle -->
    <div class="card">
      <div class="note"><b>‚úçÔ∏è Saisie manuelle quotidienne (comparatif)</b></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input type="date" id="mDate"> 
        <input type="number" id="mCount" min="0" placeholder="0">
        <button class="btn primary" id="mAdd">‚ûï Ajouter / Mettre √† jour</button>
        <button class="btn secondary" id="mExport">üì• Exporter (CSV)</button>
      </div>
      <table id="mTable"></table>
    </div>

    <!-- R√©sultats -->
    <div class="card">
      <div class="note"><b>üìà R√©sultats</b></div>
      <div class="grid" id="statsBox"></div>
      <div class="tabbar">
        <button class="btn" id="tabBtn-recap" data-tab="recap">üìä R√©cap mensuel</button>
        <button class="btn" id="tabBtn-compar" data-tab="compar">üìà Comparaison quotidienne</button>
        <button class="btn" id="tabBtn-non"   data-tab="non">‚ùå Actes non factur√©s</button>
        <button class="btn" id="tabBtn-oui"   data-tab="oui">‚úÖ Actes factur√©s</button>
        <button class="btn" id="tabBtn-tous"  data-tab="tous">üìã Tous les actes</button>
      </div>
      <div id="tab-recap"></div>
      <div id="tab-compar" class="hidden"></div>
      <div id="tab-non" class="hidden"></div>
      <div id="tab-oui" class="hidden"></div>
      <div id="tab-tous" class="hidden"></div>
    </div>

    <!-- Cloud : fichiers + recaps + saisie manuelle -->
    <div class="card" id="cloudCard" style="display:none">
      <div class="note"><b>‚òÅÔ∏è Fichiers & historiques (Cloud)</b></div>

      <h4>Fichiers envoy√©s</h4>
      <div id="cloudFiles" class="cloud-grid"></div>
      <div class="cloud-actions">
        <button class="btn primary" id="btnAddSelected">‚ûï Ajouter √† l‚Äôanalyse</button>
      </div>

      <h4 style="margin-top:16px">R√©caps sauvegard√©s</h4>
      <div id="recapList" class="grid"></div>

      <h4 style="margin-top:16px">Saisie manuelle (Cloud)</h4>
      <div class="note">Synchronis√©e en temps r√©el avec la table ci-dessus.</div>
      <div id="cloudManualInfo" class="note"></div>
    </div>

  </div>
</div>

<script>
/* ===== √âTAT ===== */
let actesFiles=[], honosFiles=[], actesData=[], honosData=[], reconciledData=[];
let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]'); // offline cache

const $ = s=>document.querySelector(s);

/* ===== Utils ===== */
function fmtMoney(n){return (Number(n)||0).toFixed(2)+"‚Ç¨";}
function parseFrNumber(val){if(val==null)return 0;if(typeof val==="number")return val;const s=String(val).replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");const n=parseFloat(s);return isNaN(n)?0:n;}
function normalizeString(s=""){return s.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^A-Za-z0-9\s'-]/g," ").replace(/\s+/g," ").trim().toUpperCase();}
function normalizeDossier(d=""){return d.toString().replace(/\D/g,"").replace(/^0+/,'');}
function fmtDateFR(d){if(!d)return"";const t=new Date(d);return`${String(t.getDate()).padStart(2,'0')}/${String(t.getMonth()+1).padStart(2,'0')}/${t.getFullYear()}`;}
function ensureTabs(name){["recap","compar","non","oui","tous"].forEach(k=>{$('#tab-'+k).classList.toggle('hidden',k!==name);$('#tabBtn-'+k).classList.toggle('active',k===name);});}

/* ===== Upload UI ===== */
$('#btnActes').onclick=()=>$('#actesInput').click();
$('#btnHonos').onclick=()=>$('#honosInput').click();
$('#actesInput').onchange=e=>{for(const f of e.target.files){if(!actesFiles.find(x=>x.name===f.name&&x.size===f.size))actesFiles.push(f);}renderList('actes');ready();};
$('#honosInput').onchange=e=>{for(const f of e.target.files){if(!honosFiles.find(x=>x.name===f.name&&x.size===f.size))honosFiles.push(f);}renderList('honos');ready();};
function renderList(kind){const list=kind==='actes'?$('#listActes'):$('#listHonos');const arr=kind==='actes'?actesFiles:honosFiles;list.innerHTML=arr.map((f,i)=>`<div class="file-pill">${f.name}<button onclick="removeFile('${kind}',${i})">Suppr</button></div>`).join('');}
window.removeFile=(k,i)=>{(k==='actes'?actesFiles:honosFiles).splice(i,1);renderList(k);ready();};
function ready(){ $('#btnAnalyze').disabled=!(actesFiles.length&&honosFiles.length); }
$('#btnReset').onclick=()=>{actesFiles=[];honosFiles=[];actesData=[];honosData=[];reconciledData=[];renderList('actes');renderList('honos');ready();$('#statsBox').innerHTML='';['recap','compar','non','oui','tous'].forEach(k=>$('#tab-'+k).innerHTML='');localStorage.removeItem('recon_v1');};

/* ===== Saisie manuelle (UI + local + cloud) ===== */
function renderManual(){
  const t=$('#mTable');
  if(!manualEntries.length){t.innerHTML='<tr><td class="note">Aucune saisie</td></tr>';return;}
  t.innerHTML='<thead><tr><th>Date</th><th>Nombre</th><th>Action</th></tr></thead><tbody>'+manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(e=>`<tr><td>${e.date}</td><td>${e.count}</td><td><button class="btn secondary" onclick="delManual('${e.date}')">Suppr</button></td></tr>`).join('')+'</tbody>';
}
renderManual();

$('#mAdd').onclick=async()=>{
  const d=$('#mDate').value,c=Number($('#mCount').value||0);
  if(!d) return;
  const i=manualEntries.findIndex(x=>x.date===d);
  if(i>-1) manualEntries[i].count=c; else manualEntries.push({date:d,count:c});
  localStorage.setItem('manualEntries_v1',JSON.stringify(manualEntries));
  renderManual();
  if(reconciledData.length) displayAll();
  const user=window.__fb.auth.currentUser;
  if(user){await upsertManualCloud(user.uid,d,c);}
};

window.delManual = async (date)=>{
  manualEntries = manualEntries.filter(x=>x.date!==date);
  localStorage.setItem('manualEntries_v1',JSON.stringify(manualEntries));
  renderManual();
  if(reconciledData.length) displayAll();
  const user=window.__fb.auth.currentUser;
  if(user){await deleteManualCloud(user.uid,date);}
};

$('#mExport').onclick=()=>{if(!manualEntries.length)return alert("Aucune saisie");const ws=XLSX.utils.json_to_sheet(manualEntries);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'saisie');XLSX.writeFile(wb,'saisie_manuelle.csv');};

/* Cloud helpers for manual */
async function upsertManualCloud(uid,date,count){
  const fb=window.__fb;
  await fb.setDoc(fb.doc(fb.db,'users',uid,'manual_entries',date),{date,count,updatedAt:Date.now()});
}
async function deleteManualCloud(uid,date){
  const fb=window.__fb;
  await fb.deleteDoc(fb.doc(fb.db,'users',uid,'manual_entries',date));
}
function bindManualCloud(uid){
  const fb=window.__fb;
  const q=fb.query(fb.collection(fb.db,'users',uid,'manual_entries'),fb.orderBy('date','asc'));
  fb.onSnapshot(q,snap=>{
    const cloud = snap.docs.map(d=>d.data());
    // merge simple : cloud prioritaire
    const map = new Map(cloud.map(e=>[e.date,e.count]));
    manualEntries.forEach(e=>{ if(!map.has(e.date)) map.set(e.date,e.count); });
    manualEntries = Array.from(map,([date,count])=>({date,count}));
    localStorage.setItem('manualEntries_v1',JSON.stringify(manualEntries));
    renderManual();
    if(reconciledData.length) displayAll();
    $('#cloudManualInfo').textContent = `${cloud.length} entr√©es stock√©es dans le Cloud.`;
  });
}

/* ===== Lectures fichiers ===== */
function excelDateToJSDate(serial){
  if(serial instanceof Date) return new Date(serial.getFullYear(), serial.getMonth(), serial.getDate());
  if(typeof serial==="string"){
    const s=serial.trim(); let m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
    m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]);
    const d=new Date(s); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
  }
  if(!serial && serial!==0) return null;
  const utcDays=Math.floor(serial-25569), utcValue=utcDays*86400; const dt=new Date(utcValue*1000);
  return new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
}
function readExcel(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=e=>{
      try{
        const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const A=XLSX.utils.sheet_to_json(ws,{header:1});
        let hi=-1;
        for(let i=0;i<A.length;i++){
          if(A[i].some(c=>String(c||"").toLowerCase().includes("num√©ro de dossier"))){hi=i;break;}
        }
        if(hi===-1) return reject(new Error("En-t√™te non trouv√© dans Excel (actes)"));
        const headers=A[hi], rows=A.slice(hi+1);
        const out=rows.map(row=>{const o={};headers.forEach((h,i)=>o[h]=row[i]);return o;}).filter(r=>r["Nom"] && (r["Num√©ro de dossier"]||r["Num√©ro de Dossier"]));
        resolve(out);
      }catch(err){reject(err);}
    };
    r.onerror=reject; r.readAsArrayBuffer(file);
  });
}
function readCSV(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file,{encoding:"ISO-8859-1",delimiter:";",skipEmptyLines:true,complete:res=>{
      try{
        if(res.data.length<7) return reject(new Error("CSV honoraires incomplet"));
        const headers=["Praticien","Dossier","Patient","Libell√©","Transfert","Date Acte","Serv.","Coeff.","Pertes","Mt Hors D√©pass.","D√©pass.","Total","Vide"];
        const data=res.data.slice(6).map(row=>{
          if(!row||row.length<6)return null;
          const o={};headers.forEach((h,i)=>o[h]=(row[i]?row[i].replace(/"/g,"").trim():""));
          const d=o["Date Acte"];
          if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)) o["DateFR"]=d;
          else if(/^(\d{4})-(\d{2})-(\d{2})$/.test(d)){const m=d.match(/^(\d{4})-(\d{2})-(\d{2})$/);o["DateFR"]=`${m[3]}/${m[2]}/${m[1]}`;}
          else{const dd=new Date(d);o["DateFR"]=isNaN(dd)?"":fmtDateFR(dd);}
          o["Total"]=parseFrNumber(o["Total"]);
          o["Dossier"]=normalizeDossier(o["Dossier"]);
          o["Patient_norm"]=normalizeString(o["Patient"]);
          return o;
        }).filter(x=>x&&x["Dossier"]&&x["DateFR"]);
        resolve(data);
      }catch(err){reject(err);}
    }, error:reject});
  });
}

/* ===== R√©conciliation ===== */
function reconcile(){
  const honIndex=new Map();
  for(const h of honosData){
    const key=`${h["Dossier"]}|${h["Patient_norm"]}|${h["DateFR"]}`;
    if(!honIndex.has(key)) honIndex.set(key,h);
  }
  reconciledData = actesData.map(a=>{
    const dossier=normalizeDossier(a["Num√©ro de dossier"]||a["Num√©ro de Dossier"]||"");
    const nom=normalizeString(a["Nom"]||"");
    const prenom=normalizeString(a["Pr√©nom"]||a["Prenom"]||"");
    const patientNorm=normalizeString((nom+" "+prenom).trim());
    const d=excelDateToJSDate(a["Date de d√©but"]||a["Date"]);
    const dateFR=fmtDateFR(d);
    const prestation=a["Prestation"]||a["Acte"]||"";
    const montant=parseFrNumber(a["Prix_Unitaire_Coefficient_Quantit√©"]||a["Montant"]||a["Tarif"]);
    const key=`${dossier}|${patientNorm}|${dateFR}`;
    const m=honIndex.get(key);
    return {...a,_DOSSIER_NORM:dossier,Nom_Complet:(nom+" "+prenom).trim(),Patient_norm:patientNorm,Date_FR:dateFR,Prestation:prestation,Montant_num:Number(montant)||0,Factur√©:m?"Oui":"Non",D√©tails_Facture:m?(m["Libell√©"]||""):""};
  });
}

/* ===== R√©sultats ===== */
function displayAll(){
  const total=reconciledData.length;
  const fact=reconciledData.filter(x=>x.Factur√©==="Oui").length;
  const nonf=total-fact;
  const mNon=reconciledData.filter(x=>x.Factur√©==="Non").reduce((s,a)=>s+(a.Montant_num||0),0);
  $('#statsBox').innerHTML=`
    <div class="stat"><div class="v">${total}</div><div>Total actes</div></div>
    <div class="stat"><div class="v">${fact}</div><div>Actes factur√©s</div></div>
    <div class="stat"><div class="v">${nonf}</div><div>Actes non factur√©s</div></div>
    <div class="stat"><div class="v">${fmtMoney(mNon)}</div><div>Montant non factur√©</div></div>
  `;

  const monthly={};
  for(const a of reconciledData){
    const d=a.Date_FR; if(!d) continue; const [jj,mm,yy]=d.split('/');
    const key=`${yy}-${mm}`;
    if(!monthly[key]) monthly[key]={mois:`${["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][+mm-1]} ${yy}`,total:0,f:0,nf:0,mt:0,mf:0,mnf:0};
    const m=a.Montant_num||0; monthly[key].total++; monthly[key].mt+=m; if(a.Factur√©==='Oui'){monthly[key].f++; monthly[key].mf+=m;} else {monthly[key].nf++; monthly[key].mnf+=m;}
  }
  const keys=Object.keys(monthly).sort();
  let h='<table><thead><tr><th>Mois</th><th>Total</th><th>Factur√©s</th><th>Non factur√©s</th><th>Taux</th><th>Montant total</th><th>Montant factur√©</th><th>Montant non factur√©</th></tr></thead><tbody>';
  const tot={t:0,f:0,nf:0,mt:0,mf:0,mnf:0};
  for(const k of keys){const d=monthly[k]; const taux=d.total?(d.f/d.total*100).toFixed(1)+'%':'0%';
    h+=`<tr><td><b>${d.mois}</b></td><td>${d.total}</td><td>${d.f}</td><td>${d.nf}</td><td>${taux}</td><td>${d.mt.toFixed(2)}</td><td>${d.mf.toFixed(2)}</td><td>${d.mnf.toFixed(2)}</td></tr>`;
    tot.t+=d.total; tot.f+=d.f; tot.nf+=d.nf; tot.mt+=d.mt; tot.mf+=d.mf; tot.mnf+=d.mnf;
  }
  const tauxG=tot.t?(tot.f/tot.t*100).toFixed(1)+'%':'0%';
  h+=`<tr style="background:#f9fafc;font-weight:700"><td>TOTAL</td><td>${tot.t}</td><td>${tot.f}</td><td>${tot.nf}</td><td>${tauxG}</td><td>${tot.mt.toFixed(2)}</td><td>${tot.mf.toFixed(2)}</td><td>${tot.mnf.toFixed(2)}</td></tr>`;
  h+='</tbody></table>';
  $('#tab-recap').innerHTML=h;

  const imp={}, man={};
  for(const a of reconciledData){const d=a.Date_FR;if(!d)continue;imp[d]=(imp[d]||0)+1;}
  for(const e of manualEntries){const d=new Date(e.date);if(!isNaN(d)) man[fmtDateFR(d)]=Number(e.count||0);}
  const all=Array.from(new Set([...Object.keys(imp),...Object.keys(man)])).sort((a,b)=>{const [ja,ma,ya]=a.split('/').map(Number);const [jb,mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma!==mb?ma-mb:ja-jb;});
  let hc='<table><thead><tr><th>Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî</th></tr></thead><tbody>';
  for(const d of all){const m=man[d]||0,i=imp[d]||0,e=m-i;const st=e>0?'style="color:#28a745;font-weight:700"':(e<0?'style="color:#e74c3c;font-weight:700"':'');hc+=`<tr><td>${d}</td><td>${m}</td><td>${i}</td><td ${st}>${e>0?'+':''}${e}</td></tr>`;}
  hc+='</tbody></table>'; $('#tab-compar').innerHTML=hc;

  drawList('#tab-non', reconciledData.filter(x=>x.Factur√©==='Non'));
  drawList('#tab-oui',  reconciledData.filter(x=>x.Factur√©==='Oui'));
  drawList('#tab-tous', reconciledData);

  ensureTabs('recap');

  localStorage.setItem('recon_v1', JSON.stringify({ts:Date.now(), reconciledData, manualEntries}));
}
function drawList(sel,data){
  const head=`<thead><tr><th>Date</th><th>Patient</th><th>Dossier</th><th>Prestation</th><th>‚Ç¨</th><th>Statut</th><th>D√©tails</th></tr></thead>`;
  const rows=data.map(r=>`<tr>
    <td>${r.Date_FR||''}</td><td>${r.Nom_Complet||''}</td><td>${r._DOSSIER_NORM||''}</td>
    <td>${r.Prestation||''}</td><td>${(r.Montant_num||0).toFixed(2)}</td><td>${r.Factur√©}</td><td>${r.D√©tails_Facture||''}</td>
  </tr>`).join('');
  $(sel).innerHTML=`<table>${head}<tbody>${rows||'<tr><td colspan="7" class="note">Aucune donn√©e</td></tr>'}</tbody></table>`;
}

/* ===== Analyse ===== */
$('#btnAnalyze').onclick=async()=>{
  try{
    actesData=[]; for(const f of actesFiles){const d=await readExcel(f);actesData=actesData.concat(d);}
    honosData=[]; for(const f of honosFiles){const d=await readCSV(f);  honosData=honosData.concat(d);}
    reconcile(); displayAll();
    const user=window.__fb.auth.currentUser; if(user){await saveMonthlyRecapToFirestore();}
  }catch(e){console.error(e);alert("Erreur d'analyse : "+e.message);}
};

/* ===== Onglets ===== */
["recap","compar","non","oui","tous"].forEach(k=>{$('#tabBtn-'+k).onclick=()=>ensureTabs(k);});

/* ===== Firebase int√©gration ===== */
(function initFirebase(){
  $('#btnLogin').onclick=async()=>{try{await window.__fbSignIn();}catch(e){alert('Connexion impossible : '+e.message);}};
  $('#btnLogout').onclick=async()=>{try{await window.__fbSignOut();}catch(e){alert('D√©connexion : '+e.message);}};
  window.__fbOnAuth(async user=>{
    const on=!!user;
    $('#btnLogin').classList.toggle('hidden',on);
    $('#btnLogout').classList.toggle('hidden',!on);
    $('#btnUploadCloud').disabled=!on;
    $('#cloudCard').style.display=on?'block':'none';
    if(!on) return;
    bindUploadedFiles(user.uid);
    bindRecaps(user.uid);
    bindManualCloud(user.uid);
  });
  $('#btnUploadCloud').onclick=uploadToCloud;
  $('#btnAddSelected').onclick=addSelectedCloudToAnalysis;
})();

/* ===== Storage uploads + rechargement depuis Cloud ===== */
async function uploadToCloud(){
  const user=window.__fb.auth.currentUser;if(!user)return alert('Connecte-toi');
  const uploads=[...actesFiles.map(f=>({f,kind:'actes'})),...honosFiles.map(f=>({f,kind:'honoraires'}))];
  if(!uploads.length) return alert("Aucun fichier s√©lectionn√©");
  for(const u of uploads){
    const path=`users/${user.uid}/${u.kind}/${Date.now()}_${u.f.name}`;
    const ref=window.__fb.stRef(window.__fb.st,path);
    await window.__fb.uploadBytes(ref,u.f);
    const url=await window.__fb.getDownloadURL(ref);
    await window.__fb.setDoc(window.__fb.doc(window.__fb.db,'users',user.uid,'uploads',path),{kind:u.kind,filename:u.f.name,path,url,uploadedAt:Date.now()});
  }
  alert('Upload termin√© ‚úÖ');
}
function bindUploadedFiles(uid){
  const q=window.__fb.query(window.__fb.collection(window.__fb.db,'users',uid,'uploads'),window.__fb.orderBy('uploadedAt','desc'));
  window.__fb.onSnapshot(q,snap=>{
    const arr=snap.docs.map(d=>d.data());
    $('#cloudFiles').innerHTML = arr.map((r,i)=>`
      <div class="cloud-item">
        <label>
          <input type="checkbox" class="cloud-check" data-kind="${r.kind}" data-url="${r.url}" data-filename="${r.filename}">
          <div>
            <div><span class="cloud-kind">${r.kind==='actes'?'üìä Actes':'üí∞ Honoraires'}</span></div>
            <div>${r.filename}</div>
            <a class="file-link" href="${r.url}" target="_blank">Ouvrir</a>
          </div>
        </label>
      </div>
    `).join('') || '<div class="note">Aucun fichier pour le moment.</div>';
  });
}
async function addSelectedCloudToAnalysis(){
  const checks=[...document.querySelectorAll('.cloud-check:checked')];
  if(!checks.length) return alert("S√©lectionne au moins un fichier Cloud.");
  for(const c of checks){
    const {kind,url,filename}=c.dataset;
    const res = await fetch(url);
    const blob = await res.blob();
    const file = new File([blob], filename, {type: blob.type});
    if(kind==='actes'){actesFiles.push(file);} else {honosFiles.push(file);}
  }
  renderList('actes'); renderList('honos'); ready();
  alert("Fichiers ajout√©s √† l‚Äôanalyse depuis le Cloud ‚úÖ");
}

/* ===== Firestore recaps ===== */
async function saveMonthlyRecapToFirestore(){
  const fb=window.__fb;const user=fb.auth.currentUser;if(!user)return;
  const monthly={};
  for(const a of reconciledData){
    const d=a.Date_FR; if(!d) continue; const [jj,mm,yy]=d.split('/');
    const key=`${yy}-${mm}`;
    if(!monthly[key]) monthly[key]={month:key,total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0};
    const m=a.Montant_num||0; monthly[key].total++; monthly[key].montantTotal+=m;
    if(a.Factur√©==='Oui'){monthly[key].factures++; monthly[key].montantFacture+=m;} else {monthly[key].nonFactures++; monthly[key].montantNonFacture+=m;}
  }
  for(const [k,v] of Object.entries(monthly)){await fb.setDoc(fb.doc(fb.db,'users',user.uid,'reconciliations',k),{...v,updatedAt:Date.now()});}
}
function bindRecaps(uid){
  const q=window.__fb.query(window.__fb.collection(window.__fb.db,'users',uid,'reconciliations'),window.__fb.orderBy('month','desc'));
  window.__fb.onSnapshot(q,snap=>{
    const arr=snap.docs.map(d=>d.data());
    $('#recapList').innerHTML=arr.map(r=>{
      const taux=r.total?(r.factures/r.total*100).toFixed(1):'0';
      const dt=new Date(r.updatedAt||Date.now());
      return `<div class="card"><div><b>${r.month}</b> ‚Äî taux ${taux}%</div>
        <div class="note">MAJ le ${dt.toLocaleDateString('fr-FR')}</div>
        <div>Total: ${r.total} | Factur√©s: ${r.factures} | Non factur√©s: ${r.nonFactures}</div>
        <div>‚Ç¨ Total: ${r.montantTotal.toFixed(2)} | ‚Ç¨ Factur√©: ${r.montantFacture.toFixed(2)} | ‚Ç¨ Non factur√©: ${r.montantNonFacture.toFixed(2)}</div>
      </div>`;
    }).join('')||'<div class="note">Aucun r√©cap sauvegard√©</div>';
  });
}

/* ===== Restauration locale au chargement ===== */
(function restoreLocal(){
  try{
    const raw=localStorage.getItem('recon_v1');
    if(!raw) return;
    const saved=JSON.parse(raw);
    if(saved && Array.isArray(saved.reconciledData)){
      reconciledData = saved.reconciledData;
      displayAll();
    }
  }catch(e){console.warn('Restauration locale ignor√©e :',e);}
})();
</script>
</body>
</html>
