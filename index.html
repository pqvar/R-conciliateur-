<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>R√©conciliation des Actes M√©dicaux</title>

  <!-- Librairies c√¥t√© client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

  <!-- Styles -->
  <style>
    :root{--violet:#6b5cff;--violet2:#5b4bd8;--bg:#f3f4f8}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    .shell{max-width:1180px;margin:24px auto;background:#fff;border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:22px 28px;display:flex;align-items:center;justify-content:space-between}
    .header h1{margin:0;font-size:22px;font-weight:700}
    .content{padding:24px}
    .card{background:#fff;border:1px solid #e7e7ef;border-radius:12px;padding:16px;margin:14px 0}
    .section-title{display:flex;gap:8px;align-items:center;font-weight:700;margin:6px 0 12px 0}
    .btn{appearance:none;border:0;border-radius:10px;background:var(--violet);color:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6c757d} .btn.ghost{background:#f0f1ff;color:#3d33b7} .btn.small{padding:8px 10px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .file-btn{display:inline-block;border:2px dashed var(--violet);border-radius:10px;padding:10px 14px;color:var(--violet);font-weight:700;background:#fff;cursor:pointer}
    .file-list{margin-top:10px}
    .file-pill{display:flex;justify-content:space-between;align-items:center;background:#f6f7ff;border:1px solid #e1e3ff;border-radius:10px;padding:8px 10px;margin-top:8px}
    .file-pill .x{background:#ff6b6b;color:#fff;border:0;border-radius:6px;padding:4px 6px;cursor:pointer}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    input,select{width:100%;padding:9px 10px;border:1px solid #dfe3f0;border-radius:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#f3f4ff;color:#463ab8;position:sticky;top:0}
    .stat{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;padding:12px;text-align:center}
    .stat .v{font-size:26px;font-weight:800}
    .note{color:#666;font-size:12px}
    .tabbar .btn{background:#eef0ff;color:#3c31b7} .tabbar .btn.active{background:var(--violet2);color:#fff}
    .hidden{display:none}
    .right{margin-left:auto}
    .tag{display:inline-block;background:#eef1ff;color:#3b36a8;border-radius:8px;padding:4px 8px;font-size:12px;font-weight:700}
  </style>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      getRedirectResult, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, collection, getDocs, onSnapshot,
      query, orderBy, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import {
      getStorage, ref as stRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

    /* ========= CONFIG DE TON PROJET (ins√©r√©e) ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyDcP7Cuvbkvmcr_mq7E_nHuxjSmDWK08-4",
      authDomain: "reconciliateur-50684.firebaseapp.com",
      projectId: "reconciliateur-50684",
      storageBucket: "reconciliateur-50684.firebasestorage.app",
      appId: "1:1029928449677:web:7445402f84a963d3ab54c4",
      measurementId: "G-STE125RQPZ"
    };
    /* =================================================== */

    // Contexte global
    window.__fb = { enabled:false };

    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);
      const st   = getStorage(app);
      const provider = new GoogleAuthProvider();
      window.__fb = { enabled:true, app, auth, db, st, provider };
    } catch (e) {
      console.warn("Firebase non initialis√©:", e);
      window.__fb = { enabled:false };
    }

    // ---------- AUTH UI ----------
    window.__initAuthUI = function initAuthUI() {
      const fb = window.__fb;
      const btnLogin  = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');
      const hostTag   = document.getElementById('hostTag');
      const uploadBtn = document.getElementById('btnUploadCloud');
      const histCard  = document.getElementById('histCard');

      if (!fb.enabled) {
        hostTag.textContent = "Mode local (sans cloud)";
        btnLogin.classList.add('hidden');
        btnLogout.classList.add('hidden');
        uploadBtn.disabled = true;
        histCard.style.display = "none";
        return;
      }
      hostTag.textContent = "Cloud actif (Auth ‚Ä¢ Firestore ‚Ä¢ Storage)";

      btnLogin.onclick = async () => {
        try { await signInWithPopup(fb.auth, fb.provider); }
        catch { await signInWithRedirect(fb.auth, fb.provider); }
      };
      btnLogout.onclick = () => signOut(fb.auth);
      getRedirectResult(fb.auth).catch(()=>{});

      onAuthStateChanged(fb.auth, async (user) => {
        const isOn = !!user;
        btnLogin.classList.toggle('hidden', isOn);
        btnLogout.classList.toggle('hidden', !isOn);
        uploadBtn.disabled = !isOn;
        histCard.style.display = isOn ? "block" : "none";
        if (isOn) {
          await window.__syncManualEntriesFromLocalToCloud(user.uid);
          window.__bindHistorique(user.uid);
        } else {
          document.getElementById('histList').innerHTML = '';
        }
      });
    };

    // ---------- SAISIE MANUELLE : sync locale -> cloud + √©coute cloud ----------
    window.__syncManualEntriesFromLocalToCloud = async function(uid) {
      const fb = window.__fb; if (!fb.enabled) return;
      const local = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]'); // [{date,count}]
      if (local.length) {
        const batch = writeBatch(fb.db);
        for (const e of local) {
          const ref = doc(fb.db, "users", uid, "manual_entries", e.date);
          batch.set(ref, { date:e.date, count:Number(e.count)||0, updatedAt: Date.now() });
        }
        await batch.commit();
      }
      const qy = query(collection(fb.db, "users", uid, "manual_entries"));
      onSnapshot(qy, (snap) => {
        const arr = snap.docs.map(d => d.data()).sort((a,b)=>a.date.localeCompare(b.date));
        localStorage.setItem('manualEntries_v1', JSON.stringify(arr));
        if (window.renderManualTable) window.renderManualTable();
        if (window.displayCompar) window.displayCompar();
        if (window.displayMonthly) window.displayMonthly();
      });
    };

    // ---------- HISTORIQUE DES R√âCONCILIATIONS ----------
    window.__bindHistorique = function(uid) {
      const fb = window.__fb; if (!fb.enabled) return;
      const qy = query(collection(fb.db, "users", uid, "reconciliations"), orderBy("month","desc"));
      onSnapshot(qy, (snap) => {
        const arr = snap.docs.map(d=>d.data());
        const box = document.getElementById('histList');
        if (!arr.length) { box.innerHTML = '<div class="note">Aucune analyse sauvegard√©e</div>'; return; }
        box.innerHTML = arr.map(r=>{
          const taux = r.total ? (r.factures/r.total*100).toFixed(1) : '0';
          const dt = new Date(r.updatedAt||Date.now());
          return `<div class="card">
            <div class="section-title">üìÖ ${r.month}</div>
            <div class="note">Analys√© le ${dt.toLocaleDateString('fr-FR')}</div>
            <div class="grid" style="margin-top:8px">
              <div class="stat"><div class="v">${r.total}</div><div>Total</div></div>
              <div class="stat"><div class="v">${taux}%</div><div>Taux fact.</div></div>
              <div class="stat"><div class="v">${(Number(r.montantTotal)||0).toFixed(2)}‚Ç¨</div><div>Montant</div></div>
            </div>
          </div>`;
        }).join('');
      });
    };

    // ---------- STORAGE : upload multiples ----------
    window.__uploadSelectedFiles = async function() {
      const fb = window.__fb; if (!fb.enabled) return alert("Connecte-toi pour uploader");
      const user = fb.auth.currentUser; if (!user) return alert("Connecte-toi pour uploader");
      const uploads = [
        ...window.__actesFiles.map(f=>({f, folder:"actes"})),
        ...window.__honosFiles.map(f=>({f, folder:"honoraires"})),
      ];
      if (!uploads.length) return alert("Aucun fichier s√©lectionn√©");
      try {
        for (const u of uploads) {
          const path = `users/${user.uid}/${u.folder}/${Date.now()}_${u.f.name}`;
          const ref  = stRef(fb.st, path);
          await uploadBytes(ref, u.f);
          const url = await getDownloadURL(ref);
          const upRef = doc(fb.db, "users", user.uid, "uploads", `${u.folder}_${Date.now()}`);
          await setDoc(upRef, { kind:u.folder, filename:u.f.name, path, url, uploadedAt: Date.now() });
        }
        alert("Upload termin√© ‚úÖ");
      } catch(e) {
        alert("Upload √©chou√© : "+e.message);
      }
    };

    // ---------- FIRESTORE : sauvegarde r√©conciliations (r√©sum√© + d√©tails chunk√©s) ----------
    window.__saveReconciliationToFirestore = async function(monthlyMap, reconciledRows) {
      const fb = window.__fb; if (!fb.enabled) return;
      const user = fb.auth.currentUser; if (!user) return;

      // (1) Sauvegarde des r√©sum√©s mensuels (un doc par YYYY-MM)
      const batch = writeBatch(fb.db);
      for (const [k,v] of Object.entries(monthlyMap)) {
        const ref = doc(fb.db, "users", user.uid, "reconciliations", k);
        batch.set(ref, { ...v, updatedAt: Date.now() });
      }
      await batch.commit();

      // (2) D√©tails : regrouper par mois -> sous-collection details/{chunkN}
      const byMonth = {};
      for (const r of reconciledRows) {
        const date = r.Date_Formatee;
        if (!date) continue;
        const [jj, mm, yy] = date.split('/');
        const key = `${yy}-${mm}`;
        (byMonth[key] ||= []).push({
          date: r.Date_Formatee,
          dossier: r._DOSSIER_NORM || "",
          patient: r.Nom_Complet || "",
          prestation: r.Prestation || "",
          montant: Number(r.Montant_num||0),
          facture: r.Factur√© || "",
          details: r.D√©tails_Facture || ""
        });
      }

      for (const [monthKey, rows] of Object.entries(byMonth)) {
        // purge ancienne sous-collection (optionnel pour garder un seul √©tat)
        const detailsCol = collection(fb.db, "users", user.uid, "reconciliations", monthKey, "details");
        const old = await getDocs(detailsCol);
        if (!old.empty) {
          const purge = writeBatch(fb.db);
          old.forEach(d => purge.delete(d.ref));
          await purge.commit();
        }

        // Chunk : 400 √©l√©ments par doc (limite s√©curit√© √©criture)
        const chunkSize = 400;
        let part = 0;
        for (let i=0; i<rows.length; i+=chunkSize) {
          const slice = rows.slice(i, i+chunkSize);
          const ref = doc(fb.db, "users", user.uid, "reconciliations", monthKey, "details", `part_${String(++part).padStart(3,'0')}`);
          await setDoc(ref, { part, rows: slice, updatedAt: Date.now() });
        }
      }
    };
  </script>
</head>
<body>
  <div class="shell">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <div class="row" id="authArea">
        <span class="tag" id="hostTag">Initialisation‚Ä¶</span>
        <button class="btn ghost small" id="btnLogin">Se connecter Google</button>
        <button class="btn secondary small hidden" id="btnLogout">D√©connexion</button>
      </div>
    </div>

    <div class="content">
      <!-- Upload -->
      <div class="card">
        <div class="section-title">üìÅ Chargement des fichiers</div>
        <div class="note">Ajoutez un ou plusieurs fichiers, puis lancez l‚Äôanalyse.</div>
        <div class="row" style="margin:10px 0">
          <input type="file" id="actesInput" accept=".xlsx,.xls" multiple class="hidden">
          <button class="file-btn" id="btnActes">üìä Ajouter fichier Excel (actes)</button>

          <input type="file" id="honosInput" accept=".csv" multiple class="hidden">
          <button class="file-btn" id="btnHonos">üí∞ Ajouter fichier CSV (honoraires)</button>

          <button class="btn right" id="btnAnalyze" disabled>üîç Analyser & r√©concilier</button>
          <button class="btn secondary" id="btnReset">üîÑ R√©initialiser</button>
          <button class="btn secondary" id="btnUploadCloud" disabled title="Disponible connect√©">‚òÅÔ∏è Uploader vers Storage</button>
        </div>

        <div class="file-list" id="listActes"></div>
        <div class="file-list" id="listHonos"></div>
      </div>

      <!-- Saisie manuelle -->
      <div class="card">
        <div class="section-title">‚úçÔ∏è Saisie manuelle quotidienne (comparatif)</div>
        <div class="grid">
          <div><div class="note">Date</div><input id="mDate" type="date"></div>
          <div><div class="note">Nombre d'actes</div><input id="mCount" type="number" min="0" step="1" placeholder="0"></div>
          <div style="align-self:end"><button class="btn" id="mAdd">‚ûï Ajouter</button></div>
          <div style="align-self:end"><button class="btn secondary" id="mExport">üì• Exporter la saisie (CSV)</button></div>
        </div>
        <table id="mTable"></table>
      </div>

      <!-- R√©sultats -->
      <div class="card">
        <div class="section-title">üìà R√©sultats</div>
        <div class="grid" id="statsBox"></div>

        <div class="row tabbar" style="margin:12px 0">
          <button class="btn" data-tab="recap" id="tabBtn-recap">üìä R√©capitulatif Mensuel</button>
          <button class="btn" data-tab="compar" id="tabBtn-compar">üìà Comparaison quotidienne</button>
          <button class="btn" data-tab="non" id="tabBtn-non">‚ùå Actes non factur√©s</button>
          <button class="btn" data-tab="oui" id="tabBtn-oui">‚úÖ Actes factur√©s</button>
          <button class="btn" data-tab="tous" id="tabBtn-tous">üìã Tous les actes</button>
          <span class="right"></span>
          <button class="btn secondary" id="btnExportRecap">Exporter R√©cap (Excel)</button>
          <button class="btn secondary" id="btnExportCompar">Exporter Comparaison (Excel)</button>
        </div>

        <div id="tab-recap"></div>
        <div id="tab-compar" class="hidden"></div>
        <div id="tab-non" class="hidden"></div>
        <div id="tab-oui" class="hidden"></div>
        <div id="tab-tous" class="hidden"></div>
      </div>

      <!-- Historique Firestore (si connect√©) -->
      <div class="card" id="histCard" style="display:none">
        <div class="section-title">üìú Historique des analyses (Firestore)</div>
        <div id="histList" class="grid"></div>
      </div>
    </div>
  </div>

  <!-- Script principal (non module) -->
  <script>
  // Firebase UI
  window.addEventListener('DOMContentLoaded', ()=>{
    if (window.__initAuthUI) window.__initAuthUI();
  });

  // ====== √âTAT ======
  window.__actesFiles = []; window.__honosFiles = [];
  let actesData=[], honosData=[], reconciledData=[];
  let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]');

  // ====== UTIL ======
  const $ = sel => document.querySelector(sel);
  function fmtMoney(n){ return (Number(n)||0).toFixed(2)+"‚Ç¨"; }
  function normalizeString(s=""){ return s.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^A-Za-z0-9\\s'-]/g," ").replace(/\\s+/g," ").trim().toUpperCase(); }
  function normalizeDossier(d=""){ return d.toString().replace(/\\D/g,"").replace(/^0+/,''); }
  function parseFrNumber(val){ if(val==null) return 0; if(typeof val==="number") return val; const s=String(val).replace(/\\s/g,"").replace(/\\./g,"").replace(/,/g,"."); const n=parseFloat(s); return isNaN(n)?0:n; }
  function excelDateToJSDate(serial){
    if(serial instanceof Date) return new Date(serial.getFullYear(), serial.getMonth(), serial.getDate());
    if(typeof serial==="string"){
      const s=serial.trim(); let m=s.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
      m=s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]);
      const d=new Date(s); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
    }
    if(!serial && serial!==0) return null;
    const utcDays=Math.floor(serial-25569), utcValue=utcDays*86400; const dt=new Date(utcValue*1000);
    return new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
  }
  function fmtDate(d){ if(!d) return ""; const t=new Date(d); if(isNaN(t)) return ""; return \`\${String(t.getDate()).padStart(2,'0')}/\${String(t.getMonth()+1).padStart(2,'0')}/\${t.getFullYear()}\`; }
  function ensureTabs(name){
    ["recap","compar","non","oui","tous"].forEach(k=>{
      $('#tab-'+k).classList.toggle('hidden', k!==name);
      $('#tabBtn-'+k).classList.toggle('active', k===name);
    });
  }

  // ====== UI : Uploads ======
  $('#btnActes').onclick = ()=> $('#actesInput').click();
  $('#btnHonos').onclick = ()=> $('#honosInput').click();
  $('#actesInput').onchange = (e)=>{
    for(const f of Array.from(e.target.files)){ if(!window.__actesFiles.find(x=>x.name===f.name&&x.size===f.size)) window.__actesFiles.push(f); }
    renderFileList('actes'); checkReady(); e.target.value="";
  };
  $('#honosInput').onchange = (e)=>{
    for(const f of Array.from(e.target.files)){ if(!window.__honosFiles.find(x=>x.name===f.name&&x.size===f.size)) window.__honosFiles.push(f); }
    renderFileList('honos'); checkReady(); e.target.value="";
  };
  function renderFileList(kind){
    const list = kind==='actes' ? $('#listActes') : $('#listHonos');
    const arr  = kind==='actes' ? window.__actesFiles : window.__honosFiles;
    list.innerHTML = arr.map((f,i)=>\`
      <div class="file-pill">
        <div>\${kind==='actes'?'üìä':'üí∞'} \${f.name} <span class="note">(\${(f.size/1024).toFixed(1)} KB)</span></div>
        <button class="x" onclick="removeFile('\${kind}',\${i})">Suppr</button>
      </div>\`).join('');
  }
  window.removeFile = (kind, idx)=>{
    if(kind==='actes') window.__actesFiles.splice(idx,1); else window.__honosFiles.splice(idx,1);
    renderFileList(kind); checkReady();
  };
  function checkReady(){ $('#btnAnalyze').disabled = !(window.__actesFiles.length && window.__honosFiles.length); }

  $('#btnReset').onclick = ()=>{
    window.__actesFiles=[]; window.__honosFiles=[]; actesData=[]; honosData=[]; reconciledData=[];
    renderFileList('actes'); renderFileList('honos'); checkReady();
    $('#statsBox').innerHTML=''; ['recap','compar','non','oui','tous'].forEach(k=>$('#tab-'+k).innerHTML='');
  };

  // ====== Saisie manuelle ======
  window.renderManualTable = function(){
    const t=$('#mTable');
    if(!manualEntries.length){ t.innerHTML='<thead><tr><th>Date</th><th>Nombre</th><th></th></tr></thead><tbody><tr><td colspan="3" class="note">Aucune saisie</td></tr></tbody>'; return; }
    const rows = manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(e=>\`
      <tr><td>\${e.date}</td><td>\${e.count}</td><td><button class="x" onclick="delManual('\${e.date}')">Suppr</button></td></tr>\`).join('');
    t.innerHTML=\`<thead><tr><th>Date</th><th>Nombre</th><th>Action</th></tr></thead><tbody>\${rows}</tbody>\`;
  }
  $('#mAdd').onclick = async ()=>{
    const d=$('#mDate').value, c=Number($('#mCount').value||0);
    if(!d) return alert("Choisis une date");
    if(c<0) return alert("Nombre invalide");
    const i=manualEntries.findIndex(x=>x.date===d);
    if(i>-1) manualEntries[i].count=c; else manualEntries.push({date:d,count:c});
    localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
    // Si connect√© : synchro imm√©diate (la subscription onSnapshot re-rendra la table)
    try{
      if(window.__fb?.enabled && window.__fb.auth?.currentUser){
        const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
        const ref = doc(window.__fb.db, "users", window.__fb.auth.currentUser.uid, "manual_entries", d);
        await setDoc(ref, { date:d, count:c, updatedAt: Date.now()});
      }
    }catch(_){}
    renderManualTable();
    if(reconciledData.length){ displayAll(); }
  };
  window.delManual = async (date)=>{
    manualEntries = manualEntries.filter(x=>x.date!==date);
    localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
    try{
      if(window.__fb?.enabled && window.__fb.auth?.currentUser){
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
        const ref = doc(window.__fb.db, "users", window.__fb.auth.currentUser.uid, "manual_entries", date);
        await deleteDoc(ref);
      }
    }catch(_){}
    renderManualTable();
    if(reconciledData.length){ displayAll(); }
  };
  $('#mExport').onclick = ()=>{
    if(!manualEntries.length) return alert("Aucune saisie");
    const rows=[["Date","Nombre d'actes"]].concat(manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(x=>[x.date,x.count]));
    const ws=XLSX.utils.aoa_to_sheet(rows), wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Saisie'); XLSX.writeFile(wb, 'saisie_manuelle.csv');
  };
  renderManualTable();

  // ====== Analyse ======
  $('#btnAnalyze').onclick = analyze;
  $('#btnUploadCloud').onclick = ()=> window.__uploadSelectedFiles && window.__uploadSelectedFiles();

  async function analyze(){
    try{
      actesData=[]; for(const f of window.__actesFiles){ const d=await readExcel(f); actesData=actesData.concat(d); }
      honosData=[]; for(const f of window.__honosFiles){ const d=await readCSV(f);   honosData=honosData.concat(d); }
      reconcile();
      displayAll();
      // Sauvegardes cloud si connect√©
      if(window.__fb?.enabled && window.__fb.auth?.currentUser){
        const monthlyMap = buildMonthlyMap(reconciledData);
        await window.__saveReconciliationToFirestore(monthlyMap, reconciledData);
      }
    }catch(e){ console.error(e); alert("Erreur d'analyse : "+e.message); }
  }

  function readExcel(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload = e=>{
        try{
          const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const A  = XLSX.utils.sheet_to_json(ws, {header:1});
          let hi=-1;
          for(let i=0;i<A.length;i++){
            if(A[i].some(c=>String(c||"").toLowerCase().includes("num√©ro de dossier"))){ hi=i; break; }
          }
          if(hi===-1) return reject(new Error("En-t√™te non trouv√© dans Excel actes"));
          const headers=A[hi], rows=A.slice(hi+1);
          const out = rows.map((row)=>{
            const o={}; headers.forEach((h,i)=>o[h]=row[i]); return o;
          }).filter(r=>r["Nom"] && r["Num√©ro de dossier"]);
          resolve(out);
        }catch(err){ reject(err); }
      };
      r.onerror = reject; r.readAsArrayBuffer(file);
    });
  }

  function readCSV(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{encoding:"ISO-8859-1",delimiter:";",skipEmptyLines:true,complete:res=>{
        try{
          if(res.data.length<7) return reject(new Error("CSV honoraires incomplet"));
          const headers=["Praticien","Dossier","Patient","Libell√©","Transfert","Date Acte","Serv.","Coeff.","Pertes","Mt Hors D√©pass.","D√©pass.","Total","Vide"];
          const data=res.data.slice(6).map(row=>{
            if(!row || row.length<6) return null;
            const o={}; headers.forEach((h,i)=>o[h]=(row[i]?row[i].replace(/\"/g,"").trim():""));
            o["Date Acte"]=normalizeDateString(o["Date Acte"]);
            o["Total"]=parseFrNumber(o["Total"]);
            o["Dossier"]=normalizeDossier(o["Dossier"]);
            o["Patient_norm"]=normalizeString(o["Patient"]);
            return o;
          }).filter(x=>x && x["Dossier"] && x["Date Acte"]);
          resolve(data);
        }catch(err){ reject(err); }
      }, error:reject});
    });
  }
  function normalizeDateString(s){
    if(!s) return "";
    const t=String(s).trim();
    if(/^\\d{2}\\/\\d{2}\\/\\d{4}$/.test(t)) return t;
    let m=t.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/); if(m) return \`\${m[3]}/\${m[2]}/\${m[1]}\`;
    const d=new Date(t); return isNaN(d)?t:fmtDate(d);
  }

  function reconcile(){
    const honIndex=new Map();
    for(const h of honosData){
      const key=\`\${h["Dossier"]}|\\\${h["Patient_norm"]}|\\\${h["Date Acte"]}\`;
      if(!honIndex.has(key)) honIndex.set(key,h);
    }
    reconciledData = actesData.map(a=>{
      const dossier=normalizeDossier(a["Num√©ro de dossier"]||a["Num√©ro de Dossier"]||"");
      const nom=normalizeString(a["Nom"]||"");
      const prenom=normalizeString(a["Pr√©nom"]||a["Prenom"]||"");
      const patientNorm = normalizeString((nom+" "+prenom).trim());
      const d=excelDateToJSDate(a["Date de d√©but"]||a["Date"]);
      const dateFmt=fmtDate(d);
      const prestation=a["Prestation"]||a["Acte"]||"";
      const montant=parseFrNumber(a["Prix_Unitaire_Coefficient_Quantit√©"]||a["Montant"]||a["Tarif"]);
      const key=\`\${dossier}|\\\${patientNorm}|\\\${dateFmt}\`;
      const m=honIndex.get(key);
      return {...a,_DOSSIER_NORM:dossier,Nom_Complet:(nom+" "+prenom).trim(),Patient_norm:patientNorm,Date_Formatee:dateFmt,Prestation:prestation,Montant_num:Number(montant)||0,Factur√©: m?"Oui":"Non",D√©tails_Facture: m?(m["Libell√©"]||""): ""};
    });
  }

  function buildMonthlyMap(rows){
    const monthly={};
    for(const a of rows){
      const d=a.Date_Formatee; if(!d) continue; const [jj,mm,yy]=d.split('/');
      const key=\`\${yy}-\${mm}\`;
      if(!monthly[key]) monthly[key]={month:key,total:0,factures:0,nonFactures:0, montantTotal:0,montantFacture:0, montantNonFacture:0};
      const m=a.Montant_num||0; monthly[key].total++; monthly[key].montantTotal+=m;
      if(a.Factur√©==='Oui'){ monthly[key].factures++; monthly[key].montantFacture+=m; } else { monthly[key].nonFactures++; monthly[key].montantNonFacture+=m; }
    }
    return monthly;
  }

  // ====== Affichages ======
  function displayAll(){
    // Stats
    const total=reconciledData.length;
    const fact=reconciledData.filter(x=>x.Factur√©==="Oui").length;
    const nonf=total-fact;
    const mNon=reconciledData.filter(x=>x.Factur√©==="Non").reduce((s,a)=>s+(a.Montant_num||0),0);
    $('#statsBox').innerHTML = \`
      <div class="stat"><div class="v">\${total}</div><div>Total actes</div></div>
      <div class="stat"><div class="v">\${fact}</div><div>Actes factur√©s</div></div>
      <div class="stat"><div class="v">\${nonf}</div><div>Actes non factur√©s</div></div>
      <div class="stat"><div class="v">\${fmtMoney(mNon)}</div><div>Montant non factur√©</div></div>
    \`;

    // Onglets
    displayMonthly();
    displayCompar();
    displayList('non', reconciledData.filter(x=>x.Factur√©==='Non'));
    displayList('oui', reconciledData.filter(x=>x.Factur√©==='Oui'));
    displayList('tous', reconciledData);

    ensureTabs('recap');
  }

  function displayList(tab, data){
    const head = \`<thead><tr><th>Date</th><th>Nom Patient</th><th>Dossier</th><th>Prestation</th><th>‚Ç¨</th><th>Statut</th><th>D√©tails</th></tr></thead>\`;
    const rows = data.map(r=>\`<tr>
      <td>\${r.Date_Formatee||''}</td><td>\${r.Nom_Complet||''}</td><td>\${r._DOSSIER_NORM||''}</td>
      <td>\${r.Prestation||''}</td><td>\${(r.Montant_num||0).toFixed(2)}</td><td>\${r.Factur√©}</td><td>\${r.D√©tails_Facture||''}</td>
    </tr>\`).join('');
    $('#tab-'+tab).innerHTML = \`<table>\${head}<tbody>\${rows||'<tr><td colspan="7" class="note">Aucune donn√©e</td></tr>'}</tbody></table>\`;
  }

  window.displayMonthly = function(){
    const monthly={};
    for(const a of reconciledData){
      const d=a.Date_Formatee; if(!d) continue; const [jj,mm,yy]=d.split('/');
      if(!monthly[\`\${mm}/\${yy}\`]) monthly[\`\${mm}/\${yy}\`]={ name:\`\${["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][+mm-1]} \${yy}\`, total:0,f:0,nf:0,mt:0,mf:0,mnf:0 };
      const m=a.Montant_num||0; monthly[\`\${mm}/\${yy}\`].total++; monthly[\`\${mm}/\${yy}\`].mt+=m; if(a.Factur√©==='Oui'){ monthly[\`\${mm}/\${yy}\`].f++; monthly[\`\${mm}/\${yy}\`].mf+=m; } else { monthly[\`\${mm}/\${yy}\`].nf++; monthly[\`\${mm}/\${yy}\`].mnf+=m; }
    }
    const keys=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number);const [mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma-mb;});
    if(!keys.length){ $('#tab-recap').innerHTML='<div class="note">Aucune donn√©e mensuelle</div>'; return; }
    let html = '<table><thead><tr><th>Mois</th><th>Total</th><th>Factur√©s</th><th>Non factur√©s</th><th>Taux</th><th>Montant total</th><th>Montant factur√©</th><th>Montant non factur√©</th></tr></thead><tbody>';
    const tot={t:0,f:0,nf:0,mt:0,mf:0,mnf:0};
    for(const k of keys){
      const d=monthly[k], taux=d.total?(d.f/d.total*100).toFixed(1)+'%':'0%';
      html += \`<tr><td><strong>\${d.name}</strong></td><td>\${d.total}</td><td>\${d.f}</td><td>\${d.nf}</td><td>\${taux}</td><td>\${d.mt.toFixed(2)}</td><td>\${d.mf.toFixed(2)}</td><td>\${d.mnf.toFixed(2)}</td></tr>\`;
      tot.t+=d.total; tot.f+=d.f; tot.nf+=d.nf; tot.mt+=d.mt; tot.mf+=d.mf; tot.mnf+=d.mnf;
    }
    const tauxG = tot.t?(tot.f/tot.t*100).toFixed(1)+'%':'0%';
    html += \`<tr style="background:#f8f9fa;font-weight:700"><td>TOTAL</td><td>\${tot.t}</td><td>\${tot.f}</td><td>\${tot.nf}</td><td>\${tauxG}</td><td>\${tot.mt.toFixed(2)}</td><td>\${tot.mf.toFixed(2)}</td><td>\${tot.mnf.toFixed(2)}</td></tr>\`;
    html += '</tbody></table>';
    $('#tab-recap').innerHTML = html;
  }

  window.displayCompar = function(){
    const imp={}; for(const a of reconciledData){ const d=a.Date_Formatee; if(!d) continue; imp[d]=(imp[d]||0)+1; }
    const man={}; for(const e of manualEntries){ const d=new Date(e.date); if(!isNaN(d)) man[fmtDate(d)]=Number(e.count||0); }
    const all = Array.from(new Set([...Object.keys(imp),...Object.keys(man)])).sort((a,b)=>{const [ja,ma,ya]=a.split('/').map(Number);const [jb,mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma!==mb?ma-mb:ja-jb;});
    if(!all.length){ $('#tab-compar').innerHTML='<div class="note">Aucune donn√©e de comparaison</div>'; return; }
    let h='<table><thead><tr><th>Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî (Manuel - Import√©)</th></tr></thead><tbody>';
    for(const d of all){
      const m=man[d]||0, i=imp[d]||0, e=m-i;
      const st = e>0?'style="color:#28a745;font-weight:700"':(e<0?'style="color:#e74c3c;font-weight:700"':'');
      h += \`<tr><td>\${d}</td><td>\${m}</td><td>\${i}</td><td \${st}>\${e>0?'+':''}\${e}</td></tr>\`;
    }
    h+='</tbody></table>'; $('#tab-compar').innerHTML=h;
  }

  // Onglets click
  ["recap","compar","non","oui","tous"].forEach(t=>{
    $('#tabBtn-'+t).onclick = ()=> ensureTabs(t);
  });

  // Exports
  $('#btnExportRecap').onclick = ()=>{
    const monthly=buildMonthlyMap(reconciledData);
    const keys=Object.keys(monthly).sort();
    const out = keys.map(k=>{
      const d=monthly[k]; const taux=d.total?(d.factures/d.total*100).toFixed(1)+'%':'0%';
      return {"Mois":d.month,"Total Actes":d.total,"Actes Factur√©s":d.factures,"Actes Non Factur√©s":d.nonFactures,"Taux":taux,"Montant Total (‚Ç¨)":(d.montantTotal||0).toFixed(2),"Montant Factur√© (‚Ç¨)":(d.montantFacture||0).toFixed(2),"Montant Non Factur√© (‚Ç¨)":(d.montantNonFacture||0).toFixed(2)};
    });
    const ws=XLSX.utils.json_to_sheet(out), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'R√©cap'); XLSX.writeFile(wb,'recap_mensuel.xlsx');
  };
  $('#btnExportCompar').onclick = ()=>{
    const imp={}, man={};
    for(const a of reconciledData){ const d=a.Date_Formatee; if(!d) continue; imp[d]=(imp[d]||0)+1; }
    for(const e of manualEntries){ const d=new Date(e.date); if(!isNaN(d)) man[fmtDate(d)]=Number(e.count||0); }
    const all=Array.from(new Set([...Object.keys(imp),...Object.keys(man)])).sort((a,b)=>{const [ja,ma,ya]=a.split('/').map(Number);const [jb,mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma!==mb?ma-mb:ja-jb;});
    const out = all.map(d=>({Date:d,Manuel:man[d]||0,"Import√© (actes)":imp[d]||0,"Œî (Manuel - Import√©)":(man[d]||0)-(imp[d]||0)}));
    const ws=XLSX.utils.json_to_sheet(out), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Comparaison'); XLSX.writeFile(wb,'comparaison_quotidienne.xlsx');
  };
  </script>
</body>
</html>
