<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R√©conciliation des Actes M√©dicaux - Dr Pablo NEEL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;min-height:100vh}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2em;margin-bottom:10px}
    .content{padding:30px}
    .upload-section{background:#f8f9fa;border-radius:10px;padding:25px;margin-bottom:30px}
    .upload-section h2{color:#667eea;margin-bottom:20px;font-size:1.5em}
    .file-input-group{margin-bottom:20px}
    .file-input-group label{display:block;font-weight:600;color:#333;margin-bottom:8px;font-size:1.05em}
    .file-input-wrapper{position:relative;display:inline-block;width:100%}
    .file-input-wrapper input[type=file]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
    .file-input-button{display:block;padding:12px 20px;background:#fff;border:2px dashed #667eea;border-radius:8px;color:#667eea;font-weight:600;cursor:pointer;transition:.3s;text-align:center}
    .file-input-button:hover{background:#667eea;color:#fff}
    .files-list{margin-top:15px}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:#e8eaf6;border-radius:5px;margin-bottom:8px;transition:.3s}
    .file-item:hover{background:#d1d4e8}
    .file-info{display:flex;align-items:center;gap:10px;flex:1}
    .file-name{font-weight:600;color:#5e35b1}
    .file-size{font-size:.85em;color:#666}
    .remove-file-btn{padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:.9em;transition:.3s}
    .remove-file-btn:hover{background:#d32f2f;transform:scale(1.05)}
    .monthly-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
    .month-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);border-left:5px solid #667eea}
    .month-card h3{color:#667eea;margin-bottom:15px;font-size:1.3em;display:flex;align-items:center;gap:10px}
    .month-stats{display:flex;flex-direction:column;gap:10px}
    .month-stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e0e0e0}
    .month-stat-row:last-child{border-bottom:none}
    .month-stat-label{color:#666;font-size:.95em}
    .month-stat-value{font-weight:600;font-size:1.1em;color:#333}
    .month-stat-value.success{color:#28a745}
    .month-stat-value.warning{color:#e74c3c}
    .month-stat-value.amount{color:#667eea}
    .comparison-section{background:#f8f9fa;border-radius:10px;padding:20px;margin:20px 0}
    .action-buttons{display:flex;gap:15px;margin-top:25px;flex-wrap:wrap}
    .btn{padding:15px 30px;border:none;border-radius:8px;font-size:1.1em;font-weight:600;cursor:pointer;transition:.3s;flex:1}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-secondary:hover{background:#5a6268}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:10px;text-align:center}
    .stat-card.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
    .stat-card.warning{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .stat-value{font-size:2.5em;font-weight:700;margin-bottom:5px}
    .stat-label{font-size:1em;opacity:.9}
    .results-section{margin-top:30px;display:none}
    .results-section.show{display:block}
    .tab-buttons{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e0e0e0;flex-wrap:wrap}
    .tab-btn{padding:15px 25px;background:transparent;border:none;border-bottom:3px solid transparent;font-size:1.05em;font-weight:600;color:#666;cursor:pointer;transition:.3s}
    .tab-btn.active{color:#667eea;border-bottom-color:#667eea}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:left;font-weight:600;position:sticky;top:0}
    td{padding:12px 15px;border-bottom:1px solid #e0e0e0}
    tr:hover{background:#f8f9fa}
    .status-badge{padding:5px 12px;border-radius:20px;font-size:.85em;font-weight:600}
    .status-factured{background:#d4edda;color:#155724}
    .status-not-factured{background:#f8d7da;color:#721c24}
    .export-btn{margin-top:20px;padding:12px 25px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.3s}
    .export-btn:hover{background:#218838;transform:translateY(-2px)}
    .loading{display:none;text-align:center;padding:20px}
    .loading.show{display:block}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .note{font-size:.9em;color:#555;margin-top:8px}
    .manual-section{background:#f2f7ff;border:1px solid #d9e3ff;border-radius:10px;padding:20px;margin-bottom:25px}
    .manual-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
    .manual-grid input{width:100%;padding:10px;border:1px solid #cdd6f4;border-radius:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3f51b5;font-weight:600}
    .sync-section{background:#f8fff2;border:1px solid #d7efc5;border-radius:10px;padding:16px;margin:18px 0}
    .sync-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
    .sync-grid input{width:100%;padding:10px;border:1px solid #cfe6b3;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <p>Suivi des actes factur√©s et non factur√©s ‚Äî Ajoutez vos fichiers mensuels progressivement</p>
    </div>

    <div class="content">
      <div class="upload-section">
        <h2>üìÅ Chargement des fichiers</h2>
        <p class="note">üí° Astuce : Vous pouvez ajouter plusieurs fichiers progressivement. Cliquez sur ¬´ Ajouter ¬ª autant de fois que n√©cessaire, puis lancez l'analyse.</p>

        <div class="file-input-group">
          <label for="actesFile">Fichiers des actes r√©alis√©s (Excel)</label>
          <div class="file-input-wrapper">
            <input type="file" id="actesFile" accept=".xlsx,.xls" multiple style="display:none" />
            <button class="file-input-button" onclick="document.getElementById('actesFile').click()">üìä Ajouter un fichier Excel des actes</button>
          </div>
          <div id="actesFilesList" class="files-list"></div>
        </div>

        <div class="file-input-group">
          <label for="honorairesFiles">Fichiers des honoraires factur√©s (CSV)</label>
          <div class="file-input-wrapper">
            <input type="file" id="honorairesFiles" accept=".csv" multiple style="display:none" />
            <button class="file-input-button" onclick="document.getElementById('honorairesFiles').click()">üí∞ Ajouter des fichiers CSV des honoraires</button>
          </div>
          <div id="honorairesFilesList" class="files-list"></div>
          <p class="note">CSV attendu : s√©parateur ¬´ ; ¬ª, encodage ISO-8859-1, la 6·µâ ligne contient les en-t√™tes.</p>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="analyzeBtn" disabled>üîç Analyser et r√©concilier</button>
          <button class="btn btn-secondary" id="resetBtn">üîÑ R√©initialiser</button>
        </div>
      </div>

      <!-- Saisie manuelle quotidienne par Mois/Ann√©e -->
      <div class="manual-section">
        <h2>‚úçÔ∏è Saisie manuelle quotidienne (conserv√©e par Mois/Ann√©e)</h2>
        <div class="manual-grid">
          <div>
            <label class="note" for="manualDate">Date</label>
            <input type="date" id="manualDate" />
          </div>
          <div>
            <label class="note" for="manualCount">Nombre d'actes</label>
            <input type="number" id="manualCount" min="0" placeholder="0" />
          </div>
        </div>
        <div class="action-buttons">
          <button class="btn btn-secondary" id="manualAddBtn">‚ûï Ajouter / Mettre √† jour</button>
          <button class="btn btn-secondary" id="manualExportBtn">‚¨áÔ∏è Exporter (JSON)</button>
          <button class="btn btn-secondary" id="manualImportBtn">‚¨ÜÔ∏è Importer (JSON)</button>
          <input type="file" id="manualImportInput" accept="application/json" style="display:none;" />
          <span class="pill" id="manualInfo"></span>
        </div>
        <div class="table-wrapper" style="margin-top:12px">
          <table id="manualTable"></table>
        </div>

        <div class="sync-section">
          <h3>‚òÅÔ∏è Synchronisation multi-postes (GitHub Gist priv√©)</h3>
          <p class="note">Cr√©e un token GitHub (scope <code>gist</code>) puis un Gist priv√©. Laisse l‚ÄôID vide et clique <strong>Push</strong> pour cr√©er automatiquement le Gist au premier envoi.</p>
          <div class="sync-grid">
            <div>
              <label class="note" for="ghToken">Token GitHub</label>
              <input type="password" id="ghToken" placeholder="ghp_‚Ä¶" />
            </div>
            <div>
              <label class="note" for="gistId">Gist ID (vide ‚ûú cr√©ation au 1er Push)</label>
              <input type="text" id="gistId" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn btn-primary" id="btnPull">‚¨áÔ∏è Pull (r√©cup√©rer)</button>
            <button class="btn btn-primary" id="btnPush">‚¨ÜÔ∏è Push (envoyer)</button>
            <button class="btn btn-secondary" id="btnForget">üóëÔ∏è Oublier identifiants locaux</button>
          </div>
          <p class="note">S√©curit√© : le token est stock√© <strong>uniquement</strong> dans ce navigateur (localStorage). Utilise un Gist <strong>priv√©</strong> et r√©voque le token si besoin.</p>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyse en cours‚Ä¶</p>
      </div>

      <div class="results-section" id="results">
        <div class="stats" id="stats"></div>

        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="recap">üìä R√©capitulatif Mensuel</button>
          <button class="tab-btn" data-tab="non-factures">‚ùå Actes non factur√©s</button>
          <button class="tab-btn" data-tab="factures">‚úÖ Actes factur√©s</button>
          <button class="tab-btn" data-tab="tous">üìã Tous les actes</button>
        </div>

        <div class="tab-content active" id="tab-recap">
          <div id="monthly-summary"></div>
          <div class="table-wrapper" style="margin-top:30px">
            <table id="table-monthly"></table>
          </div>
          <button class="export-btn" onclick="exportMonthlyReport()">üì• Exporter le r√©capitulatif mensuel (Excel)</button>
        </div>

        <div class="tab-content" id="tab-non-factures">
          <div class="table-wrapper"><table id="table-non-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('non-factures')">üì• Exporter les actes non factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-factures">
          <div class="table-wrapper"><table id="table-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('factures')">üì• Exporter les actes factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-tous">
          <div class="table-wrapper"><table id="table-tous"></table></div>
          <button class="export-btn" onclick="exportToExcel('tous')">üì• Exporter tous les actes (Excel)</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== √âTAT =====
    let actesFiles = [];
    let honorairesFiles = [];
    let actesData = [];
    let honorairesData = [];
    let reconciledData = [];

    // ===== SAISIE MANUELLE par Mois/Ann√©e =====
    // { "YYYY-MM": [{date:"DD/MM/YYYY", count:Number}, ...], ... }
    const MANUAL_KEY = 'rc_manual_by_month_v1';
    const AUTH_KEY   = 'rc_sync_cfg_v1'; // { token, gistId }
    let manualByMonth = {};

    // ===== UTILITAIRES =====
    const normalizeString = (s="") => s.toString().normalize("NFD").replace(/\p{Diacritic}/gu, "").replace(/[^A-Za-z0-9\s'-]/g, " ").replace(/\s+/g, " ").trim().toUpperCase();
    const normalizeDossier = (d="") => d.toString().replace(/\D/g, "").replace(/^0+/, "");
    const parseFrenchNumber = (val) => { if(val===null||val===undefined) return 0; if(typeof val==="number") return val; const s=String(val).replace(/\s/g,""); const n=parseFloat(s.replace(/\./g,"").replace(/,/g,".")); return isNaN(n)?0:n; };
    const toMoney = (n) => (Number(n)||0).toFixed(2)+"‚Ç¨";
    function excelDateToJSDate(serial){
      if(!serial && serial!==0) return null;
      if (serial instanceof Date) return new Date(serial.getFullYear(), serial.getMonth(), serial.getDate());
      if (typeof serial === "string") {
        const s = serial.trim();
        const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m1) return new Date(Number(m1[1]), Number(m1[2]) - 1, Number(m1[3]));
        const m2 = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (m2) return new Date(Number(m2[3]), Number(m2[2]) - 1, Number(m2[1]));
        const d = new Date(s);
        return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }
      const utcDays = Math.floor(serial - 25569);
      const utcValue = utcDays * 86400;
      const dateInfo = new Date(utcValue * 1000);
      return new Date(dateInfo.getFullYear(), dateInfo.getMonth(), dateInfo.getDate());
    }
    function formatDate(date){
      if (!date) return "";
      const d = new Date(date);
      if (isNaN(d)) return "";
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }
    const monthKeyOf = (dateStr) => { const [dd,mm,yy] = dateStr.split('/'); return `${yy}-${mm}`; };
    const monthNameOfKey = (k) => { const [yy,mm]=k.split('-'); const names=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"]; return `${names[+mm-1]} ${yy}`; };
    const todayInputValue = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };

    // ===== PERSISTENCE LOCALE =====
    function loadManualLocal(){ try{ const raw=localStorage.getItem(MANUAL_KEY); manualByMonth = raw? JSON.parse(raw): {}; } catch{ manualByMonth = {}; } }
    function saveManualLocal(){ localStorage.setItem(MANUAL_KEY, JSON.stringify(manualByMonth)); }

    // ===== UI SAISIE MANUELLE =====
    function refreshManualUI(){
      const months = Object.keys(manualByMonth).sort();
      const total = months.reduce((s,k)=> s + manualByMonth[k].reduce((x,e)=>x + Number(e.count||0),0), 0);
      document.getElementById('manualInfo').textContent = `${months.length} mois sauvegard√©s ‚Ä¢ ${total} actes saisis`;

      const dateInput = document.getElementById('manualDate').value || todayInputValue();
      const [y,m,d] = dateInput.split('-');
      const fr = `${d}/${m}/${y}`;
      const key = monthKeyOf(fr);
      renderManualTable(key);

      const ex = (manualByMonth[key]||[]).find(e=>e.date===fr);
      document.getElementById('manualCount').value = ex? ex.count: '';
    }
    function renderManualTable(key){
      const t=document.getElementById('manualTable');
      const rows=(manualByMonth[key]||[]).slice().sort((a,b)=>{const [da,ma,ya]=a.date.split('/').map(Number); const [db,mb,yb]=b.date.split('/').map(Number); return ya!==yb?ya-yb:ma!==mb?ma-mb:da-db;});
      if(!rows.length){
        t.innerHTML='<thead><tr><th>Date</th><th>Nb actes</th><th></th></tr></thead><tbody><tr><td colspan="3" style="text-align:center;color:#666;padding:12px">Aucune saisie ce mois</td></tr></tbody>';
        return;
      }
      let html='<thead><tr><th>Date</th><th>Nb actes</th><th>Action</th></tr></thead><tbody>';
      for(const e of rows){
        html+=`<tr><td>${e.date}</td><td>${e.count}</td><td><button class="remove-file-btn" onclick="deleteManual('${key}','${e.date}')">Supprimer</button></td></tr>`;
      }
      const tot = rows.reduce((s,e)=>s+Number(e.count||0),0);
      html+=`<tr style="background:#f8f9fa;font-weight:bold"><td>Total ${monthNameOfKey(key)}</td><td>${tot}</td><td></td></tr>`;
      html+='</tbody>';
      t.innerHTML=html;
    }
    function addOrUpdateManual(){
      const dateInput=document.getElementById('manualDate').value;
      const count=Number(document.getElementById('manualCount').value||0);
      if(!dateInput) return alert('Choisis une date.');
      if(count<0) return alert('Le nombre doit √™tre ‚â• 0');

      const [y,m,d]=dateInput.split('-');
      const fr=`${d}/${m}/${y}`;
      const key=monthKeyOf(fr);

      if(!manualByMonth[key]) manualByMonth[key]=[];
      const idx=manualByMonth[key].findIndex(e=>e.date===fr);
      if(idx>-1) manualByMonth[key][idx].count=count;
      else manualByMonth[key].push({date:fr,count});

      saveManualLocal();
      refreshManualUI();
    }
    function deleteManual(key,date){
      manualByMonth[key] = (manualByMonth[key]||[]).filter(e=>e.date!==date);
      if(!manualByMonth[key].length) delete manualByMonth[key];
      saveManualLocal();
      refreshManualUI();
    }
    window.deleteManual = deleteManual;

    function exportManualJSON(){
      const blob=new Blob([JSON.stringify(manualByMonth,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='saisies_manuelles_par_mois.json'; a.click();
      URL.revokeObjectURL(url);
    }
    function importManualJSON(file){
      const r=new FileReader();
      r.onload=()=>{
        try{
          const obj=JSON.parse(r.result);
          if(Object.prototype.toString.call(obj)==='[object Object]'){
            manualByMonth=obj; saveManualLocal(); refreshManualUI(); alert('Import JSON termin√© ‚úÖ');
          } else { alert('Format JSON invalide'); }
        }catch{ alert('JSON invalide'); }
      };
      r.readAsText(file);
    }

    // ===== SYNC GITHUB GIST =====
    function loadAuth(){
      try{
        const cfg=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}');
        document.getElementById('ghToken').value = cfg.token||'';
        document.getElementById('gistId').value = cfg.gistId||'';
      }catch{}
    }
    function saveAuth(){
      const token=document.getElementById('ghToken').value.trim();
      const gistId=document.getElementById('gistId').value.trim();
      localStorage.setItem(AUTH_KEY, JSON.stringify({token,gistId}));
    }
    async function gistRequest(path, method='GET', body){
      const {token} = JSON.parse(localStorage.getItem(AUTH_KEY)||'{}');
      if(!token) throw new Error('Renseigne ton token GitHub.');
      const res = await fetch(`https://api.github.com${path}`, {
        method,
        headers:{ 'Authorization': `Bearer ${token}`, 'Accept':'application/vnd.github+json' },
        body: body? JSON.stringify(body): undefined
      });
      if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
      return res.json();
    }
    async function pullGist(){
      try{
        saveAuth();
        const cfg=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}');
        if(!cfg.gistId) return alert("Indique l'ID du Gist √† r√©cup√©rer.");
        const data = await gistRequest(`/gists/${cfg.gistId}`);
        const file = data.files?.['reconciliateur_manual_by_month.json'];
        if(!file) return alert('Fichier introuvable dans le Gist.');
        const content = await (await fetch(file.raw_url)).text();
        const obj = JSON.parse(content);
        if(Object.prototype.toString.call(obj)==='[object Object]'){
          manualByMonth=obj; saveManualLocal(); refreshManualUI(); alert('Pull OK ‚úÖ');
        } else { alert('Format du fichier invalide'); }
      }catch(e){ alert(e.message); }
    }
    async function pushGist(){
      try{
        saveAuth();
        const cfg=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}');
        const files={ 'reconciliateur_manual_by_month.json': { content: JSON.stringify(manualByMonth,null,2) } };
        if(cfg.gistId){
          await gistRequest(`/gists/${cfg.gistId}`, 'PATCH', { files });
          alert('Push OK ‚úÖ');
        } else {
          const created = await gistRequest('/gists','POST',{ description:'R√©conciliateur ‚Äî donn√©es manuelles par mois', public:false, files });
          document.getElementById('gistId').value = created.id; saveAuth();
          alert('Gist cr√©√© et Push OK ‚úÖ\nGist ID: '+created.id);
        }
      }catch(e){ alert(e.message); }
    }
    function forgetAuth(){
      localStorage.removeItem(AUTH_KEY);
      document.getElementById('ghToken').value='';
      document.getElementById('gistId').value='';
      alert('Identifiants supprim√©s sur ce navigateur.');
    }

    // ===== GESTION FICHIERS =====
    document.getElementById("actesFile").addEventListener("change", (e) => {
      const newFiles = Array.from(e.target.files);
      newFiles.forEach((file) => {
        if (!actesFiles.find((f) => f.name === file.name && f.size === file.size)) {
          actesFiles.push(file);
        }
      });
      updateFilesList("actes");
      checkFilesReady();
      e.target.value = "";
    });
    document.getElementById("honorairesFiles").addEventListener("change", (e) => {
      const newFiles = Array.from(e.target.files);
      newFiles.forEach((file) => {
        if (!honorairesFiles.find((f) => f.name === file.name && f.size === file.size)) {
          honorairesFiles.push(file);
        }
      });
      updateFilesList("honoraires");
      checkFilesReady();
      e.target.value = "";
    });
    function updateFilesList(type) {
      const files = type === "actes" ? actesFiles : honorairesFiles;
      const listElement = document.getElementById(type === "actes" ? "actesFilesList" : "honorairesFilesList");
      listElement.innerHTML = files
        .map((file, index) => `
          <div class="file-item">
            <div class="file-info">
              <div>${type === "actes" ? "üìä" : "üí∞"}</div>
              <div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
            </div>
            <button class="remove-file-btn" onclick="removeFile('${type}', ${index})">‚úï Supprimer</button>
          </div>
        `)
        .join("");
    }
    function removeFile(type, index) {
      if (type === "actes") actesFiles.splice(index, 1);
      else honorairesFiles.splice(index, 1);
      updateFilesList(type);
      checkFilesReady();
    }
    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
    }
    function checkFilesReady() {
      document.getElementById("analyzeBtn").disabled = !(actesFiles.length > 0 && honorairesFiles.length > 0);
    }

    document.getElementById("analyzeBtn").addEventListener("click", analyzeFiles);
    document.getElementById("resetBtn").addEventListener("click", () => {
      actesFiles = []; honorairesFiles = []; actesData = []; honorairesData = []; reconciledData = [];
      updateFilesList("actes"); updateFilesList("honoraires"); checkFilesReady();
      document.getElementById("results").classList.remove("show");
    });

    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", function(){
        const tab = this.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
        this.classList.add("active");
        document.getElementById(`tab-${tab}`).classList.add("active");
      });
    });

    // ===== LECTURE FICHIERS / ANALYSE =====
    async function analyzeFiles(){
      document.getElementById("loading").classList.add("show");
      document.getElementById("results").classList.remove("show");
      try {
        actesData = [];
        for (const file of actesFiles){ const data = await readExcelFile(file); actesData = actesData.concat(data); }
        honorairesData = [];
        for (const file of honorairesFiles){ const data = await readCSVFile(file); honorairesData = honorairesData.concat(data); }
        reconcileData();
        displayResults();
        document.getElementById("loading").classList.remove("show");
        document.getElementById("results").classList.add("show");
      } catch(err){
        console.error(err);
        alert("Erreur lors de l'analyse des fichiers : " + err.message);
        document.getElementById("loading").classList.remove("show");
      }
    }
    function readExcelFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type:"array" });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header:1 });
            let headerRow = -1;
            for(let i=0;i<jsonData.length;i++){
              if (jsonData[i].some((cell)=>String(cell||"").toLowerCase().includes("num√©ro de dossier"))) { headerRow = i; break; }
            }
            if (headerRow === -1) return reject(new Error("En-t√™te non trouv√© dans le fichier Excel"));
            const headers = jsonData[headerRow];
            const rows = jsonData.slice(headerRow+1);
            const arr = rows.map((row)=>{
              const obj = {};
              headers.forEach((h,idx)=>{ obj[h] = row[idx]; });
              return obj;
            }).filter((r)=>r["Nom"] && r["Num√©ro de dossier"]);
            resolve(arr);
          }catch(err){ reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
    function readCSVFile(file){
      return new Promise((resolve, reject) => {
        Papa.parse(file,{
          encoding:"ISO-8859-1",
          delimiter:";",
          skipEmptyLines:true,
          complete: (results)=>{
            try{
              if (results.data.length < 7) return reject(new Error("Le fichier CSV ne contient pas assez de lignes"));
              const headers = ["Praticien","Dossier","Patient","Libell√©","Transfert","Date Acte","Serv.","Coeff.","Pertes","Mt Hors D√©pass.","D√©pass.","Total","Vide"];
              const dataRows = results.data.slice(6);
              const cleaned = dataRows.map((row)=>{
                if (!row || row.length < 6) return null;
                const obj = {};
                headers.forEach((h,i)=>{ obj[h] = (row[i] ? row[i].replace(/\"/g,"").trim() : ""); });
                obj["Date Acte"] = normalizeDateString(obj["Date Acte"]);
                obj["Total"] = parseFrenchNumber(obj["Total"]);
                obj["Dossier"] = normalizeDossier(obj["Dossier"]);
                obj["Patient_norm"] = normalizeString(obj["Patient"]);
                return obj;
              }).filter((r)=>r && r["Dossier"] && r["Date Acte"]);
              resolve(cleaned);
            }catch(err){ reject(err); }
          },
          error: reject
        });
      });
    }
    function normalizeDateString(s){
      if (!s) return "";
      const str = String(s).trim();
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return str;
      const m1 = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m1) return `${m1[3]}/${m1[2]}/${m1[1]}`;
      const d = new Date(str);
      return isNaN(d) ? str : formatDate(d);
    }

    // ===== R√âCONCILIATION =====
    function reconcileData(){
      const honIndex = new Map();
      for (const hon of honorairesData){
        const key = `${hon["Dossier"]}|${hon["Patient_norm"]}|${hon["Date Acte"]}`;
        if (!honIndex.has(key)) honIndex.set(key, hon);
      }
      reconciledData = actesData.map((acte)=>{
        const dossier = normalizeDossier(acte["Num√©ro de dossier"] || acte["Num√©ro de Dossier"] || "");
        const nom = normalizeString(acte["Nom"] || "");
        const prenom = normalizeString(acte["Pr√©nom"] || acte["Prenom"] || "");
        const nomComplet = (nom + " " + prenom).trim();
        const patientNorm = normalizeString(nomComplet);
        const dActe = excelDateToJSDate(acte["Date de d√©but"] || acte["Date"]);
        const dateFormatted = formatDate(dActe);
        const prestation = acte["Prestation"] || acte["Acte"] || "";
        const montant = parseFrenchNumber(acte["Prix_Unitaire_Coefficient_Quantit√©"] || acte["Montant"] || acte["Tarif"]);
        const key = `${dossier}|${patientNorm}|${dateFormatted}`;
        const match = honIndex.get(key);
        return {
          ...acte,
          _DOSSIER_NORM: dossier,
          Nom_Complet: nomComplet,
          Patient_norm: patientNorm,
          Date_Formatee: dateFormatted,
          Prestation: prestation,
          Montant_num: Number(montant) || 0,
          Factur√©: match ? "Oui" : "Non",
          D√©tails_Facture: match ? (match["Libell√©"] || "N/A") : "",
        };
      });
    }

    // ===== AFFICHAGE =====
    function displayResults(){
      const totalActes = reconciledData.length;
      const actesFactures = reconciledData.filter((a)=>a["Factur√©"] === "Oui").length;
      const actesNonFactures = totalActes - actesFactures;
      const montantNonFacture = reconciledData.filter((a)=>a["Factur√©"] === "Non").reduce((s,a)=> s + (a.Montant_num||0), 0);

      document.getElementById("stats").innerHTML = `
        <div class="stat-card"><div class="stat-value">${totalActes}</div><div class="stat-label">Total actes</div></div>
        <div class="stat-card success"><div class="stat-value">${actesFactures}</div><div class="stat-label">Actes factur√©s</div></div>
        <div class="stat-card warning"><div class="stat-value">${actesNonFactures}</div><div class="stat-label">Actes non factur√©s</div></div>
        <div class="stat-card warning"><div class="stat-value">${toMoney(montantNonFacture)}</div><div class="stat-label">Montant non factur√©</div></div>
      `;
      displayTable("non-factures", reconciledData.filter((a)=>a["Factur√©"] === "Non"));
      displayTable("factures", reconciledData.filter((a)=>a["Factur√©"] === "Oui"));
      displayTable("tous", reconciledData);
      displayMonthlySummary();
    }
    function displayTable(type, data){
      const table = document.getElementById(`table-${type}`);
      if (!data.length){
        table.innerHTML = '<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e √† afficher</p>';
        return;
      }
      let html = '<thead><tr>' +
        '<th>Date</th><th>Nom Patient</th><th>N¬∞ Dossier</th><th>Prestation</th><th>Montant</th><th>Statut</th><th>D√©tails</th>' +
        '</tr></thead><tbody>';
      for (const row of data){
        const statusClass = row["Factur√©"] === "Oui" ? "status-factured" : "status-not-factured";
        const statusText = row["Factur√©"] === "Oui" ? "‚úì Factur√©" : "‚úó Non factur√©";
        html += '<tr>' +
          `<td>${row["Date_Formatee"] || ""}</td>`+
          `<td>${row["Nom_Complet"] || ""}</td>`+
          `<td>${row["_DOSSIER_NORM"] || ""}</td>`+
          `<td>${row["Prestation"] || ""}</td>`+
          `<td>${toMoney(row["Montant_num"])}</td>`+
          `<td><span class="status-badge ${statusClass}">${statusText}</span></td>`+
          `<td>${row["D√©tails_Facture"] || ""}</td>`+
        '</tr>';
      }
      html += '</tbody>';
      table.innerHTML = html;
    }

    // ===== R√âCAP MENSUEL =====
    function displayMonthlySummary(){
      const monthlyData = {};
      for (const acte of reconciledData){
        const date = acte["Date_Formatee"]; if (!date) continue;
        const [jj, mm, yyyy] = date.split("/");
        if (!jj || !mm || !yyyy) continue;
        const key = `${mm}/${yyyy}`;
        const name = getMonthName(Number(mm), Number(yyyy));
        if (!monthlyData[key]){
          monthlyData[key] = {
            name,total:0,factures:0,nonFactures:0,
            montantTotal:0,montantFacture:0,montantNonFacture:0,
          };
        }
        const montant = acte.Montant_num || 0;
        monthlyData[key].total++;
        monthlyData[key].montantTotal += montant;
        if (acte["Factur√©"] === "Oui"){ monthlyData[key].factures++; monthlyData[key].montantFacture += montant; }
        else { monthlyData[key].nonFactures++; monthlyData[key].montantNonFacture += montant; }
      }
      const sorted = Object.keys(monthlyData).sort((a,b)=>{
        const [ma,ya] = a.split('/').map(Number);
        const [mb,yb] = b.split('/').map(Number);
        return ya !== yb ? ya - yb : ma - mb;
      });
      let summaryHTML = '<div class="monthly-summary-grid">';
      for (const k of sorted){
        const d = monthlyData[k];
        const taux = d.total ? (d.factures / d.total * 100).toFixed(1) : 0;
        summaryHTML += `
          <div class="month-card">
            <h3>üìÖ ${d.name}</h3>
            <div class="month-stats">
              <div class="month-stat-row"><span class="month-stat-label">Total actes</span><span class="month-stat-value">${d.total}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Actes factur√©s</span><span class="month-stat-value success">${d.factures} (${taux}%)</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Actes non factur√©s</span><span class="month-stat-value warning">${d.nonFactures}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Montant total</span><span class="month-stat-value amount">${toMoney(d.montantTotal)}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Montant factur√©</span><span class="month-stat-value success">${toMoney(d.montantFacture)}</span></div>
              <div class="month-stat-row"><span class="month-stat-label">Montant non factur√©</span><span class="month-stat-value warning">${toMoney(d.montantNonFacture)}</span></div>
            </div>
          </div>`;
      }
      summaryHTML += '</div>';
      if (sorted.length > 1){
        summaryHTML += `<div class="comparison-section"><h3>üìä Comparaison des mois</h3><p class="note">Vue d'ensemble de l'√©volution mensuelle</p></div>`;
      }
      document.getElementById("monthly-summary").innerHTML = summaryHTML;
      displayMonthlyTable(monthlyData, sorted);
    }
    function getMonthName(month, year){
      const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
      return `${months[month-1]} ${year}`;
    }
    function displayMonthlyTable(monthlyData, sorted){
      const table = document.getElementById("table-monthly");
      if (!sorted.length){
        table.innerHTML = '<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e mensuelle disponible</p>';
        return;
      }
      let html = '<thead><tr>'+
        '<th>Mois</th><th>Total Actes</th><th>Factur√©s</th><th>Non Factur√©s</th><th>Taux Facturation</th><th>Montant Total</th><th>Montant Factur√©</th><th>Montant Non Factur√©</th>'+
        '</tr></thead><tbody>';
      const tot = { total:0, factures:0, nonFactures:0, montantTotal:0, montantFacture:0, montantNonFacture:0 };
      for (const k of sorted){
        const d = monthlyData[k];
        const taux = d.total ? (d.factures / d.total * 100).toFixed(1) : 0;
        html += '<tr>'+
          `<td><strong>${d.name}</strong></td>`+
          `<td>${d.total}</td>`+
          `<td style="color:#28a745;font-weight:600">${d.factures}</td>`+
          `<td style="color:#e74c3c;font-weight:600">${d.nonFactures}</td>`+
          `<td><strong>${taux}%</strong></td>`+
          `<td>${toMoney(d.montantTotal)}</td>`+
          `<td style="color:#28a745">${toMoney(d.montantFacture)}</td>`+
          `<td style="color:#e74c3c">${toMoney(d.montantNonFactur√©)}</td>`+
          '</tr>';
      }
      html += '</tbody>';
      table.innerHTML = html;
    }

    // ===== EXPORTS =====
    function exportMonthlyReport(){
      const monthlyData = {};
      for (const acte of reconciledData){
        const date = acte["Date_Formatee"]; if (!date) continue;
        const [jj,mm,yyyy] = date.split('/');
        if (!(jj&&mm&&yyyy)) continue;
        const key = `${mm}/${yyyy}`;
        const name = getMonthName(Number(mm), Number(yyyy));
        if (!monthlyData[key]) monthlyData[key] = { name,total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0 };
        const m = acte.Montant_num || 0;
        monthlyData[key].total++;
        monthlyData[key].montantTotal += m;
        if (acte["Factur√©"] === "Oui"){ monthlyData[key].factures++; monthlyData[key].montantFacture += m; }
        else { monthlyData[key].nonFactures++; monthlyData[key].montantNonFacture += m; }
      }
      const sorted = Object.keys(monthlyData).sort((a,b)=>{ const [ma,ya]=a.split('/').map(Number); const [mb,yb]=b.split('/').map(Number); return ya!==yb?ya-yb:ma-mb; });
      const exportData = sorted.map((k)=>{
        const d = monthlyData[k];
        const taux = d.total ? (d.factures / d.total * 100).toFixed(1) + '%' : '0%';
        return {
          'Mois': d.name,
          'Total Actes': d.total,
          'Actes Factur√©s': d.factures,
          'Actes Non Factur√©s': d.nonFactures,
          'Taux de Facturation': taux,
          'Montant Total (‚Ç¨)': (d.montantTotal||0).toFixed(2),
          'Montant Factur√© (‚Ç¨)': (d.montantFacture||0).toFixed(2),
          'Montant Non Factur√© (‚Ç¨)': (d.montantNonFacture||0).toFixed(2)
        };
      });
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'R√©capitulatif Mensuel');
      const today = new Date();
      const filename = `Recapitulatif_Mensuel_${today.getFullYear()}_${String(today.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, filename);
    }
    function exportToExcel(type){
      let data, filename;
      switch(type){
        case 'non-factures': data = reconciledData.filter((a)=>a['Factur√©']==='Non'); filename='actes_non_factures.xlsx'; break;
        case 'factures': data = reconciledData.filter((a)=>a['Factur√©']==='Oui'); filename='actes_factures.xlsx'; break;
        default: data = reconciledData; filename='tous_les_actes.xlsx';
      }
      const rows = data.map((r)=>({
        'Date': r['Date_Formatee'],
        'Nom Patient': r['Nom_Complet'],
        'Num√©ro de Dossier': r['_DOSSIER_NORM'],
        'Prestation': r['Prestation'],
        'Montant (‚Ç¨)': (r['Montant_num']||0).toFixed(2),
        'Statut': r['Factur√©'],
        'D√©tails Facture': r['D√©tails_Facture']
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Actes');
      XLSX.writeFile(wb, filename);
    }

    // ===== INIT =====
    document.getElementById('manualDate').value = todayInputValue();
    document.getElementById('manualAddBtn').addEventListener('click', addOrUpdateManual);
    document.getElementById('manualExportBtn').addEventListener('click', exportManualJSON);
    document.getElementById('manualImportBtn').addEventListener('click', ()=>document.getElementById('manualImportInput').click());
    document.getElementById('manualImportInput').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) importManualJSON(f); e.target.value=''; });

    document.getElementById('btnPull').addEventListener('click', pullGist);
    document.getElementById('btnPush').addEventListener('click', pushGist);
    document.getElementById('btnForget').addEventListener('click', forgetAuth);

    loadManualLocal(); loadAuth(); refreshManualUI();
  </script>
</body>
</html>
