<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√©conciliation des Actes M√©dicaux</title>

  <!-- Librairies parsing c√¥t√© client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Firebase COMPAT (pas de modules) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    :root{--violet:#6b5cff;--violet2:#5b4bd8;}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    .shell{max-width:1180px;margin:24px auto;background:#fff;border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:22px 28px;display:flex;align-items:center;justify-content:space-between}
    .header h1{margin:0;font-size:22px;font-weight:700}
    .content{padding:24px}
    .card{background:#fff;border:1px solid #e7e7ef;border-radius:12px;padding:16px;margin:14px 0}
    .section-title{display:flex;gap:8px;align-items:center;font-weight:700;margin:6px 0 12px 0}
    .btn{appearance:none;border:0;border-radius:10px;background:var(--violet);color:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6c757d} .btn.ghost{background:#f0f1ff;color:#3d33b7} .btn.small{padding:8px 10px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .file-btn{display:inline-block;border:2px dashed var(--violet);border-radius:10px;padding:10px 14px;color:var(--violet);font-weight:700;background:#fff;cursor:pointer}
    .file-list{margin-top:10px}
    .file-pill{display:flex;justify-content:space-between;align-items:center;background:#f6f7ff;border:1px solid #e1e3ff;border-radius:10px;padding:8px 10px;margin-top:8px}
    .file-pill .x{background:#ff6b6b;color:#fff;border:0;border-radius:6px;padding:4px 6px;cursor:pointer}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    input,select{width:100%;padding:9px 10px;border:1px solid #dfe3f0;border-radius:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#f3f4ff;color:#463ab8;position:sticky;top:0}
    .stat{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;padding:12px;text-align:center}
    .stat .v{font-size:26px;font-weight:800}
    .note{color:#666;font-size:12px}
    .tabbar .btn{background:#eef0ff;color:#3c31b7} .tabbar .btn.active{background:var(--violet2);color:#fff}
    .hidden{display:none}
    .right{margin-left:auto}
    .tag{display:inline-block;background:#eef1ff;color:#3b36a8;border-radius:8px;padding:4px 8px;font-size:12px;font-weight:700}
    .small-note{font-size:12px;color:#555;margin-top:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#eef1ff;color:#392fb0;font-weight:700}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <div class="row" id="authArea">
        <span class="tag" id="hostTag">Local</span>
        <button class="btn ghost small" id="btnLogin">Se connecter Google</button>
        <button class="btn secondary small hidden" id="btnLogout">D√©connexion</button>
      </div>
    </div>

    <div class="content">
      <!-- Upload -->
      <div class="card">
        <div class="section-title">üìÅ Chargement des fichiers</div>
        <div class="note">Ajoutez un ou plusieurs fichiers, puis lancez l‚Äôanalyse.</div>
        <div class="row" style="margin:10px 0">
          <input type="file" id="actesInput" accept=".xlsx,.xls" multiple class="hidden">
          <button class="file-btn" id="btnActes">üìä Ajouter fichier Excel (actes)</button>

          <input type="file" id="honosInput" accept=".csv" multiple class="hidden">
          <button class="file-btn" id="btnHonos">üí∞ Ajouter fichier CSV (honoraires)</button>

          <button class="btn right" id="btnAnalyze" disabled>üîç Analyser & r√©concilier</button>
          <button class="btn secondary" id="btnReset">üîÑ R√©initialiser</button>
          <button class="btn secondary" id="btnUploadCloud" disabled title="Disponible connect√©">‚òÅÔ∏è Uploader vers Storage</button>
        </div>

        <div class="file-list" id="listActes"></div>
        <div class="file-list" id="listHonos"></div>

        <div id="cloudSection" class="hidden">
          <div class="section-title" style="margin-top:14px">‚òÅÔ∏è Fichiers stock√©s (Storage)</div>
          <div class="small-note">R√©importer pour relancer l‚Äôanalyse √† partir du cloud, ou supprimer.</div>
          <div class="file-list" id="cloudListActes"></div>
          <div class="file-list" id="cloudListHonos"></div>
        </div>
      </div>

      <!-- Saisie manuelle -->
      <div class="card">
        <div class="section-title">‚úçÔ∏è Saisie manuelle quotidienne (comparatif)</div>
        <div class="grid">
          <div><div class="note">Date</div><input id="mDate" type="date"></div>
          <div><div class="note">Nombre d'actes</div><input id="mCount" type="number" min="0" step="1" placeholder="0"></div>
          <div style="align-self:end"><button class="btn" id="mAdd">‚ûï Ajouter</button></div>
          <div style="align-self:end"><button class="btn secondary" id="mExport">üì• Exporter la saisie (CSV)</button></div>
        </div>
        <div class="small-note">La saisie est conserv√©e en local (localStorage) et synchronis√©e dans Firestore si connect√©.</div>
        <table id="mTable"></table>
      </div>

      <!-- R√©sultats -->
      <div class="card">
        <div class="section-title">üìà R√©sultats</div>
        <div class="grid" id="statsBox"></div>

        <div class="row tabbar" style="margin:12px 0">
          <button class="btn" data-tab="recap" id="tabBtn-recap">üìä R√©capitulatif Mensuel</button>
          <button class="btn" data-tab="compar" id="tabBtn-compar">üìà Comparaison quotidienne</button>
          <button class="btn" data-tab="non" id="tabBtn-non">‚ùå Actes non factur√©s</button>
          <button class="btn" data-tab="oui" id="tabBtn-oui">‚úÖ Actes factur√©s</button>
          <button class="btn" data-tab="tous" id="tabBtn-tous">üìã Tous les actes</button>
          <span class="right"></span>
          <button class="btn secondary" id="btnExportRecap">Exporter R√©cap (Excel)</button>
          <button class="btn secondary" id="btnExportCompar">Exporter Comparaison (Excel)</button>
        </div>

        <div id="tab-recap"></div>
        <div id="tab-compar" class="hidden"></div>
        <div id="tab-non" class="hidden"></div>
        <div id="tab-oui" class="hidden"></div>
        <div id="tab-tous" class="hidden"></div>
      </div>

      <!-- Historique Firestore -->
      <div class="card" id="histCard" style="display:none">
        <div class="section-title">üìú Historique des analyses (Firestore)</div>
        <div id="histList" class="grid"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG FIREBASE (celle que tu as fournie) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDcP7Cuvbkvmcr_mq7E_nHuxjSmDWK08-4",
      authDomain: "reconciliateur-50684.firebaseapp.com",
      projectId: "reconciliateur-50684",
      storageBucket: "reconciliateur-50684.firebasestorage.app", // ‚ö†Ô∏è si Storage ne liste rien, remplace par "reconciliateur-50684.appspot.com"
      messagingSenderId: "1029928449677",
      appId: "1:1029928449677:web:7445402f84a963d3ab54c4",
      measurementId: "G-STE125RQPZ"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const st   = firebase.storage();

    // ====== ETAT / DONN√âES ======
    let currentUser = null;
    let actesFiles=[], honosFiles=[];
    let actesData=[], honosData=[], reconciledData=[];
    let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]');

    // ====== UTIL ======
    const $ = s => document.querySelector(s);
    function fmtMoney(n){ return (Number(n)||0).toFixed(2)+'‚Ç¨'; }
    function normalizeString(s=""){ return s.toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Za-z0-9\s'-]/g,' ').replace(/\s+/g,' ').trim().toUpperCase(); }
    function normalizeDossier(d=""){ return d.toString().replace(/\D/g,'').replace(/^0+/,''); }
    function parseFrNumber(val){ if(val==null) return 0; if(typeof val==='number') return val; const s=String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.'); const n=parseFloat(s); return isNaN(n)?0:n; }
    function excelDateToJSDate(serial){
      if(serial instanceof Date) return new Date(serial.getFullYear(),serial.getMonth(),serial.getDate());
      if(typeof serial==='string'){ const s=serial.trim(); let m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m) return new Date(+m[1],+m[2]-1,+m[3]); m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]); const d=new Date(s); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
      if(!serial && serial!==0) return null; const utcDays=Math.floor(serial-25569), utcValue=utcDays*86400; const dt=new Date(utcValue*1000); return new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
    }
    function fmtDate(d){ if(!d) return ''; const t=new Date(d); if(isNaN(t)) return ''; return `${String(t.getDate()).padStart(2,'0')}/${String(t.getMonth()+1).padStart(2,'0')}/${t.getFullYear()}`; }
    function ensureTabs(name){ ['recap','compar','non','oui','tous'].forEach(k=>{ $('#tab-'+k).classList.toggle('hidden', k!==name); $('#tabBtn-'+k).classList.toggle('active', k===name); }); }

    // ====== AUTH UI ======
    $('#hostTag').textContent = 'GitHub Pages / Firebase';
    const provider = new firebase.auth.GoogleAuthProvider();

    $('#btnLogin').onclick = async () => {
      try {
        await auth.signInWithPopup(provider);
      } catch (e) {
        if ((e && e.code && e.code.includes('popup')) || (e && e.message && e.message.toLowerCase().includes('popup'))) {
          try { await auth.signInWithRedirect(provider); return; } catch (e2) {}
        }
        if (String(e.message||'').toLowerCase().includes('api key')) {
          alert("La cl√© Web Firebase est invalide/r√©v√©r√©e. V√©rifie la config dans Firebase Console (Param√®tres du projet ‚Üí G√©n√©ral ‚Üí Vos applications).");
        } else {
          alert('Connexion impossible : '+e.message);
        }
      }
    };
    $('#btnLogout').onclick = () => auth.signOut();

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      if (user) {
        $('#btnLogin').classList.add('hidden');
        $('#btnLogout').classList.remove('hidden');
        $('#btnUploadCloud').disabled = false;
        $('#cloudSection').classList.remove('hidden');
        $('#histCard').style.display='block';

        // Charger saisie manuelle (merge locale + Firestore)
        await syncManualFromFirestore();

        // Lister fichiers Storage
        await listCloudFiles();

        // Historique Firestore (reconciliations)
        bindHistorique(user.uid);
      } else {
        $('#btnLogin').classList.remove('hidden');
        $('#btnLogout').classList.add('hidden');
        $('#btnUploadCloud').disabled = true;
        $('#cloudSection').classList.add('hidden');
        $('#histCard').style.display='none';
        $('#histList').innerHTML='';
      }
    });

    // ====== UPLOAD LOCAL UI ======
    $('#btnActes').onclick = ()=> $('#actesInput').click();
    $('#btnHonos').onclick = ()=> $('#honosInput').click();
    $('#actesInput').onchange = (e)=>{ for(const f of Array.from(e.target.files)){ if(!actesFiles.find(x=>x.name===f.name&&x.size===f.size)) actesFiles.push(f); } renderLocalList('actes'); checkReady(); e.target.value=''; };
    $('#honosInput').onchange = (e)=>{ for(const f of Array.from(e.target.files)){ if(!honosFiles.find(x=>x.name===f.name&&x.size===f.size)) honosFiles.push(f); } renderLocalList('honos'); checkReady(); e.target.value=''; };
    function renderLocalList(kind){
      const list = kind==='actes' ? $('#listActes') : $('#listHonos');
      const arr  = kind==='actes' ? actesFiles : honosFiles;
      list.innerHTML = arr.map((f,i)=>`
        <div class="file-pill">
          <div>${kind==='actes'?'üìä':'üí∞'} ${f.name} <span class="note">(${(f.size/1024).toFixed(1)} KB)</span></div>
          <button class="x" onclick="removeLocalFile('${kind}',${i})">Suppr</button>
        </div>`).join('');
    }
    window.removeLocalFile=(kind,idx)=>{ if(kind==='actes') actesFiles.splice(idx,1); else honosFiles.splice(idx,1); renderLocalList(kind); checkReady(); };
    function checkReady(){ $('#btnAnalyze').disabled = !(actesFiles.length && honosFiles.length); }

    $('#btnReset').onclick = ()=>{
      actesFiles=[]; honosFiles=[]; actesData=[]; honosData=[]; reconciledData=[];
      renderLocalList('actes'); renderLocalList('honos'); checkReady();
      $('#statsBox').innerHTML=''; ['recap','compar','non','oui','tous'].forEach(k=>$('#tab-'+k).innerHTML='');
    };

    // ====== SAISIE MANUELLE ======
    function renderManualTable(){
      const t=$('#mTable');
      if(!manualEntries.length){ t.innerHTML='<thead><tr><th>Date</th><th>Nombre</th><th></th></tr></thead><tbody><tr><td colspan="3" class="note">Aucune saisie</td></tr></tbody>'; return; }
      const rows = manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(e=>`
        <tr><td>${e.date}</td><td>${e.count}</td><td><button class="x" onclick="delManual('${e.date}')">Suppr</button></td></tr>`).join('');
      t.innerHTML=`<thead><tr><th>Date</th><th>Nombre</th><th>Action</th></tr></thead><tbody>${rows}</tbody>`;
    }
    $('#mAdd').onclick = async ()=>{
      const d=$('#mDate').value, c=Number($('#mCount').value||0);
      if(!d) return alert('Choisis une date');
      if(c<0) return alert('Nombre invalide');
      const i=manualEntries.findIndex(x=>x.date===d);
      if(i>-1) manualEntries[i].count=c; else manualEntries.push({date:d,count:c});
      localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
      renderManualTable();
      if(currentUser){ await db.collection('users').doc(currentUser.uid).collection('manual_entries').doc(d).set({date:d,count:c,updatedAt:Date.now()}); }
      if(reconciledData.length){ displayAll(); }
    };
    window.delManual = async (date)=>{
      manualEntries = manualEntries.filter(x=>x.date!==date);
      localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
      renderManualTable();
      if(currentUser){ await db.collection('users').doc(currentUser.uid).collection('manual_entries').doc(date).delete().catch(()=>{}); }
      if(reconciledData.length){ displayAll(); }
    };
    $('#mExport').onclick = ()=>{
      if(!manualEntries.length) return alert('Aucune saisie');
      const rows=[["Date","Nombre d'actes"]].concat(manualEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(x=>[x.date,x.count]));
      const ws=XLSX.utils.aoa_to_sheet(rows), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Saisie'); XLSX.writeFile(wb,'saisie_manuelle.csv');
    };
    renderManualTable();

    async function syncManualFromFirestore(){
      if(!currentUser) return;
      const snap = await db.collection('users').doc(currentUser.uid).collection('manual_entries').get();
      const cloud = snap.docs.map(d=>d.data());
      const mapLocal = new Map(manualEntries.map(x=>[x.date,x.count]));
      for(const c of cloud){ if(!mapLocal.has(c.date)) mapLocal.set(c.date,c.count); }
      manualEntries = Array.from(mapLocal, ([date,count])=>({date,count}));
      localStorage.setItem('manualEntries_v1', JSON.stringify(manualEntries));
      renderManualTable();
    }

    // ====== ANALYSE ======
    $('#btnAnalyze').onclick = analyze;
    async function analyze(){
      try{
        actesData=[]; for(const f of actesFiles){ const d=await readExcel(f); actesData=actesData.concat(d); }
        honosData=[]; for(const f of honosFiles){ const d=await readCSV(f);   honosData=honosData.concat(d); }
        reconcile();
        displayAll();
        if(currentUser){ await saveMonthlyRecapToFirestore(); }
      }catch(e){ console.error(e); alert('Erreur d\'analyse : '+e.message); }
    }
    function readExcel(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=e=>{ try{
          const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];
          const A=XLSX.utils.sheet_to_json(ws,{header:1});
          let hi=-1; for(let i=0;i<A.length;i++){ if(A[i].some(c=>String(c||"").toLowerCase().includes("num√©ro de dossier"))){ hi=i; break; } }
          if(hi===-1) return reject(new Error('En-t√™te non trouv√© dans Excel actes'));
          const headers=A[hi], rows=A.slice(hi+1);
          const out=rows.map(row=>{const o={}; headers.forEach((h,i)=>o[h]=row[i]); return o;}).filter(r=>r['Nom']&&r['Num√©ro de dossier']);
          resolve(out);
        }catch(err){ reject(err);} };
        r.onerror=reject; r.readAsArrayBuffer(file);
      });
    }
    function readCSV(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{encoding:'ISO-8859-1',delimiter:';',skipEmptyLines:true,complete:res=>{
          try{
            if(res.data.length<7) return reject(new Error('CSV honoraires incomplet'));
            const headers=["Praticien","Dossier","Patient","Libell√©","Transfert","Date Acte","Serv.","Coeff.","Pertes","Mt Hors D√©pass.","D√©pass.","Total","Vide"];
            const data=res.data.slice(6).map(row=>{
              if(!row||row.length<6) return null;
              const o={}; headers.forEach((h,i)=>o[h]=(row[i]?row[i].replace(/"/g,'').trim():''));
              o['Date Acte']=normalizeDateString(o['Date Acte']);
              o['Total']=parseFrNumber(o['Total']);
              o['Dossier']=normalizeDossier(o['Dossier']);
              o['Patient_norm']=normalizeString(o['Patient']);
              return o;
            }).filter(x=>x && x['Dossier'] && x['Date Acte']);
            resolve(data);
          }catch(err){ reject(err); }
        }, error:reject});
      });
    }
    function normalizeDateString(s){
      if(!s) return "";
      const t=String(s).trim();
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t;
      const m=t.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m) return `${m[3]}/${m[2]}/${m[1]}`;
      const d=new Date(t); return isNaN(d)?t:fmtDate(d);
    }
    function reconcile(){
      const honIndex=new Map();
      for(const h of honosData){
        const key=`${h['Dossier']}|${h['Patient_norm']}|${h['Date Acte']}`;
        if(!honIndex.has(key)) honIndex.set(key,h);
      }
      reconciledData = actesData.map(a=>{
        const dossier=normalizeDossier(a['Num√©ro de dossier']||a['Num√©ro de Dossier']||'');
        const nom=normalizeString(a['Nom']||'');
        const prenom=normalizeString(a['Pr√©nom']||a['Prenom']||'');
        const patientNorm = normalizeString((nom+' '+prenom).trim());
        const d=excelDateToJSDate(a['Date de d√©but']||a['Date']);
        const dateFmt=fmtDate(d);
        const prestation=a['Prestation']||a['Acte']||'';
        const montant=parseFrNumber(a['Prix_Unitaire_Coefficient_Quantit√©']||a['Montant']||a['Tarif']);
        const key=`${dossier}|${patientNorm}|${dateFmt}`;
        const m=honIndex.get(key);
        return {...a,_DOSSIER_NORM:dossier,Nom_Complet:(nom+' '+prenom).trim(),Patient_norm:patientNorm,Date_Formatee:dateFmt,Prestation:prestation,Montant_num:Number(montant)||0,Factur√©:m?'Oui':'Non',D√©tails_Facture:m?(m['Libell√©']||''):""};
      });
    }

    // ====== AFFICHAGES ======
    function displayAll(){
      const total=reconciledData.length;
      const fact=reconciledData.filter(x=>x.Factur√©==='Oui').length;
      const nonf=total-fact;
      const mNon=reconciledData.filter(x=>x.Factur√©==='Non').reduce((s,a)=>s+(a.Montant_num||0),0);
      $('#statsBox').innerHTML=`
        <div class="stat"><div class="v">${total}</div><div>Total actes</div></div>
        <div class="stat"><div class="v">${fact}</div><div>Actes factur√©s</div></div>
        <div class="stat"><div class="v">${nonf}</div><div>Actes non factur√©s</div></div>
        <div class="stat"><div class="v">${fmtMoney(mNon)}</div><div>Montant non factur√©</div></div>
      `;
      displayMonthly();
      displayCompar();
      displayList('non', reconciledData.filter(x=>x.Factur√©==='Non'));
      displayList('oui', reconciledData.filter(x=>x.Factur√©==='Oui'));
      displayList('tous', reconciledData);
      ensureTabs('recap');
    }
    function displayList(tab, data){
      const head=`<thead><tr><th>Date</th><th>Nom Patient</th><th>Dossier</th><th>Prestation</th><th>‚Ç¨</th><th>Statut</th><th>D√©tails</th></tr></thead>`;
      const rows=data.map(r=>`<tr>
        <td>${r.Date_Formatee||''}</td><td>${r.Nom_Complet||''}</td><td>${r._DOSSIER_NORM||''}</td>
        <td>${r.Prestation||''}</td><td>${(r.Montant_num||0).toFixed(2)}</td><td>${r.Factur√©}</td><td>${r.D√©tails_Facture||''}</td>
      </tr>`).join('');
      $('#tab-'+tab).innerHTML=`<table>${head}<tbody>${rows||'<tr><td colspan="7" class="note">Aucune donn√©e</td></tr>'}</tbody></table>`;
    }
    function displayMonthly(){
      const monthly={};
      for(const a of reconciledData){
        const d=a.Date_Formatee; if(!d) continue; const [jj,mm,yy]=d.split('/');
        const key=`${mm}/${yy}`;
        if(!monthly[key]) monthly[key]={ name:`${["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][+mm-1]} ${yy}`, total:0,f:0,nf:0,mt:0,mf:0,mnf:0 };
        const m=a.Montant_num||0; monthly[key].total++; monthly[key].mt+=m; if(a.Factur√©==='Oui'){ monthly[key].f++; monthly[key].mf+=m; } else { monthly[key].nf++; monthly[key].mnf+=m; }
      }
      const keys=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number);const [mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma-mb;});
      if(!keys.length){ $('#tab-recap').innerHTML='<div class="note">Aucune donn√©e mensuelle</div>'; return; }
      let html='<table><thead><tr><th>Mois</th><th>Total</th><th>Factur√©s</th><th>Non factur√©s</th><th>Taux</th><th>Montant total</th><th>Montant factur√©</th><th>Montant non factur√©</th></tr></thead><tbody>';
      const tot={t:0,f:0,nf:0,mt:0,mf:0,mnf:0};
      for(const k of keys){
        const d=monthly[k], taux=d.total?(d.f/d.total*100).toFixed(1)+'%':'0%';
        html+=`<tr><td><strong>${d.name}</strong></td><td>${d.total}</td><td>${d.f}</td><td>${d.nf}</td><td>${taux}</td><td>${d.mt.toFixed(2)}</td><td>${d.mf.toFixed(2)}</td><td>${d.mnf.toFixed(2)}</td></tr>`;
        tot.t+=d.total; tot.f+=d.f; tot.nf+=d.nf; tot.mt+=d.mt; tot.mf+=d.mf; tot.mnf+=d.mnf;
      }
      const tauxG=tot.t?(tot.f/tot.t*100).toFixed(1)+'%':'0%';
      html+=`<tr style="background:#f8f9fa;font-weight:700"><td>TOTAL</td><td>${tot.t}</td><td>${tot.f}</td><td>${tot.nf}</td><td>${tauxG}</td><td>${tot.mt.toFixed(2)}</td><td>${tot.mf.toFixed(2)}</td><td>${tot.mnf.toFixed(2)}</td></tr>`;
      html+='</tbody></table>';
      $('#tab-recap').innerHTML=html;
    }
    function displayCompar(){
      const imp={}, man={};
      for(const a of reconciledData){ const d=a.Date_Formatee; if(!d) continue; imp[d]=(imp[d]||0)+1; }
      for(const e of manualEntries){ const d=new Date(e.date); if(!isNaN(d)) man[fmtDate(d)]=Number(e.count||0); }
      const all=Array.from(new Set([...Object.keys(imp),...Object.keys(man)])).sort((a,b)=>{const [ja,ma,ya]=a.split('/').map(Number);const [jb,mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma!==mb?ma-mb:ja-jb;});
      if(!all.length){ $('#tab-compar').innerHTML='<div class="note">Aucune donn√©e de comparaison</div>'; return; }
      let h='<table><thead><tr><th>Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî (Manuel - Import√©)</th></tr></thead><tbody>';
      for(const d of all){ const m=man[d]||0, i=imp[d]||0, e=m-i; const st=e>0?'style="color:#28a745;font-weight:700"':(e<0?'style="color:#e74c3c;font-weight:700"':''); h+=`<tr><td>${d}</td><td>${m}</td><td>${i}</td><td ${st}>${e>0?'+':''}${e}</td></tr>`; }
      h+='</tbody></table>'; $('#tab-compar').innerHTML=h;
    }
    ['recap','compar','non','oui','tous'].forEach(t=>$('#tabBtn-'+t).onclick=()=>ensureTabs(t));
    $('#btnExportRecap').onclick=()=>{
      const monthly={}; for(const a of reconciledData){ const d=a.Date_Formatee; if(!d) continue; const [jj,mm,yy]=d.split('/'); const key=`${mm}/${yy}`; if(!monthly[key]) monthly[key]={name:`${["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][+mm-1]} ${yy}`,total:0,f:0,nf:0,mt:0,mf:0,mnf:0}; const m=a.Montant_num||0; monthly[key].total++; monthly[key].mt+=m; if(a.Factur√©==='Oui'){monthly[key].f++; monthly[key].mf+=m;} else {monthly[key].nf++; monthly[key].mnf+=m;} }
      const keys=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number);const [mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma-mb;});
      const out=keys.map(k=>{const d=monthly[k]; const taux=d.total?(d.f/d.total*100).toFixed(1)+'%':'0%'; return {"Mois":d.name,"Total Actes":d.total,"Actes Factur√©s":d.f,"Actes Non Factur√©s":d.nf,"Taux":taux,"Montant Total (‚Ç¨)":d.mt.toFixed(2),"Montant Factur√© (‚Ç¨)":d.mf.toFixed(2),"Montant Non Factur√© (‚Ç¨)":d.mnf.toFixed(2)};});
      const ws=XLSX.utils.json_to_sheet(out), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'R√©cap'); XLSX.writeFile(wb,'recap_mensuel.xlsx');
    };
    $('#btnExportCompar').onclick=()=>{
      const imp={}, man={}; for(const a of reconciledData){ const d=a.Date_Formatee; if(!d) continue; imp[d]=(imp[d]||0)+1; } for(const e of manualEntries){ const d=new Date(e.date); if(!isNaN(d)) man[fmtDate(d)]=Number(e.count||0); }
      const all=Array.from(new Set([...Object.keys(imp),...Object.keys(man)])).sort((a,b)=>{const [ja,ma,ya]=a.split('/').map(Number);const [jb,mb,yb]=b.split('/').map(Number);return ya!==yb?ya-yb:ma!==mb?ma-mb:ja-jb;});
      const out=all.map(d=>({Date:d,Manuel:man[d]||0,"Import√© (actes)":imp[d]||0,"Œî (Manuel - Import√©)":(man[d]||0)-(imp[d]||0)}));
      const ws=XLSX.utils.json_to_sheet(out), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Comparaison'); XLSX.writeFile(wb,'comparaison_quotidienne.xlsx');
    };

    // ====== FIRESTORE : SAUVEGARDE R√âCAP ======
    async function saveMonthlyRecapToFirestore(){
      if(!currentUser) return;
      const monthly={};
      for(const a of reconciledData){
        const d=a.Date_Formatee; if(!d) continue; const [jj,mm,yy]=d.split('/');
        const key=`${yy}-${mm}`;
        if(!monthly[key]) monthly[key]={month:key,total:0,factures:0,nonFactures:0,montantTotal:0,montantFacture:0,montantNonFacture:0};
        const m=a.Montant_num||0; monthly[key].total++; monthly[key].montantTotal+=m; if(a.Factur√©==='Oui'){ monthly[key].factures++; monthly[key].montantFacture+=m; } else { monthly[key].nonFactures++; monthly[key].montantNonFacture+=m; }
      }
      for(const [k,v] of Object.entries(monthly)){
        await db.collection('users').doc(currentUser.uid).collection('reconciliations').doc(k).set({...v, updatedAt: Date.now()});
      }
    }
    function bindHistorique(uid){
      db.collection('users').doc(uid).collection('reconciliations').orderBy('month','desc').onSnapshot(snap=>{
        const arr=snap.docs.map(d=>d.data());
        if(!arr.length){ $('#histList').innerHTML='<div class="note">Aucune analyse sauvegard√©e</div>'; return; }
        $('#histList').innerHTML = arr.map(r=>{
          const taux = r.total ? (r.factures/r.total*100).toFixed(1) : '0';
          const dt   = new Date(r.updatedAt||Date.now());
          return `<div class="card"><div class="section-title">üìÖ ${r.month}</div>
            <div class="note">Analys√© le ${dt.toLocaleDateString('fr-FR')}</div>
            <div class="grid" style="margin-top:8px">
              <div class="stat"><div class="v">${r.total}</div><div>Total</div></div>
              <div class="stat"><div class="v">${taux}%</div><div>Taux fact.</div></div>
              <div class="stat"><div class="v">${fmtMoney(r.montantTotal)}</div><div>Montant total</div></div>
            </div></div>`;
        }).join('');
      });
    }

    // ====== STORAGE : UPLOAD + LIST + RELOAD + DELETE ======
    $('#btnUploadCloud').onclick = async ()=>{
      if(!currentUser) return alert('Connecte-toi');
      if(!actesFiles.length && !honosFiles.length) return alert('Aucun fichier s√©lectionn√©');
      try{
        const uploads=[...actesFiles.map(f=>({f,folder:'actes'})), ...honosFiles.map(f=>({f,folder:'honoraires'}))];
        for(const u of uploads){
          const path=`users/${currentUser.uid}/${u.folder}/${Date.now()}_${u.f.name}`;
          const ref = st.ref(path);
          await ref.put(u.f);
          const url=await ref.getDownloadURL();
          await db.collection('users').doc(currentUser.uid).collection('uploads').add({
            kind:u.folder, filename:u.f.name, path, url, uploadedAt: Date.now(), processed:false
          });
        }
        alert('Upload termin√© ‚úÖ');
        await listCloudFiles();
      }catch(e){ alert('Upload √©chou√© : '+e.message); }
    };

    async function listCloudFiles(){
      if(!currentUser) return;
      $('#cloudListActes').innerHTML='<div class="note">Chargement‚Ä¶</div>';
      $('#cloudListHonos').innerHTML='<div class="note">Chargement‚Ä¶</div>';
      const baseActes = st.ref(`users/${currentUser.uid}/actes`);
      const baseHonos = st.ref(`users/${currentUser.uid}/honoraires`);
      const [la, lh]  = await Promise.all([safeList(baseActes), safeList(baseHonos)]);
      renderCloudList('actes', la);
      renderCloudList('honos', lh);
    }
    async function safeList(ref){
      try{ const res=await ref.listAll(); return res.items || []; }catch(e){ return []; }
    }
    function renderCloudList(kind, items){
      const list = kind==='actes' ? $('#cloudListActes') : $('#cloudListHonos');
      if(!items.length){ list.innerHTML='<div class="note">Aucun fichier</div>'; return; }
      Promise.all(items.map(async it=>{
        const url=await it.getDownloadURL().catch(()=>null);
        const meta=await it.getMetadata().catch(()=>({name:it.name,size:0}));
        return {ref:it, url, name:meta.name||it.name, size:meta.size||0, fullPath:it.fullPath};
      })).then(files=>{
        list.innerHTML = files.sort((a,b)=>b.fullPath.localeCompare(a.fullPath)).map(f=>`
          <div class="file-pill">
            <div>${kind==='actes'?'üìä':'üí∞'} ${f.name} <span class="note">(${(f.size/1024).toFixed(1)} KB)</span></div>
            <div class="row">
              <button class="btn small" onclick="reloadFromCloud('${kind}','${encodeURIComponent(f.fullPath)}')">R√©importer</button>
              <button class="x" onclick="deleteFromCloud('${encodeURIComponent(f.fullPath)}')">Suppr</button>
            </div>
          </div>`).join('');
      });
    }
    window.reloadFromCloud = async (kind, encPath)=>{
      const fullPath = decodeURIComponent(encPath);
      try{
        const ref = st.ref(fullPath);
        const url = await ref.getDownloadURL();
        const blob = await (await fetch(url,{cache:'no-store'})).blob();
        const file = new File([blob], fullPath.split('/').pop()||'cloudfile', { type: blob.type || (kind==='actes'?'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':'text/csv') });
        if(kind==='actes') actesFiles=[file]; else honosFiles=[file];
        renderLocalList(kind==='actes'?'actes':'honos');
        checkReady();
        alert('Fichier charg√© depuis le cloud. Cliquez "Analyser & r√©concilier".');
      }catch(e){ alert('Impossible de r√©importer : '+e.message); }
    };
    window.deleteFromCloud = async (encPath)=>{
      const fullPath=decodeURIComponent(encPath);
      if(!confirm('Supprimer ce fichier du cloud ?')) return;
      try{
        await st.ref(fullPath).delete();
        // Supprimer la trace dans uploads (optionnel)
        if(currentUser){
          const q=await db.collection('users').doc(currentUser.uid).collection('uploads').where('path','==',fullPath).get();
          const batch = db.batch();
          q.forEach(doc=>batch.delete(doc.ref));
          await batch.commit();
        }
        await listCloudFiles();
      }catch(e){ alert('Suppression impossible : '+e.message); }
    };

  </script>
</body>
</html>
