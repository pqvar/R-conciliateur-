<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√©conciliation des Actes M√©dicaux - Dr Pablo NEEL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;min-height:100vh}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2em;margin-bottom:10px}
    .content{padding:30px}

    .upload-section{background:#f8f9fa;border-radius:10px;padding:25px;margin-bottom:30px}
    .upload-section h2{color:#667eea;margin-bottom:20px;font-size:1.5em}
    .file-input-group{margin-bottom:20px}
    .file-input-group label{display:block;font-weight:600;color:#333;margin-bottom:8px;font-size:1.05em}
    .file-input-wrapper{position:relative;display:inline-block;width:100%}
    .file-input-wrapper input[type=file]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
    .file-input-button{display:block;padding:12px 20px;background:#fff;border:2px dashed #667eea;border-radius:8px;color:#667eea;font-weight:600;cursor:pointer;transition:.3s;text-align:center}
    .file-input-button:hover{background:#667eea;color:#fff}
    .files-list{margin-top:15px}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:#e8eaf6;border-radius:5px;margin-bottom:8px;transition:.3s}
    .file-item:hover{background:#d1d4e8}
    .file-info{display:flex;align-items:center;gap:10px;flex:1}
    .file-name{font-weight:600;color:#5e35b1}
    .file-size{font-size:.85em;color:#666}
    .remove-file-btn{padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:.9em;transition:.3s}
    .remove-file-btn:hover{background:#d32f2f;transform:scale(1.05)}

    .action-buttons{display:flex;gap:15px;margin-top:25px;flex-wrap:wrap}
    .btn{padding:15px 30px;border:none;border-radius:8px;font-size:1.05em;font-weight:600;cursor:pointer;transition:.3s}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-secondary:hover{background:#5a6268}

    .results-section{margin-top:30px;display:none}
    .results-section.show{display:block}

    .tab-buttons{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e0e0e0;flex-wrap:wrap}
    .tab-btn{padding:15px 25px;background:transparent;border:none;border-bottom:3px solid transparent;font-size:1.05em;font-weight:600;color:#666;cursor:pointer;transition:.3s}
    .tab-btn.active{color:#667eea;border-bottom-color:#667eea}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:left;font-weight:600;position:sticky;top:0}
    td{padding:12px 15px;border-bottom:1px solid #e0e0e0}
    tr:hover{background:#f8f9fa}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:10px;text-align:center}
    .stat-card.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
    .stat-card.warning{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .stat-value{font-size:2.5em;font-weight:700;margin-bottom:5px}
    .stat-label{font-size:1em;opacity:.9}

    .status-badge{padding:5px 12px;border-radius:20px;font-size:.85em;font-weight:600}
    .status-factured{background:#d4edda;color:#155724}
    .status-not-factured{background:#f8d7da;color:#721c24}

    .export-btn{margin-top:20px;padding:12px 25px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.3s}
    .export-btn:hover{background:#218838;transform:translateY(-2px)}

    .loading{display:none;text-align:center;padding:20px}
    .loading.show{display:block}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <p>Suivi des actes factur√©s et non factur√©s ‚Äî Ajoutez vos fichiers mensuels progressivement</p>
    </div>

    <div class="content">
      <!-- Upload -->
      <div class="upload-section">
        <h2>üìÅ Chargement des fichiers</h2>
        <p style="color:#666;margin-bottom:20px;font-size:.95em">
          üí° <strong>Astuce :</strong> vous pouvez ajouter plusieurs fichiers progressivement puis lancer l‚Äôanalyse.
        </p>

        <div class="file-input-group">
          <label>Fichiers des actes r√©alis√©s (Excel)</label>
          <div class="file-input-wrapper">
            <input type="file" id="actesFile" accept=".xlsx,.xls" multiple style="display:none">
            <button class="file-input-button" onclick="document.getElementById('actesFile').click()">üìä Ajouter un fichier Excel des actes</button>
          </div>
          <div id="actesFilesList" class="files-list"></div>
        </div>

        <div class="file-input-group">
          <label>Fichiers des honoraires factur√©s (CSV)</label>
          <div class="file-input-wrapper">
            <input type="file" id="honorairesFiles" accept=".csv" multiple style="display:none">
            <button class="file-input-button" onclick="document.getElementById('honorairesFiles').click()">üí∞ Ajouter des fichiers CSV des honoraires</button>
          </div>
          <div id="honorairesFilesList" class="files-list"></div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="analyzeBtn" disabled>üîç Analyser et r√©concilier</button>
          <button class="btn btn-secondary" id="resetBtn">üîÑ R√©initialiser</button>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyse en cours‚Ä¶</p>
      </div>

      <!-- R√©sultats -->
      <div class="results-section" id="results">
        <div class="stats" id="stats"></div>

        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="recap">üìä R√©capitulatif Mensuel</button>
          <button class="tab-btn" data-tab="non-factures">‚ùå Actes non factur√©s</button>
          <button class="tab-btn" data-tab="factures">‚úÖ Actes factur√©s</button>
          <button class="tab-btn" data-tab="tous">üìã Tous les actes</button>
          <!-- ‚ûï Onglet Comparaison quotidienne -->
          <button class="tab-btn" data-tab="comparaison">üìä Comparaison quotidienne</button>
        </div>

        <div class="tab-content active" id="tab-recap">
          <div id="monthly-summary"></div>
          <div class="table-wrapper" style="margin-top:30px">
            <table id="table-monthly"></table>
          </div>
          <button class="export-btn" onclick="exportMonthlyReport()">üì• Exporter le r√©capitulatif mensuel (Excel)</button>
        </div>

        <div class="tab-content" id="tab-non-factures">
          <div class="table-wrapper"><table id="table-non-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('non-factures')">üì• Exporter les actes non factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-factures">
          <div class="table-wrapper"><table id="table-factures"></table></div>
          <button class="export-btn" onclick="exportToExcel('factures')">üì• Exporter les actes factur√©s (Excel)</button>
        </div>

        <div class="tab-content" id="tab-tous">
          <div class="table-wrapper"><table id="table-tous"></table></div>
          <button class="export-btn" onclick="exportToExcel('tous')">üì• Exporter tous les actes (Excel)</button>
        </div>

        <!-- ‚ûï Contenu Comparaison quotidienne -->
        <div class="tab-content" id="tab-comparaison">
          <div class="table-wrapper">
            <table id="table-comparaison"></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== √âTAT ===== */
    let actesFiles = [];
    let honorairesFiles = [];
    let actesData = [];
    let honorairesData = [];
    let reconciledData = [];
    let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]'); // [{date:'YYYY-MM-DD', count:n}]

    /* ===== Utilitaires ===== */
    function fmtSize(b){ if(b===0) return '0 B'; const k=1024,s=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(k)); return Math.round(b/Math.pow(k,i)*100)/100+' '+s[i]; }
    function parseFrenchNumber(v){ if(v==null) return 0; if(typeof v==='number') return v; const s=String(v).replace(/\s/g,''); return parseFloat(s.replace(/\./g,'').replace(/,/g,'.'))||0; }
    function excelDateToJSDate(serial){
      if(!serial&&serial!==0) return null;
      if(serial instanceof Date) return new Date(serial.getFullYear(),serial.getMonth(),serial.getDate());
      if(typeof serial==='string'){ const m=serial.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]); const m2=serial.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m2) return new Date(+m2[1],+m2[2]-1,+m2[3]); const d=new Date(serial); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
      const utcDays=Math.floor(serial-25569); const utcValue=utcDays*86400; const dateInfo=new Date(utcValue*1000);
      return new Date(dateInfo.getFullYear(),dateInfo.getMonth(),dateInfo.getDate());
    }
    function formatDate(d){ if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function normalizeString(s=''){ return s.toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s'-]/g,' ').replace(/\s+/g,' ').trim().toUpperCase(); }
    function normalizeDossier(d=''){ return d.toString().replace(/\D/g,'').replace(/^0+/,''); }
    function toMoney(n){ return (Number(n)||0).toFixed(2)+'‚Ç¨'; }

    /* ===== Fichiers: UI ===== */
    document.getElementById('actesFile').addEventListener('change',(e)=>{
      [...e.target.files].forEach(f=>{ if(!actesFiles.find(x=>x.name===f.name&&x.size===f.size)) actesFiles.push(f); });
      updateFilesList('actes'); checkReady(); e.target.value='';
    });
    document.getElementById('honorairesFiles').addEventListener('change',(e)=>{
      [...e.target.files].forEach(f=>{ if(!honorairesFiles.find(x=>x.name===f.name&&x.size===f.size)) honorairesFiles.push(f); });
      updateFilesList('honoraires'); checkReady(); e.target.value='';
    });
    function updateFilesList(type){
      const files= type==='actes'?actesFiles:honorairesFiles;
      const el = document.getElementById(type==='actes'?'actesFilesList':'honorairesFilesList');
      el.innerHTML = files.map((file,i)=>`
        <div class="file-item">
          <div class="file-info">
            <div>${type==='actes'?'üìä':'üí∞'}</div>
            <div><div class="file-name">${file.name}</div><div class="file-size">${fmtSize(file.size)}</div></div>
          </div>
          <button class="remove-file-btn" onclick="removeFile('${type}',${i})">‚úï Supprimer</button>
        </div>`).join('');
    }
    function removeFile(type,i){ (type==='actes'?actesFiles:honorairesFiles).splice(i,1); updateFilesList(type); checkReady(); }
    function checkReady(){ document.getElementById('analyzeBtn').disabled = !(actesFiles.length && honorairesFiles.length); }

    // Onglets
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',function(){
        const tab=this.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
      });
    });

    document.getElementById('analyzeBtn').addEventListener('click', analyzeFiles);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      actesFiles=[]; honorairesFiles=[]; actesData=[]; honorairesData=[]; reconciledData=[];
      updateFilesList('actes'); updateFilesList('honoraires'); checkReady();
      document.getElementById('results').classList.remove('show');
    });

    /* ===== Lecture fichiers ===== */
    async function analyzeFiles(){
      document.getElementById('loading').classList.add('show');
      document.getElementById('results').classList.remove('show');
      try{
        actesData=[]; for(const f of actesFiles){ actesData = actesData.concat(await readExcelFile(f)); }
        honorairesData=[]; for(const f of honorairesFiles){ honorairesData = honorairesData.concat(await readCSVFile(f)); }
        reconcileData(); displayResults();
        document.getElementById('loading').classList.remove('show');
        document.getElementById('results').classList.add('show');
      }catch(err){
        console.error(err); alert("Erreur lors de l'analyse des fichiers : "+err.message);
        document.getElementById('loading').classList.remove('show');
      }
    }

    function readExcelFile(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=(e)=>{
          try{
            const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
            const sh=wb.Sheets[wb.SheetNames[0]];
            const data=XLSX.utils.sheet_to_json(sh,{header:1});
            let headerRow=-1;
            for(let i=0;i<data.length;i++){
              if (data[i].some(cell=>String(cell||'').toLowerCase().includes('num√©ro de dossier'))) { headerRow=i; break; }
            }
            if(headerRow===-1) return reject(new Error("En-t√™te non trouv√© dans l'Excel"));
            const headers=data[headerRow];
            const rows=data.slice(headerRow+1);
            const arr=rows.map(r=>{ const o={}; headers.forEach((h,idx)=>o[h]=r[idx]); return o; })
                          .filter(r=>r['Nom'] && r['Num√©ro de dossier']);
            resolve(arr);
          }catch(err){reject(err);}
        };
        reader.onerror=reject; reader.readAsArrayBuffer(file);
      });
    }

    function readCSVFile(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{
          encoding:'ISO-8859-1', delimiter:';', skipEmptyLines:true,
          complete:(results)=>{
            try{
              if(results.data.length<7) return reject(new Error('Le fichier CSV ne contient pas assez de lignes'));
              const headers=['Praticien','Dossier','Patient','Libell√©','Transfert','Date Acte','Serv.','Coeff.','Pertes','Mt Hors D√©pass.','D√©pass.','Total','Vide'];
              const rows=results.data.slice(6);
              const arr=rows.map(row=>{
                if(!row || row.length<6) return null;
                const o={}; headers.forEach((h,i)=>o[h]=(row[i]?row[i].replace(/"/g,'').trim():''));
                o['Date Acte'] = normalizeDate(o['Date Acte']);
                o['Total'] = parseFrenchNumber(o['Total']);
                o['Dossier'] = normalizeDossier(o['Dossier']);
                o['Patient_norm'] = normalizeString(o['Patient']);
                return o;
              }).filter(o=>o && o['Dossier'] && o['Date Acte']);
              resolve(arr);
            }catch(err){reject(err);}
          },
          error:reject
        });
      });
    }
    function normalizeDate(s){
      if(!s) return '';
      const t=String(s).trim();
      const m1=t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m1) return t;
      const m2=t.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m2) return `${m2[3]}/${m2[2]}/${m2[1]}`;
      const d=new Date(t); return isNaN(d)?'':formatDate(d);
    }

    /* ===== R√©conciliation ===== */
    function reconcileData(){
      const honIndex=new Map();
      for(const h of honorairesData){
        const key=`${h['Dossier']}|${h['Patient_norm']}|${h['Date Acte']}`;
        if(!honIndex.has(key)) honIndex.set(key,h);
      }

      reconciledData = actesData.map(a=>{
        const dossier = normalizeDossier(a['Num√©ro de dossier']||a['Num√©ro de Dossier']||'');
        const nom = normalizeString(a['Nom']||'');
        const prenom = normalizeString(a['Pr√©nom']||a['Prenom']||'');
        const patientNorm = normalizeString(`${nom} ${prenom}`.trim());
        const dActe = excelDateToJSDate(a['Date de d√©but']||a['Date']);
        const dateFr = formatDate(dActe);
        const montant = parseFrenchNumber(a['Prix_Unitaire_Coefficient_Quantit√©']||a['Montant']||a['Tarif']);
        const key = `${dossier}|${patientNorm}|${dateFr}`;
        const match = honIndex.get(key);

        return {
          ...a,
          _DOSSIER_NORM: dossier,
          Nom_Complet: `${nom} ${prenom}`.trim(),
          Patient_norm: patientNorm,
          Date_Formatt√©e: dateFr,
          Montant_num: Number(montant)||0,
          Factur√©: match ? 'Oui' : 'Non',
          D√©tails_Facture: match ? (match['Libell√©']||'N/A') : ''
        };
      });
    }

    /* ===== Affichage principal ===== */
    function displayResults(){
      const total=reconciledData.length;
      const fact=reconciledData.filter(a=>a['Factur√©']==='Oui').length;
      const nonf=total-fact;
      const nonfMontant=reconciledData.filter(a=>a['Factur√©']!=='Oui').reduce((s,a)=>s+(a.Montant_num||0),0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">Total actes</div></div>
        <div class="stat-card success"><div class="stat-value">${fact}</div><div class="stat-label">Actes factur√©s</div></div>
        <div class="stat-card warning"><div class="stat-value">${nonf}</div><div class="stat-label">Actes non factur√©s</div></div>
        <div class="stat-card warning"><div class="stat-value">${toMoney(nonfMontant)}</div><div class="stat-label">Montant non factur√©</div></div>
      `;

      renderTable('non-factures', reconciledData.filter(a=>a['Factur√©']!=='Oui'));
      renderTable('factures', reconciledData.filter(a=>a['Factur√©']==='Oui'));
      renderTable('tous', reconciledData);
      renderMonthlySummary();
      renderComparaisonQuotidienne(); // <= comparatif quotidien
    }

    function renderTable(type,data){
      const table=document.getElementById(`table-${type}`);
      if(!data.length){ table.innerHTML='<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e √† afficher</p>'; return; }
      let html='<thead><tr><th>Date</th><th>Nom Patient</th><th>N¬∞ Dossier</th><th>Prestation</th><th>Montant</th><th>Statut</th><th>D√©tails</th></tr></thead><tbody>';
      for(const r of data){
        const ok=r['Factur√©']==='Oui';
        html+=`<tr>
          <td>${r['Date_Formatt√©e']||''}</td>
          <td>${r['Nom_Complet']||''}</td>
          <td>${r['_DOSSIER_NORM']||''}</td>
          <td>${r['Prestation']||''}</td>
          <td>${toMoney(r['Montant_num'])}</td>
          <td><span class="status-badge ${ok?'status-factured':'status-not-factured'}">${ok?'‚úì Factur√©':'‚úó Non factur√©'}</span></td>
          <td>${r['D√©tails_Facture']||''}</td>
        </tr>`;
      }
      table.innerHTML = html+'</tbody>';
    }

    /* ===== R√©cap Mensuel (identique) ===== */
    function renderMonthlySummary(){
      const monthly={};
      for(const a of reconciledData){
        const d=a['Date_Formatt√©e']; if(!d) continue;
        const [jj,mm,yy]=d.split('/');
        const key=`${mm}/${yy}`;
        if(!monthly[key]) monthly[key]={name:monthName(+mm,+yy),total:0,fact:0,nonf:0,totE:0,fE:0,nfE:0};
        const m=a.Montant_num||0;
        monthly[key].total++; monthly[key].totE+=m;
        if(a['Factur√©']==='Oui'){monthly[key].fact++; monthly[key].fE+=m;} else {monthly[key].nonf++; monthly[key].nfE+=m;}
      }
      const keys=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number); const [mb,yb]=b.split('/').map(Number); return ya!==yb?ya-yb:ma-mb;});
      // cartes compactes
      let cards='<div class="table-wrapper" style="padding:0"><table><thead><tr><th>Mois</th><th>Total</th><th>Factur√©s</th><th>Non factur√©s</th><th>Taux</th><th>Montant total</th><th>Montant factur√©</th><th>Montant non factur√©</th></tr></thead><tbody>';
      let tot={t:0,f:0,n:0,te:0,fe:0,nfe:0};
      for(const k of keys){
        const d=monthly[k]; const taux=d.total? (d.fact/d.total*100).toFixed(1):0;
        cards+=`<tr>
          <td><strong>${d.name}</strong></td><td>${d.total}</td>
          <td style="color:#28a745">${d.fact}</td><td style="color:#e74c3c">${d.nonf}</td>
          <td><strong>${taux}%</strong></td>
          <td>${toMoney(d.totE)}</td><td style="color:#28a745">${toMoney(d.fE)}</td><td style="color:#e74c3c">${toMoney(d.nfE)}</td>
        </tr>`;
        tot.t+=d.total; tot.f+=d.fact; tot.n+=d.nonf; tot.te+=d.totE; tot.fe+=d.fE; tot.nfe+=d.nfE;
      }
      if(keys.length>1){
        const tauxG=tot.t? (tot.f/tot.t*100).toFixed(1):0;
        cards+=`<tr style="background:#f8f9fa;font-weight:700;border-top:2px solid #667eea">
          <td>TOTAL</td><td>${tot.t}</td><td style="color:#28a745">${tot.f}</td><td style="color:#e74c3c">${tot.n}</td>
          <td>${tauxG}%</td><td>${toMoney(tot.te)}</td><td style="color:#28a745">${toMoney(tot.fe)}</td><td style="color:#e74c3c">${toMoney(tot.nfe)}</td>
        </tr>`;
      }
      cards+='</tbody></table></div>';
      document.getElementById('monthly-summary').innerHTML=cards;

      // tableau d√©taill√© d√©j√† pr√©sent
      document.getElementById('table-monthly').innerHTML=''; // (on laisse le tableau compact ci-dessus)
    }
    function monthName(m,y){const M=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];return `${M[m-1]} ${y}`;}

    /* ===== COMPARAISON QUOTIDIENNE (version qui marchait) ===== */
    function ymdToFr(ymd){ const m=ymd && ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/); return m?`${m[3]}/${m[2]}/${m[1]}`:''; }
    function filesCountsByDay(){
      const map=new Map();
      for(const a of (reconciledData||[])){
        const d=a['Date_Formatt√©e']||a['Date_Formatee'];
        if(!d) continue;
        map.set(d,(map.get(d)||0)+1);
      }
      return map;
    }
    function buildDailyRows(){
      const fichiers=filesCountsByDay();
      const manuel=new Map();
      for(const e of (manualEntries||[])){
        const d=ymdToFr(e.date); if(!d) continue;
        manuel.set(d,(manuel.get(d)||0)+Number(e.count||0));
      }
      const all=new Set([...fichiers.keys(),...manuel.keys()]);
      const sorted=[...all].sort((A,B)=>{
        const [ad,am,ay]=A.split('/').map(Number);
        const [bd,bm,by]=B.split('/').map(Number);
        return new Date(ay,am-1,ad)-new Date(by,bm-1,bd);
      });
      return sorted.map(date=>{
        const imp=fichiers.get(date)||0;
        const man=manuel.get(date)||0;
        return {date,manuel:man,importe:imp,delta:man-imp};
      });
    }
    function renderComparaisonQuotidienne(){
      const table=document.getElementById('table-comparaison');
      if(!table) return;
      const rows=buildDailyRows();
      if(!rows.length){
        table.innerHTML='<p style="padding:20px;text-align:center;color:#666">Aucune donn√©e √† afficher</p>'; return;
      }
      let html='<thead><tr><th style="min-width:140px">Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî (Manuel - Import√©)</th></tr></thead><tbody>';
      let totM=0,totI=0;
      for(const r of rows){
        totM+=r.manuel; totI+=r.importe;
        const cls=r.delta===0?'':(r.delta>0?'style="color:#2e7d32;font-weight:600"':'style="color:#c62828;font-weight:600"');
        html+=`<tr><td>${r.date}</td><td>${r.manuel}</td><td>${r.importe}</td><td ${cls}>${r.delta}</td></tr>`;
      }
      const totD=totM-totI;
      const clsTot=totD===0?'':(totD>0?'style="color:#2e7d32;font-weight:700"':'style="color:#c62828;font-weight:700"');
      html+=`<tr style="background:#f8f9fa;font-weight:700;border-top:2px solid #667eea">
        <td>TOTAUX</td><td>${totM}</td><td>${totI}</td><td ${clsTot}>${totD}</td>
      </tr></tbody>`;
      table.innerHTML=html;
    }

    /* ===== Exports ===== */
    function exportMonthlyReport(){
      const monthly={};
      for(const a of reconciledData){
        const d=a['Date_Formatt√©e']; if(!d) continue;
        const [jj,mm,yy]=d.split('/'); const key=`${mm}/${yy}`;
        const name=monthName(+mm,+yy);
        if(!monthly[key]) monthly[key]={name,total:0,fact:0,nonf:0,totE:0,fE:0,nfE:0};
        const m=a.Montant_num||0; monthly[key].total++; monthly[key].totE+=m;
        if(a['Factur√©']==='Oui'){ monthly[key].fact++; monthly[key].fE+=m; } else { monthly[key].nonf++; monthly[key].nfE+=m; }
      }
      const keys=Object.keys(monthly).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number); const [mb,yb]=b.split('/').map(Number); return ya!==yb?ya-yb:ma-mb;});
      const rows=keys.map(k=>{const d=monthly[k]; const taux=d.total?((d.fact/d.total*100).toFixed(1)+'%'):'0%';
        return {'Mois':d.name,'Total Actes':d.total,'Actes Factur√©s':d.fact,'Actes Non Factur√©s':d.nonf,'Taux de Facturation':taux,'Montant Total (‚Ç¨)':(d.totE||0).toFixed(2),'Montant Factur√© (‚Ç¨)':(d.fE||0).toFixed(2),'Montant Non Factur√© (‚Ç¨)':(d.nfE||0).toFixed(2)};});
      const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'R√©capitulatif Mensuel');
      const now=new Date(); const name=`Recapitulatif_Mensuel_${now.getFullYear()}_${String(now.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb,name);
    }
    function exportToExcel(type){
      let data, filename;
      if(type==='non-factures'){ data=reconciledData.filter(a=>a['Factur√©']!=='Oui'); filename='actes_non_factures.xlsx'; }
      else if(type==='factures'){ data=reconciledData.filter(a=>a['Factur√©']==='Oui'); filename='actes_factures.xlsx'; }
      else { data=reconciledData; filename='tous_les_actes.xlsx'; }
      const rows=data.map(r=>({'Date':r['Date_Formatt√©e'],'Nom Patient':r['Nom_Complet'],'Num√©ro de Dossier':r['_DOSSIER_NORM'],'Prestation':r['Prestation'],'Montant (‚Ç¨)':(r['Montant_num']||0).toFixed(2),'Statut':r['Factur√©'],'D√©tails Facture':r['D√©tails_Facture']}));
      const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Actes'); XLSX.writeFile(wb,filename);
    }
  </script>
</body>
</html>
