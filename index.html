<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©conciliation des Actes M√©dicaux - Dr Pablo NEEL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .upload-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .file-input-group {
            margin-bottom: 20px;
        }
        
        .file-input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-button {
            display: block;
            padding: 12px 20px;
            background: white;
            border: 2px dashed #667eea;
            border-radius: 8px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .file-input-button:hover {
            background: #667eea;
            color: white;
        }
        
        .files-list {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #e8eaf6;
            border-radius: 5px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #d1d4e8;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .file-icon {
            font-size: 1.5em;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #5e35b1;
        }
        
        .file-size {
            font-size: 0.85em;
            color: #666;
        }
        
        .remove-file-btn {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .remove-file-btn:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }
        
        .monthly-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .month-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .month-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .month-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .month-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .month-stat-row:last-child {
            border-bottom: none;
        }
        
        .month-stat-label {
            color: #666;
            font-size: 0.95em;
        }
        
        .month-stat-value {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }
        
        .month-stat-value.success {
            color: #28a745;
        }
        
        .month-stat-value.warning {
            color: #e74c3c;
        }
        
        .month-stat-value.amount {
            color: #667eea;
        }
        
        .comparison-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .comparison-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .results-section {
            margin-top: 30px;
            display: none;
        }
        
        .results-section.show {
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-btn {
            padding: 15px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1.05em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-factured {
            background: #d4edda;
            color: #155724;
        }
        
        .status-not-factured {
            background: #f8d7da;
            color: #721c24;
        }
        
        .export-btn {
            margin-top: 20px;
            padding: 12px 25px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
            <p>Suivi des actes factur√©s et non factur√©s - Ajoutez vos fichiers mensuels progressivement</p>
        </div>
        
        <div class="content">
            <div class="upload-section">
                <h2>üìÅ Chargement des fichiers</h2>
                <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">
                    üí° <strong>Astuce :</strong> Vous pouvez ajouter plusieurs fichiers progressivement. 
                    Cliquez sur "Ajouter" autant de fois que n√©cessaire, puis lancez l'analyse.
                </p>
                
                <div class="file-input-group">
                    <label for="actesFile">Fichiers des actes r√©alis√©s (Excel)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="actesFile" accept=".xlsx,.xls" multiple style="display: none;">
                        <button class="file-input-button" onclick="document.getElementById('actesFile').click()">
                            üìä Ajouter un fichier Excel des actes
                        </button>
                    </div>
                    <div id="actesFilesList" class="files-list"></div>
                </div>
                
                <div class="file-input-group">
                    <label for="honorairesFiles">Fichiers des honoraires factur√©s (CSV)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="honorairesFiles" accept=".csv" multiple style="display: none;">
                        <button class="file-input-button" onclick="document.getElementById('honorairesFiles').click()">
                            üí∞ Ajouter des fichiers CSV des honoraires
                        </button>
                    </div>
                    <div id="honorairesFilesList" class="files-list"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>
                        üîç Analyser et r√©concilier
                    </button>
                    <button class="btn btn-secondary" id="resetBtn">
                        üîÑ R√©initialiser
                    </button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyse en cours...</p>
            </div>
            
            <div class="results-section" id="results">
                <div class="stats" id="stats"></div>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="recap">üìä R√©capitulatif Mensuel</button>
                    <button class="tab-btn" data-tab="non-factures">‚ùå Actes non factur√©s</button>
                    <button class="tab-btn" data-tab="factures">‚úÖ Actes factur√©s</button>
                    <button class="tab-btn" data-tab="tous">üìã Tous les actes</button>
                </div>
                
                <div class="tab-content active" id="tab-recap">
                    <div id="monthly-summary"></div>
                    <div class="table-wrapper" style="margin-top: 30px;">
                        <table id="table-monthly"></table>
                    </div>
                    <button class="export-btn" onclick="exportMonthlyReport()">
                        üì• Exporter le r√©capitulatif mensuel (Excel)
                    </button>
                </div>
                
                <div class="tab-content" id="tab-non-factures">
                    <div class="table-wrapper">
                        <table id="table-non-factures"></table>
                    </div>
                    <button class="export-btn" onclick="exportToExcel('non-factures')">
                        üì• Exporter les actes non factur√©s (Excel)
                    </button>
                </div>
                
                <div class="tab-content" id="tab-factures">
                    <div class="table-wrapper">
                        <table id="table-factures"></table>
                    </div>
                    <button class="export-btn" onclick="exportToExcel('factures')">
                        üì• Exporter les actes factur√©s (Excel)
                    </button>
                </div>
                
                <div class="tab-content" id="tab-tous">
                    <div class="table-wrapper">
                        <table id="table-tous"></table>
                    </div>
                    <button class="export-btn" onclick="exportToExcel('tous')">
                        üì• Exporter tous les actes (Excel)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let actesFiles = [];
        let honorairesFiles = [];
        let actesData = [];
        let honorairesData = [];
        let reconciledData = [];
        
        // Gestion des fichiers d'actes
        document.getElementById('actesFile').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            newFiles.forEach(file => {
                // V√©rifier si le fichier n'est pas d√©j√† ajout√©
                if (!actesFiles.find(f => f.name === file.name && f.size === file.size)) {
                    actesFiles.push(file);
                }
            });
            updateFilesList('actes');
            checkFilesReady();
            e.target.value = ''; // Reset l'input pour permettre de s√©lectionner le m√™me fichier
        });
        
        // Gestion des fichiers d'honoraires
        document.getElementById('honorairesFiles').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            newFiles.forEach(file => {
                // V√©rifier si le fichier n'est pas d√©j√† ajout√©
                if (!honorairesFiles.find(f => f.name === file.name && f.size === file.size)) {
                    honorairesFiles.push(file);
                }
            });
            updateFilesList('honoraires');
            checkFilesReady();
            e.target.value = ''; // Reset l'input
        });
        
        function updateFilesList(type) {
            const files = type === 'actes' ? actesFiles : honorairesFiles;
            const listElement = document.getElementById(type === 'actes' ? 'actesFilesList' : 'honorairesFilesList');
            
            if (files.length === 0) {
                listElement.innerHTML = '';
                return;
            }
            
            listElement.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">${type === 'actes' ? 'üìä' : 'üí∞'}</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button class="remove-file-btn" onclick="removeFile('${type}', ${index})">
                        ‚úï Supprimer
                    </button>
                </div>
            `).join('');
        }
        
        function removeFile(type, index) {
            if (type === 'actes') {
                actesFiles.splice(index, 1);
            } else {
                honorairesFiles.splice(index, 1);
            }
            updateFilesList(type);
            checkFilesReady();
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function checkFilesReady() {
            document.getElementById('analyzeBtn').disabled = !(actesFiles.length > 0 && honorairesFiles.length > 0);
        }
        
        // Bouton d'analyse
        document.getElementById('analyzeBtn').addEventListener('click', analyzeFiles);
        
        // Bouton de r√©initialisation
        document.getElementById('resetBtn').addEventListener('click', function() {
            actesFiles = [];
            honorairesFiles = [];
            updateFilesList('actes');
            updateFilesList('honoraires');
            checkFilesReady();
            document.getElementById('results').classList.remove('show');
        });
        
        // Gestion des onglets
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
            });
        });
        
        async function analyzeFiles() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            
            try {
                // Lire tous les fichiers Excel des actes
                actesData = [];
                for (let file of actesFiles) {
                    const data = await readExcelFile(file);
                    actesData = actesData.concat(data);
                }
                
                // Lire tous les fichiers CSV des honoraires
                honorairesData = [];
                for (let file of honorairesFiles) {
                    const data = await readCSVFile(file);
                    honorairesData = honorairesData.concat(data);
                }
                
                // R√©concilier les donn√©es
                reconcileData();
                
                // Afficher les r√©sultats
                displayResults();
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('results').classList.add('show');
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'analyse des fichiers: ' + error.message);
                document.getElementById('loading').classList.remove('show');
            }
        }
        
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        // Trouver la ligne d'en-t√™te (contient "Num√©ro de dossier")
                        let headerRow = -1;
                        for (let i = 0; i < jsonData.length; i++) {
                            if (jsonData[i].includes('Num√©ro de dossier')) {
                                headerRow = i;
                                break;
                            }
                        }
                        
                        if (headerRow === -1) {
                            reject(new Error('En-t√™te non trouv√© dans le fichier Excel'));
                            return;
                        }
                        
                        const headers = jsonData[headerRow];
                        const dataRows = jsonData.slice(headerRow + 1);
                        
                        const result = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index];
                            });
                            return obj;
                        }).filter(row => row['Nom'] && row['Num√©ro de dossier']);
                        
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    encoding: 'ISO-8859-1',
                    delimiter: ';',
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            // Les 5 premi√®res lignes sont des en-t√™tes informatifs, on les skip
                            // La ligne 6 (index 5) contient les vrais noms de colonnes
                            // On commence √† lire les donn√©es √† partir de la ligne 7 (index 6)
                            
                            if (results.data.length < 7) {
                                reject(new Error('Le fichier CSV ne contient pas assez de lignes'));
                                return;
                            }
                            
                            // D√©finir les noms de colonnes manuellement car il y a un champ vide √† la fin
                            const headers = ['Praticien', 'Dossier', 'Patient', 'Libell√©', 'Transfert', 'Date Acte', 'Serv.', 'Coeff.', 'Pertes', 'Mt Hors D√©pass.', 'D√©pass.', 'Total', 'Vide'];
                            
                            // Extraire les donn√©es √† partir de la ligne 7
                            const dataRows = results.data.slice(6);
                            
                            const result = dataRows.map(row => {
                                if (!row || row.length < 6) return null;
                                
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] ? row[index].replace(/"/g, '').trim() : '';
                                });
                                return obj;
                            }).filter(row => row && row['Dossier'] && row['Date Acte']);
                            
                            resolve(result);
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: reject
                });
            });
        }
        
        function reconcileData() {
            reconciledData = actesData.map(acte => {
                const dossier = String(acte['Num√©ro de dossier']).trim();
                const nom = (acte['Nom'] || '').toUpperCase().trim();
                const prenom = (acte['Pr√©nom'] || '').toUpperCase().trim();
                const nomComplet = `${nom} ${prenom}`;
                const dateActe = excelDateToJSDate(acte['Date de d√©but']);
                const dateFormatted = formatDate(dateActe);
                
                // Chercher une correspondance dans les honoraires
                // Dans les honoraires: Dossier = num√©ro, Patient = nom complet, Date Acte = date format√©e
                const match = honorairesData.find(hon => {
                    const honDossier = String(hon['Dossier']).trim();
                    const honPatient = (hon['Patient'] || '').toUpperCase().trim();
                    const honDate = hon['Date Acte'];
                    
                    return honDossier === dossier && 
                           honPatient === nomComplet && 
                           honDate === dateFormatted;
                });
                
                return {
                    ...acte,
                    'Nom_Complet': nomComplet,
                    'Date_Formatt√©e': dateFormatted,
                    'Factur√©': match ? 'Oui' : 'Non',
                    'D√©tails_Facture': match ? `${match['Libell√©'] || 'N/A'}` : ''
                };
            });
        }
        
        function excelDateToJSDate(serial) {
            if (!serial) return null;
            if (typeof serial === 'string') return new Date(serial);
            const utc_days = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;
            const date_info = new Date(utc_value * 1000);
            return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
        }
        
        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            if (isNaN(d)) return '';
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function displayResults() {
            const totalActes = reconciledData.length;
            const actesFactures = reconciledData.filter(a => a['Factur√©'] === 'Oui').length;
            const actesNonFactures = totalActes - actesFactures;
            const montantTotal = reconciledData.reduce((sum, a) => {
                return sum + (parseFloat(a['Prix_Unitaire_Coefficient_Quantit√©']) || 0);
            }, 0);
            const montantNonFacture = reconciledData.filter(a => a['Factur√©'] === 'Non').reduce((sum, a) => {
                return sum + (parseFloat(a['Prix_Unitaire_Coefficient_Quantit√©']) || 0);
            }, 0);
            
            // Afficher les statistiques
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalActes}</div>
                    <div class="stat-label">Total actes</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value">${actesFactures}</div>
                    <div class="stat-label">Actes factur√©s</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${actesNonFactures}</div>
                    <div class="stat-label">Actes non factur√©s</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${montantNonFacture.toFixed(2)}‚Ç¨</div>
                    <div class="stat-label">Montant non factur√©</div>
                </div>
            `;
            
            // Afficher les tableaux
            displayTable('non-factures', reconciledData.filter(a => a['Factur√©'] === 'Non'));
            displayTable('factures', reconciledData.filter(a => a['Factur√©'] === 'Oui'));
            displayTable('tous', reconciledData);
            
            // Afficher le r√©capitulatif mensuel
            displayMonthlySummary();
        }
        
        function displayMonthlySummary() {
            // Grouper les actes par mois
            const monthlyData = {};
            
            reconciledData.forEach(acte => {
                const date = acte['Date_Formatt√©e'];
                if (!date) return;
                
                // Extraire le mois et l'ann√©e (format: JJ/MM/AAAA)
                const parts = date.split('/');
                if (parts.length !== 3) return;
                
                const monthYear = `${parts[1]}/${parts[2]}`; // MM/AAAA
                const monthName = getMonthName(parseInt(parts[1]), parseInt(parts[2]));
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        name: monthName,
                        total: 0,
                        factures: 0,
                        nonFactures: 0,
                        montantTotal: 0,
                        montantFacture: 0,
                        montantNonFacture: 0,
                        actes: []
                    };
                }
                
                monthlyData[monthYear].total++;
                monthlyData[monthYear].actes.push(acte);
                
                const montant = parseFloat(acte['Prix_Unitaire_Coefficient_Quantit√©']) || 0;
                monthlyData[monthYear].montantTotal += montant;
                
                if (acte['Factur√©'] === 'Oui') {
                    monthlyData[monthYear].factures++;
                    monthlyData[monthYear].montantFacture += montant;
                } else {
                    monthlyData[monthYear].nonFactures++;
                    monthlyData[monthYear].montantNonFacture += montant;
                }
            });
            
            // Trier les mois chronologiquement
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });
            
            // G√©n√©rer le HTML des cartes mensuelles
            let summaryHTML = '<div class="monthly-summary-grid">';
            
            sortedMonths.forEach(monthKey => {
                const data = monthlyData[monthKey];
                const tauxFacturation = data.total > 0 ? (data.factures / data.total * 100).toFixed(1) : 0;
                
                summaryHTML += `
                    <div class="month-card">
                        <h3>üìÖ ${data.name}</h3>
                        <div class="month-stats">
                            <div class="month-stat-row">
                                <span class="month-stat-label">Total actes</span>
                                <span class="month-stat-value">${data.total}</span>
                            </div>
                            <div class="month-stat-row">
                                <span class="month-stat-label">Actes factur√©s</span>
                                <span class="month-stat-value success">${data.factures} (${tauxFacturation}%)</span>
                            </div>
                            <div class="month-stat-row">
                                <span class="month-stat-label">Actes non factur√©s</span>
                                <span class="month-stat-value warning">${data.nonFactures}</span>
                            </div>
                            <div class="month-stat-row">
                                <span class="month-stat-label">Montant total</span>
                                <span class="month-stat-value amount">${data.montantTotal.toFixed(2)}‚Ç¨</span>
                            </div>
                            <div class="month-stat-row">
                                <span class="month-stat-label">Montant factur√©</span>
                                <span class="month-stat-value success">${data.montantFacture.toFixed(2)}‚Ç¨</span>
                            </div>
                            <div class="month-stat-row">
                                <span class="month-stat-label">Montant non factur√©</span>
                                <span class="month-stat-value warning">${data.montantNonFacture.toFixed(2)}‚Ç¨</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            summaryHTML += '</div>';
            
            // Ajouter un tableau comparatif si plusieurs mois
            if (sortedMonths.length > 1) {
                summaryHTML += `
                    <div class="comparison-section">
                        <h3>üìä Comparaison des mois</h3>
                        <p style="color: #666; margin-bottom: 15px;">Vue d'ensemble de l'√©volution mensuelle</p>
                    </div>
                `;
            }
            
            document.getElementById('monthly-summary').innerHTML = summaryHTML;
            
            // G√©n√©rer le tableau d√©taill√©
            displayMonthlyTable(monthlyData, sortedMonths);
        }
        
        function getMonthName(month, year) {
            const monthNames = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            return `${monthNames[month - 1]} ${year}`;
        }
        
        function displayMonthlyTable(monthlyData, sortedMonths) {
            const table = document.getElementById('table-monthly');
            
            if (sortedMonths.length === 0) {
                table.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Aucune donn√©e mensuelle disponible</p>';
                return;
            }
            
            let html = '<thead><tr>';
            html += '<th>Mois</th>';
            html += '<th>Total Actes</th>';
            html += '<th>Factur√©s</th>';
            html += '<th>Non Factur√©s</th>';
            html += '<th>Taux Facturation</th>';
            html += '<th>Montant Total</th>';
            html += '<th>Montant Factur√©</th>';
            html += '<th>Montant Non Factur√©</th>';
            html += '</tr></thead><tbody>';
            
            let totalGeneral = { total: 0, factures: 0, nonFactures: 0, montantTotal: 0, montantFacture: 0, montantNonFacture: 0 };
            
            sortedMonths.forEach(monthKey => {
                const data = monthlyData[monthKey];
                const tauxFacturation = data.total > 0 ? (data.factures / data.total * 100).toFixed(1) : 0;
                
                html += '<tr>';
                html += `<td><strong>${data.name}</strong></td>`;
                html += `<td>${data.total}</td>`;
                html += `<td><span style="color: #28a745; font-weight: 600;">${data.factures}</span></td>`;
                html += `<td><span style="color: #e74c3c; font-weight: 600;">${data.nonFactures}</span></td>`;
                html += `<td><strong>${tauxFacturation}%</strong></td>`;
                html += `<td>${data.montantTotal.toFixed(2)}‚Ç¨</td>`;
                html += `<td style="color: #28a745;">${data.montantFacture.toFixed(2)}‚Ç¨</td>`;
                html += `<td style="color: #e74c3c;">${data.montantNonFacture.toFixed(2)}‚Ç¨</td>`;
                html += '</tr>';
                
                totalGeneral.total += data.total;
                totalGeneral.factures += data.factures;
                totalGeneral.nonFactures += data.nonFactures;
                totalGeneral.montantTotal += data.montantTotal;
                totalGeneral.montantFacture += data.montantFacture;
                totalGeneral.montantNonFacture += data.montantNonFacture;
            });
            
            // Ligne de total si plusieurs mois
            if (sortedMonths.length > 1) {
                const tauxGlobal = totalGeneral.total > 0 ? (totalGeneral.factures / totalGeneral.total * 100).toFixed(1) : 0;
                html += '<tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid #667eea;">';
                html += '<td><strong>TOTAL G√âN√âRAL</strong></td>';
                html += `<td>${totalGeneral.total}</td>`;
                html += `<td style="color: #28a745;">${totalGeneral.factures}</td>`;
                html += `<td style="color: #e74c3c;">${totalGeneral.nonFactures}</td>`;
                html += `<td><strong>${tauxGlobal}%</strong></td>`;
                html += `<td>${totalGeneral.montantTotal.toFixed(2)}‚Ç¨</td>`;
                html += `<td style="color: #28a745;">${totalGeneral.montantFacture.toFixed(2)}‚Ç¨</td>`;
                html += `<td style="color: #e74c3c;">${totalGeneral.montantNonFacture.toFixed(2)}‚Ç¨</td>`;
                html += '</tr>';
            }
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function exportMonthlyReport() {
            // Grouper les actes par mois
            const monthlyData = {};
            
            reconciledData.forEach(acte => {
                const date = acte['Date_Formatt√©e'];
                if (!date) return;
                
                const parts = date.split('/');
                if (parts.length !== 3) return;
                
                const monthYear = `${parts[1]}/${parts[2]}`;
                const monthName = getMonthName(parseInt(parts[1]), parseInt(parts[2]));
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        name: monthName,
                        total: 0,
                        factures: 0,
                        nonFactures: 0,
                        montantTotal: 0,
                        montantFacture: 0,
                        montantNonFacture: 0
                    };
                }
                
                monthlyData[monthYear].total++;
                const montant = parseFloat(acte['Prix_Unitaire_Coefficient_Quantit√©']) || 0;
                monthlyData[monthYear].montantTotal += montant;
                
                if (acte['Factur√©'] === 'Oui') {
                    monthlyData[monthYear].factures++;
                    monthlyData[monthYear].montantFacture += montant;
                } else {
                    monthlyData[monthYear].nonFactures++;
                    monthlyData[monthYear].montantNonFacture += montant;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });
            
            const exportData = sortedMonths.map(monthKey => {
                const data = monthlyData[monthKey];
                const tauxFacturation = data.total > 0 ? ((data.factures / data.total * 100).toFixed(1) + '%') : '0%';
                
                return {
                    'Mois': data.name,
                    'Total Actes': data.total,
                    'Actes Factur√©s': data.factures,
                    'Actes Non Factur√©s': data.nonFactures,
                    'Taux de Facturation': tauxFacturation,
                    'Montant Total (‚Ç¨)': data.montantTotal.toFixed(2),
                    'Montant Factur√© (‚Ç¨)': data.montantFacture.toFixed(2),
                    'Montant Non Factur√© (‚Ç¨)': data.montantNonFacture.toFixed(2)
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'R√©capitulatif Mensuel');
            
            const today = new Date();
            const filename = `Recapitulatif_Mensuel_${today.getFullYear()}_${String(today.getMonth() + 1).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
        
        function displayTable(type, data) {
            const table = document.getElementById(`table-${type}`);
            
            if (data.length === 0) {
                table.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Aucune donn√©e √† afficher</p>';
                return;
            }
            
            let html = '<thead><tr>';
            html += '<th>Date</th>';
            html += '<th>Nom Patient</th>';
            html += '<th>N¬∞ Dossier</th>';
            html += '<th>Prestation</th>';
            html += '<th>Montant</th>';
            html += '<th>Statut</th>';
            html += '<th>D√©tails</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                const statusClass = row['Factur√©'] === 'Oui' ? 'status-factured' : 'status-not-factured';
                const statusText = row['Factur√©'] === 'Oui' ? '‚úì Factur√©' : '‚úó Non factur√©';
                
                html += '<tr>';
                html += `<td>${row['Date_Formatt√©e'] || ''}</td>`;
                html += `<td>${row['Nom_Complet'] || ''}</td>`;
                html += `<td>${row['Num√©ro de dossier'] || ''}</td>`;
                html += `<td>${row['Prestation'] || ''}</td>`;
                html += `<td>${(row['Prix_Unitaire_Coefficient_Quantit√©'] || 0).toFixed(2)}‚Ç¨</td>`;
                html += `<td><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                html += `<td>${row['D√©tails_Facture'] || ''}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function exportToExcel(type) {
            let data, filename;
            
            switch(type) {
                case 'non-factures':
                    data = reconciledData.filter(a => a['Factur√©'] === 'Non');
                    filename = 'actes_non_factures.xlsx';
                    break;
                case 'factures':
                    data = reconciledData.filter(a => a['Factur√©'] === 'Oui');
                    filename = 'actes_factures.xlsx';
                    break;
                default:
                    data = reconciledData;
                    filename = 'tous_les_actes.xlsx';
            }
            
            const exportData = data.map(row => ({
                'Date': row['Date_Formatt√©e'],
                'Nom Patient': row['Nom_Complet'],
                'Num√©ro de Dossier': row['Num√©ro de dossier'],
                'Prestation': row['Prestation'],
                'Montant (‚Ç¨)': row['Prix_Unitaire_Coefficient_Quantit√©'],
                'Statut': row['Factur√©'],
                'D√©tails Facture': row['D√©tails_Facture']
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Actes');
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>
