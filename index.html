<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√©conciliation des Actes M√©dicaux - Dr Pablo NEEL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* ‚Äî‚Äî‚Äî Base ‚Äî‚Äî‚Äî */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:20px;min-height:100vh}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2em;margin-bottom:8px}
    .content{padding:30px}

    /* ‚Äî‚Äî‚Äî Upload ‚Äî‚Äî‚Äî */
    .upload-section{background:#f8f9fa;border-radius:12px;padding:24px;margin-bottom:24px}
    .upload-section h2{color:#667eea;margin-bottom:14px}
    .file-input-group{margin-bottom:16px}
    .file-input-group label{display:block;font-weight:700;margin-bottom:8px}
    .file-input-wrapper{position:relative;display:inline-block;width:100%}
    .file-input-wrapper input[type=file]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
    .file-input-button{display:block;padding:12px 18px;border:2px dashed #667eea;border-radius:10px;background:#fff;color:#667eea;font-weight:700;text-align:center;cursor:pointer;transition:.25s}
    .file-input-button:hover{background:#667eea;color:#fff}
    .files-list{margin-top:10px}
    .file-item{display:flex;align-items:center;justify-content:space-between;background:#e8eaf6;border-radius:8px;padding:8px 12px;margin-bottom:8px}
    .file-name{font-weight:600;color:#5e35b1}
    .file-size{font-size:.85em;color:#666}
    .remove-file-btn{background:#f44336;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .action-buttons{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
    .btn{padding:12px 20px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#6c757d;color:#fff}

    /* ‚Äî‚Äî‚Äî Cards / inputs ‚Äî‚Äî‚Äî */
    .card{background:#fff;border:1px solid #ececec;border-radius:12px;padding:18px;margin:20px 0}
    .label{font-weight:700;margin-bottom:6px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .input{width:100%;padding:10px;border:1px solid #d0d5dd;border-radius:8px}

    /* ‚Äî‚Äî‚Äî Tabs & tables ‚Äî‚Äî‚Äî */
    .results-section{margin-top:24px;display:none}
    .results-section.show{display:block}
    .tab-buttons{display:flex;gap:10px;border-bottom:2px solid #ececec;margin-bottom:14px;flex-wrap:wrap}
    .tab-btn{padding:12px 18px;background:transparent;border:none;border-bottom:3px solid transparent;font-weight:700;color:#666;cursor:pointer}
    .tab-btn.active{color:#667eea;border-bottom-color:#667eea}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{position:sticky;top:0;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;text-align:left;padding:14px}
    td{padding:12px 14px;border-bottom:1px solid #eee}
    tr:hover{background:#fafafa}
    .status-badge{padding:4px 10px;border-radius:14px;font-size:.85em;font-weight:700}
    .status-factured{background:#d4edda;color:#155724}
    .status-not-factured{background:#f8d7da;color:#721c24}

    /* ‚Äî‚Äî‚Äî Stats ‚Äî‚Äî‚Äî */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:18px 0}
    .stat-card{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border-radius:12px;padding:18px;text-align:center}
    .stat-card.success{background:linear-gradient(135deg,#11998e 0,#38ef7d 100%)}
    .stat-card.warning{background:linear-gradient(135deg,#f093fb 0,#f5576c 100%)}
    .stat-value{font-size:2.1em;font-weight:800}

    /* ‚Äî‚Äî‚Äî Loading ‚Äî‚Äî‚Äî */
    .loading{display:none;text-align:center;padding:20px}
    .loading.show{display:block}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• R√©conciliation des Actes M√©dicaux</h1>
      <p>Suivi des actes factur√©s et non factur√©s ‚Äî Ajoutez vos fichiers mensuels progressivement</p>
    </div>

    <div class="content">
      <!-- Upload -->
      <div class="upload-section">
        <h2>üìÅ Chargement des fichiers</h2>
        <p style="color:#666;margin-bottom:16px">üí° Astuce : vous pouvez ajouter plusieurs fichiers progressivement puis lancer l‚Äôanalyse.</p>

        <div class="file-input-group">
          <label>Fichiers des actes r√©alis√©s (Excel)</label>
          <div class="file-input-wrapper">
            <input type="file" id="actesFile" accept=".xlsx,.xls" multiple style="display:none">
            <button class="file-input-button" onclick="document.getElementById('actesFile').click()">üìä Ajouter un fichier Excel des actes</button>
          </div>
          <div id="actesFilesList" class="files-list"></div>
        </div>

        <div class="file-input-group">
          <label>Fichiers des honoraires factur√©s (CSV)</label>
          <div class="file-input-wrapper">
            <input type="file" id="honorairesFiles" accept=".csv" multiple style="display:none">
            <button class="file-input-button" onclick="document.getElementById('honorairesFiles').click()">üí∞ Ajouter des fichiers CSV des honoraires</button>
          </div>
          <div id="honorairesFilesList" class="files-list"></div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="analyzeBtn" disabled>üîç Analyser et r√©concilier</button>
          <button class="btn btn-secondary" id="resetBtn">üîÑ R√©initialiser</button>
        </div>
      </div>

      <!-- Saisie manuelle quotidienne -->
      <div class="card">
        <h2>‚úçÔ∏è Saisie manuelle quotidienne</h2>
        <p style="color:#666;margin:6px 0 10px">Renseignez chaque jour le nombre d‚Äôactes pour comparer avec les fichiers import√©s.</p>
        <div class="grid">
          <div>
            <div class="label">Date</div>
            <input type="date" id="manualDate" class="input">
          </div>
          <div>
            <div class="label">Nombre d'actes</div>
            <input type="number" id="manualCount" class="input" min="0" step="1" placeholder="0">
          </div>
          <div style="align-self:end">
            <button class="btn btn-primary" id="btnAddManual">‚ûï Ajouter / Mettre √† jour</button>
          </div>
        </div>
        <div class="table-wrapper" style="margin-top:12px">
          <table id="manual-table"></table>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyse en cours‚Ä¶</p>
      </div>

      <!-- R√©sultats -->
      <div class="results-section" id="results">
        <div class="stats" id="stats"></div>

        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="recap">üìä R√©capitulatif Mensuel</button>
          <button class="tab-btn" data-tab="non-factures">‚ùå Actes non factur√©s</button>
          <button class="tab-btn" data-tab="factures">‚úÖ Actes factur√©s</button>
          <button class="tab-btn" data-tab="tous">üìã Tous les actes</button>
          <button class="tab-btn" data-tab="comparaison">üìà Comparaison quotidienne</button>
        </div>

        <div class="tab-content active" id="tab-recap">
          <div id="monthly-summary"></div>
          <div class="table-wrapper" style="margin-top:16px"><table id="table-monthly"></table></div>
        </div>

        <div class="tab-content" id="tab-non-factures">
          <div class="table-wrapper"><table id="table-non-factures"></table></div>
        </div>

        <div class="tab-content" id="tab-factures">
          <div class="table-wrapper"><table id="table-factures"></table></div>
        </div>

        <div class="tab-content" id="tab-tous">
          <div class="table-wrapper"><table id="table-tous"></table></div>
        </div>

        <div class="tab-content" id="tab-comparaison">
          <div class="table-wrapper"><table id="table-comparaison"></table></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== √âTAT ===== */
    let actesFiles=[], honorairesFiles=[];
    let actesData=[], honorairesData=[], reconciledData=[];
    let manualEntries = JSON.parse(localStorage.getItem('manualEntries_v1')||'[]'); // [{date:'YYYY-MM-DD', count:n}]

    /* ===== Utils ===== */
    const fmtSize=b=>{if(b===0)return'0 B';const k=1024,s=['B','KB','MB','GB'];const i=Math.floor(Math.log(b)/Math.log(k));return Math.round(b/Math.pow(k,i)*100)/100+' '+s[i]};
    const parseFr=v=>{if(v==null)return 0;if(typeof v==='number')return v;const s=String(v).replace(/\s/g,'');return parseFloat(s.replace(/\./g,'').replace(/,/g,'.'))||0};
    const normStr=s=>(s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s'-]/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
    const normDos=d=>(d||'').toString().replace(/\D/g,'').replace(/^0+/,'');
    const toMoney=n=>(+n||0).toFixed(2)+'‚Ç¨';
    function excelDateToJSDate(serial){
      if(serial instanceof Date) return new Date(serial.getFullYear(),serial.getMonth(),serial.getDate());
      if(typeof serial==='string'){
        const m1=serial.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m1) return new Date(+m1[3],+m1[2]-1,+m1[1]);
        const m2=serial.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m2) return new Date(+m2[1],+m2[2]-1,+m2[3]);
        const d=new Date(serial); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
      }
      const utcDays=Math.floor(serial-25569), utcValue=utcDays*86400, d=new Date(utcValue*1000);
      return new Date(d.getFullYear(),d.getMonth(),d.getDate());
    }
    const frDate=d=>{if(!d)return'';const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yy=d.getFullYear();return `${dd}/${mm}/${yy}`};
    const ymdToFr=ymd=>{const m=ymd&&ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/);return m?`${m[3]}/${m[2]}/${m[1]}`:''};
    const monthName=(m,y)=>['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][m-1]+' '+y;

    /* ===== UI Fichiers ===== */
    document.getElementById('actesFile').addEventListener('change',e=>{
      [...e.target.files].forEach(f=>{if(!actesFiles.find(x=>x.name===f.name&&x.size===f.size)) actesFiles.push(f)});
      updateFilesList('actes'); checkReady(); e.target.value='';
    });
    document.getElementById('honorairesFiles').addEventListener('change',e=>{
      [...e.target.files].forEach(f=>{if(!honorairesFiles.find(x=>x.name===f.name&&x.size===f.size)) honorairesFiles.push(f)});
      updateFilesList('honoraires'); checkReady(); e.target.value='';
    });
    function updateFilesList(type){
      const files=type==='actes'?actesFiles:honorairesFiles, list=document.getElementById(type==='actes'?'actesFilesList':'honorairesFilesList');
      list.innerHTML=files.map((f,i)=>`<div class="file-item"><div><div class="file-name">${f.name}</div><div class="file-size">${fmtSize(f.size)}</div></div><button class="remove-file-btn" onclick="removeFile('${type}',${i})">‚úï Supprimer</button></div>`).join('');
    }
    function removeFile(type,i){(type==='actes'?actesFiles:honorairesFiles).splice(i,1);updateFilesList(type);checkReady();}
    function checkReady(){document.getElementById('analyzeBtn').disabled=!(actesFiles.length&&honorairesFiles.length);}

    document.getElementById('analyzeBtn').addEventListener('click',analyzeFiles);
    document.getElementById('resetBtn').addEventListener('click',()=>{
      actesFiles=[];honorairesFiles=[];actesData=[];honorairesData=[];reconciledData=[];
      updateFilesList('actes');updateFilesList('honoraires');checkReady();
      document.getElementById('results').classList.remove('show');
    });

    // Onglets
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',function(){
        const tab=this.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        this.classList.add('active'); document.getElementById(`tab-${tab}`).classList.add('active');
      });
    });

    /* ===== Saisie manuelle ===== */
    function renderManualTable(){
      const t=document.getElementById('manual-table');
      if(!manualEntries.length){
        t.innerHTML='<thead><tr><th>Date</th><th>Nombre</th><th></th></tr></thead><tbody><tr><td colspan="3" style="color:#666;padding:12px">Aucune saisie</td></tr></tbody>';
        return;
      }
      const rows=[...manualEntries].sort((a,b)=>a.date.localeCompare(b.date));
      let h='<thead><tr><th>Date</th><th>Nombre</th><th>Action</th></tr></thead><tbody>';
      rows.forEach(e=>h+=`<tr><td>${e.date}</td><td>${e.count}</td><td><button class="remove-file-btn" onclick="delManual('${e.date}')">Supprimer</button></td></tr>`);
      t.innerHTML=h+'</tbody>';
    }
    document.getElementById('btnAddManual').addEventListener('click',()=>{
      const d=document.getElementById('manualDate').value, c=+document.getElementById('manualCount').value||0;
      if(!d) return alert('Choisis une date'); if(c<0) return alert('Le nombre doit √™tre ‚â• 0');
      const i=manualEntries.findIndex(x=>x.date===d);
      if(i>-1) manualEntries[i].count=c; else manualEntries.push({date:d,count:c});
      localStorage.setItem('manualEntries_v1',JSON.stringify(manualEntries));
      renderManualTable(); renderComparaison(); renderMonthly();
    });
    window.delManual=(d)=>{
      manualEntries = manualEntries.filter(x=>x.date!==d);
      localStorage.setItem('manualEntries_v1',JSON.stringify(manualEntries));
      renderManualTable(); renderComparaison(); renderMonthly();
    };

    /* ===== Lecture fichiers ===== */
    async function analyzeFiles(){
      document.getElementById('loading').classList.add('show');
      document.getElementById('results').classList.remove('show');
      try{
        // actes Excel
        actesData=[]; for(const f of actesFiles){ actesData = actesData.concat(await readExcel(f)); }
        // honoraires CSV
        honorairesData=[]; for(const f of honorairesFiles){ honorairesData = honorairesData.concat(await readCSV(f)); }
        // reconcile + affichage
        reconcile(); displayResults();
        document.getElementById('loading').classList.remove('show');
        document.getElementById('results').classList.add('show');
      }catch(err){
        console.error(err); alert("Erreur lors de l'analyse des fichiers : "+err.message);
        document.getElementById('loading').classList.remove('show');
      }
    }
    function readExcel(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=e=>{
          try{
            const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
            const sh=wb.Sheets[wb.SheetNames[0]];
            const rows=XLSX.utils.sheet_to_json(sh,{header:1});
            let header=-1;
            for(let i=0;i<rows.length;i++){
              if(rows[i].some(c=>String(c||'').toLowerCase().includes('num√©ro de dossier'))){header=i;break;}
            }
            if(header===-1) return reject(new Error("En-t√™te non trouv√© dans l'Excel"));
            const headers=rows[header], data=rows.slice(header+1);
            const out=data.map(r=>{const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o;})
                          .filter(o=>o['Nom']&&o['Num√©ro de dossier']);
            resolve(out);
          }catch(err){reject(err);}
        };
        r.onerror=reject; r.readAsArrayBuffer(file);
      });
    }
    function readCSV(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{
          encoding:'ISO-8859-1', delimiter:';', skipEmptyLines:true,
          complete:(res)=>{
            try{
              if(res.data.length<7) return reject(new Error('CSV trop court'));
              const headers=['Praticien','Dossier','Patient','Libell√©','Transfert','Date Acte','Serv.','Coeff.','Pertes','Mt Hors D√©pass.','D√©pass.','Total','Vide'];
              const data=res.data.slice(6);
              const out=data.map(row=>{
                if(!row||row.length<6) return null;
                const o={}; headers.forEach((h,i)=>o[h]=(row[i]?row[i].replace(/"/g,'').trim():''));
                o['Date Acte']=normalizeDate(o['Date Acte']);
                o['Total']=parseFr(o['Total']);
                o['Dossier']=normDos(o['Dossier']);
                o['Patient_norm']=normStr(o['Patient']);
                return o;
              }).filter(o=>o&&o['Dossier']&&o['Date Acte']);
              resolve(out);
            }catch(err){reject(err);}
          },
          error:reject
        });
      });
    }
    function normalizeDate(s){
      if(!s) return '';
      const t=String(s).trim();
      const m1=t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m1) return t;
      const m2=t.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m2) return `${m2[3]}/${m2[2]}/${m2[1]}`;
      const d=new Date(t); return isNaN(d)?'':frDate(d);
    }

    /* ===== R√©conciliation ===== */
    function reconcile(){
      const idx=new Map();
      for(const h of honorairesData){
        idx.set(`${h['Dossier']}|${h['Patient_norm']}|${h['Date Acte']}`,h);
      }
      reconciledData = actesData.map(a=>{
        const dossier=normDos(a['Num√©ro de dossier']||a['Num√©ro de Dossier']||'');
        const nom=normStr(a['Nom']||''), prenom=normStr(a['Pr√©nom']||a['Prenom']||'');
        const patientNorm=normStr(`${nom} ${prenom}`.trim());
        const date=frDate(excelDateToJSDate(a['Date de d√©but']||a['Date']));
        const montant=parseFr(a['Prix_Unitaire_Coefficient_Quantit√©']||a['Montant']||a['Tarif']);
        const match=idx.get(`${dossier}|${patientNorm}|${date}`);
        return {
          _DOSSIER_NORM:dossier,
          Nom_Complet:`${nom} ${prenom}`.trim(),
          Date_Formatee:date, Date_Formatt√©e:date, // 2 cl√©s pour compat
          Prestation:a['Prestation']||a['Acte']||'',
          Montant_num:+montant||0,
          Factur√©:match?'Oui':'Non',
          D√©tails_Facture:match?(match['Libell√©']||''):''
        };
      });
    }

    /* ===== Affichages ===== */
    function displayResults(){
      const total=reconciledData.length;
      const fact=reconciledData.filter(a=>a.Factur√©==='Oui').length;
      const nonf=total-fact;
      const nonfE=reconciledData.filter(a=>a.Factur√©!=='Oui').reduce((s,a)=>s+(a.Montant_num||0),0);

      document.getElementById('stats').innerHTML =
        `<div class="stat-card"><div class="stat-value">${total}</div><div>Total actes</div></div>
         <div class="stat-card success"><div class="stat-value">${fact}</div><div>Actes factur√©s</div></div>
         <div class="stat-card warning"><div class="stat-value">${nonf}</div><div>Actes non factur√©s</div></div>
         <div class="stat-card warning"><div class="stat-value">${toMoney(nonfE)}</div><div>Montant non factur√©</div></div>`;

      renderTable('non-factures', reconciledData.filter(a=>a.Factur√©!=='Oui'));
      renderTable('factures', reconciledData.filter(a=>a.Factur√©==='Oui'));
      renderTable('tous', reconciledData);
      renderMonthly();
      renderComparaison();
    }

    function renderTable(id, data){
      const t=document.getElementById(`table-${id}`);
      if(!data.length){ t.innerHTML='<p style="padding:16px;text-align:center;color:#666">Aucune donn√©e</p>'; return; }
      let h='<thead><tr><th>Date</th><th>Nom Patient</th><th>N¬∞ Dossier</th><th>Prestation</th><th>Montant</th><th>Statut</th><th>D√©tails</th></tr></thead><tbody>';
      data.forEach(r=>{
        const ok=r.Factur√©==='Oui';
        h+=`<tr>
          <td>${r.Date_Formatee||''}</td>
          <td>${r.Nom_Complet||''}</td>
          <td>${r._DOSSIER_NORM||''}</td>
          <td>${r.Prestation||''}</td>
          <td>${toMoney(r.Montant_num)}</td>
          <td><span class="status-badge ${ok?'status-factured':'status-not-factured'}">${ok?'‚úì Factur√©':'‚úó Non factur√©'}</span></td>
          <td>${r.D√©tails_Facture||''}</td>
        </tr>`;
      });
      t.innerHTML=h+'</tbody>';
    }

    function renderMonthly(){
      const M={};
      for(const a of reconciledData){
        const d=a.Date_Formatee; if(!d) continue;
        const [jj,mm,yy]=d.split('/'), key=`${mm}/${yy}`;
        if(!M[key]) M[key]={name:monthName(+mm,+yy),t:0,f:0,n:0,te:0,fe:0,ne:0};
        const m=a.Montant_num||0; M[key].t++; M[key].te+=m; if(a.Factur√©==='Oui'){M[key].f++; M[key].fe+=m;} else {M[key].n++; M[key].ne+=m;}
      }
      const keys=Object.keys(M).sort((a,b)=>{const [ma,ya]=a.split('/').map(Number),[mb,yb]=b.split('/').map(Number); return ya!==yb?ya-yb:ma-mb;});
      let h='<thead><tr><th>Mois</th><th>Total</th><th>Factur√©s</th><th>Non factur√©s</th><th>Taux</th><th>Montant total</th><th>Montant factur√©</th><th>Montant non factur√©</th></tr></thead><tbody>';
      let T={t:0,f:0,n:0,te:0,fe:0,ne:0};
      keys.forEach(k=>{
        const d=M[k], taux=d.t? (d.f/d.t*100).toFixed(1):0;
        h+=`<tr><td><strong>${d.name}</strong></td><td>${d.t}</td><td style="color:#28a745">${d.f}</td><td style="color:#e74c3c">${d.n}</td><td><strong>${taux}%</strong></td><td>${toMoney(d.te)}</td><td style="color:#28a745">${toMoney(d.fe)}</td><td style="color:#e74c3c">${toMoney(d.ne)}</td></tr>`;
        T.t+=d.t;T.f+=d.f;T.n+=d.n;T.te+=d.te;T.fe+=d.fe;T.ne+=d.ne;
      });
      if(keys.length>1){
        const tauxG=T.t?(T.f/T.t*100).toFixed(1):0;
        h+=`<tr style="background:#f8f9fa;font-weight:700;border-top:2px solid #667eea"><td>TOTAL</td><td>${T.t}</td><td style="color:#28a745">${T.f}</td><td style="color:#e74c3c">${T.n}</td><td>${tauxG}%</td><td>${toMoney(T.te)}</td><td style="color:#28a745">${toMoney(T.fe)}</td><td style="color:#e74c3c">${toMoney(T.ne)}</td></tr>`;
      }
      document.getElementById('table-monthly').innerHTML=h+'</tbody>';
    }

    /* ===== Comparaison quotidienne ===== */
    function filesCountsByDay(){
      const m=new Map();
      for(const a of (reconciledData||[])){
        const d=a.Date_Formatee||a.Date_Formatt√©e; if(!d) continue;
        m.set(d,(m.get(d)||0)+1);
      }
      return m;
    }
    function buildDailyRows(){
      const fic=filesCountsByDay(), man=new Map();
      for(const e of (manualEntries||[])){
        const d=ymdToFr(e.date); if(!d) continue;
        man.set(d,(man.get(d)||0)+(+e.count||0));
      }
      const all=new Set([...fic.keys(),...man.keys()]);
      const sorted=[...all].sort((A,B)=>{
        const [ad,am,ay]=A.split('/').map(Number),[bd,bm,by]=B.split('/').map(Number);
        return new Date(ay,am-1,ad)-new Date(by,bm-1,bd);
      });
      return sorted.map(date=>({date,manuel:(man.get(date)||0),importe:(fic.get(date)||0),delta:(man.get(date)||0)-(fic.get(date)||0)}));
    }
    function renderComparaison(){
      const t=document.getElementById('table-comparaison'); if(!t) return;
      const rows=buildDailyRows();
      if(!rows.length){ t.innerHTML='<p style="padding:16px;text-align:center;color:#666">Aucune donn√©e</p>'; return; }
      let h='<thead><tr><th>Date</th><th>Manuel</th><th>Import√© (actes)</th><th>Œî (Manuel - Import√©)</th></tr></thead><tbody>';
      let tm=0,ti=0;
      rows.forEach(r=>{
        tm+=r.manuel; ti+=r.importe;
        const cls=r.delta===0?'':(r.delta>0?'style="color:#2e7d32;font-weight:700"':'style="color:#c62828;font-weight:700"');
        h+=`<tr><td>${r.date}</td><td>${r.manuel}</td><td>${r.importe}</td><td ${cls}>${r.delta}</td></tr>`;
      });
      const td=tm-ti, cls=td===0?'':(td>0?'style="color:#2e7d32;font-weight:800"':'style="color:#c62828;font-weight:800"');
      h+=`<tr style="background:#f8f9fa;font-weight:700;border-top:2px solid #667eea"><td>TOTAUX</td><td>${tm}</td><td>${ti}</td><td ${cls}>${td}</td></tr>`;
      t.innerHTML=h+'</tbody>';
    }

    /* ===== Ex√©cution initiale ===== */
    renderManualTable();
  </script>
</body>
</html>
